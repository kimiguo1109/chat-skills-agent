<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>StudyX Skill Agent Demo</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <!-- Mind Elixir for Mind Map Rendering (IIFE version - works without module bundler) -->
    <link rel="stylesheet" href="/node_modules/mind-elixir/dist/MindElixir.css">
    <script src="/node_modules/mind-elixir/dist/MindElixir.iife.js"></script>
    <!-- ğŸ†• KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#137fec",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
              "surface-light": "#ffffff",
              "surface-dark": "#1a2632",
              "text-light-primary": "#0d141b",
              "text-dark-primary": "#f6f7f8",
              "text-light-secondary": "#4c739a",
              "text-dark-secondary": "#a0b3c7",
              "border-light": "#e7edf3",
              "border-dark": "#2a3b4d"
            },
            fontFamily: {
              "display": ["Space Grotesk", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
        body {
            font-family: 'Space Grotesk', sans-serif;
        }
        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-4px); }
        }
        
        /* ============= Learning History Panel ============= */
        
        /* Overlay */
        .history-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
        
        .history-overlay.active {
          opacity: 1;
          pointer-events: auto;
        }
        
        /* History Panel */
        .history-panel {
          position: fixed;
          top: 0;
          right: 0;
          width: 400px;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          z-index: 1000;
          transform: translateX(100%);
          transition: transform 0.3s ease;
          display: flex;
          flex-direction: column;
          box-shadow: -4px 0 16px rgba(0, 0, 0, 0.2);
        }
        
        .history-panel.open {
          transform: translateX(0);
        }
        
        .history-panel-content {
          display: flex;
          flex-direction: column;
          height: 100%;
          overflow: hidden;
        }
        
        /* Header */
        .history-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 24px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
          color: white;
        }
        
        .close-btn {
          background: transparent;
          border: none;
          color: white;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: background 0.2s;
        }
        
        .close-btn:hover {
          background: rgba(255, 255, 255, 0.2);
        }
        
        /* Search & Filter */
        .history-search {
          padding: 16px 20px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .search-input {
          width: 100%;
          padding: 10px 12px;
          border: none;
          border-radius: 8px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          font-size: 14px;
          transition: background 0.2s;
        }
        
        .search-input:focus {
          background: rgba(255, 255, 255, 0.3);
          outline: none;
        }
        
        .search-input::placeholder {
          color: rgba(255, 255, 255, 0.6);
        }
        
        .filter-buttons {
          display: flex;
          gap: 8px;
          margin-top: 12px;
          flex-wrap: wrap;
        }
        
        .filter-btn {
          padding: 6px 12px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 20px;
          background: transparent;
          color: white;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.2s;
        }
        
        .filter-btn:hover {
          background: rgba(255, 255, 255, 0.2);
        }
        
        .filter-btn.active {
          background: white;
          color: #667eea;
          border-color: white;
        }
        
        /* Timeline */
        .history-timeline {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          color: white;
        }
        
        .history-timeline::-webkit-scrollbar {
          width: 6px;
        }
        
        .history-timeline::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
        }
        
        .history-timeline::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.3);
          border-radius: 3px;
        }
        
        .history-timeline::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.5);
        }
        
        /* Loading State */
        .loading-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 40px 20px;
          gap: 8px;
        }
        
        .loading-state > div {
          display: inline-block;
        }
        
        /* Empty State */
        .empty-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          text-align: center;
        }
        
        .empty-state-icon {
          font-size: 64px;
          margin-bottom: 16px;
          opacity: 0.5;
        }
        
        /* Date Group */
        .date-group {
          margin-bottom: 24px;
        }
        
        .date-label {
          font-size: 14px;
          font-weight: 600;
          padding: 8px 0;
          cursor: pointer;
          display: flex;
          align-items: center;
          user-select: none;
        }
        
        .date-group.collapsed .history-items {
          display: none;
        }
        
        .history-items {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        /* History Item */
        .history-item {
          display: flex;
          align-items: flex-start;
          padding: 12px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s;
        }
        
        .history-item:hover {
          background: rgba(255, 255, 255, 0.2);
          transform: translateX(-4px);
        }
        
        .item-icon {
          font-size: 24px;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .item-content {
          flex: 1;
          min-width: 0;
        }
        
        .item-title {
          font-size: 14px;
          font-weight: 500;
          margin-bottom: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .item-meta {
          display: flex;
          gap: 12px;
          font-size: 12px;
          opacity: 0.8;
        }
        
        /* Load More */
        .load-more {
          text-align: center;
          padding: 16px 0;
        }
        
        .load-more button {
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          color: white;
          padding: 8px 24px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.2s;
        }
        
        .load-more button:hover {
          background: rgba(255, 255, 255, 0.3);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
          .history-panel {
            width: 100%;
            max-width: 400px;
          }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light-primary dark:text-text-dark-primary">
<div class="flex h-screen w-full">
<!-- SideNavBar -->
<aside class="flex h-full w-64 flex-col justify-between border-r border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-4">
<div class="flex flex-col gap-6">
<div class="flex items-center gap-3 px-2">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDSpXpUeQFNhzxQIoAIi7RVey3s_Kg0LtNFS9WswZKutC6WUs9vIxo8_6QyNO27m6hlLXEbVG3-PxYyOcktW-sXx6ageG7DxuTTM7j4weDKp7akm6V5MrsGoCm6uuoPFbMEw-bJZwmDc1a7EwsyedARNMzmuie5bknIxwPkHUTQ2BVsAy8itZojKioaFIV05B5hD1Jh3fx9ee34XsTmHjkvSLlBaBzXmj6Ob2zyEe3w1_Okns5xwcEMb9BdwpBYEN4Iz4KcJlfQAI8D");'></div>
<div class="flex flex-col">
<h1 class="text-base font-bold">StudyX</h1>
<p class="text-sm text-text-light-secondary dark:text-text-dark-secondary">Skill Agent Demo</p>
</div>
</div>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors" href="#">
<span class="material-symbols-outlined text-xl">dashboard</span>
<p class="text-sm font-medium">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary" href="#">
<span class="material-symbols-outlined text-xl">calculate</span>
<p class="text-sm font-bold">Learning Session</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors" href="#">
<span class="material-symbols-outlined text-xl">lightbulb</span>
<p class="text-sm font-medium">Concept Explanation</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors" href="#">
<span class="material-symbols-outlined text-xl">functions</span>
<p class="text-sm font-medium">Integration by Parts</p>
</a>
<!-- ğŸ†• Learning History Link -->
<a id="historyToggleBtn" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors cursor-pointer">
<span class="material-symbols-outlined text-xl">history_edu</span>
<p class="text-sm font-medium">Learning History</p>
</a>
</div>
</div>
<div class="flex flex-col gap-4">
<button onclick="handleNewChat()" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold tracking-wide hover:bg-primary/90 transition-colors">
<span class="truncate">New Chat</span>
</button>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors" href="#">
<span class="material-symbols-outlined text-xl">settings</span>
<p class="text-sm font-medium">Settings</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 transition-colors" href="#">
<span class="material-symbols-outlined text-xl">help</span>
<p class="text-sm font-medium">Help</p>
</a>
</div>
</div>
</aside>
<!-- Main Content Area -->
<main class="flex flex-1 flex-col">
<!-- TopNavBar -->
<header class="flex h-16 items-center justify-between whitespace-nowrap border-b border-solid border-border-light dark:border-border-dark px-6 bg-surface-light dark:bg-surface-dark">
<div class="flex items-center gap-4">
<h2 class="text-lg font-bold tracking-tight">AI Learning Assistant</h2>
</div>
<div class="flex flex-1 items-center justify-end gap-4">
<button class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg size-10 bg-primary/10 text-text-light-primary dark:text-text-dark-primary hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined text-xl">notifications</span>
</button>
<button class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg size-10 bg-primary/10 text-text-light-primary dark:text-text-dark-primary hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined text-xl">bolt</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC2JV0TerXdmHAVpbSKv_E1GuCwolwncFI-4GV6gTe4KD7jb6L14FEWUoI9GNNTmFjCICvExlwaH0u-Xlc__WwIhFeFn3tGycB_um-i2WDCBZ8qh8z4mzXJSai0ODWV21ZaxGiyMm-Xot9-QBjSTEmRiy_zgJShKMe01fF7msbIDwkAsrstdzzcpXlnafKBGO39znKCb-jbgC-p4Eakjg_qCdJ4FqHjX2gefcJUbHapvopm943I8lcboavCnjZrtm0h5-VQbnuXjwps");'></div>
</div>
</header>
<!-- Chat Area -->
<div class="flex flex-1 flex-col overflow-y-auto px-6 pt-6" id="chatMessages">
<div class="flex flex-col gap-6">
<!-- Agent Welcome Message -->
<div class="flex items-end gap-3 max-w-2xl">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
<div class="flex flex-1 flex-col gap-1 items-start">
<p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                <p class="text-base font-normal leading-normal rounded-xl rounded-bl-none px-4 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light-primary dark:text-text-dark-primary">
                    å¼€å§‹å’Œ AI å­¦ä¹ åŠ©æ‰‹å¯¹è¯å§ï¼ä½ å¯ä»¥å°è¯•ï¼š
                    <br>â€¢ "ç»™æˆ‘å‡ é“å¾®ç§¯åˆ†ç»ƒä¹ é¢˜"ï¼ˆæ•°å­¦ï¼‰
                    <br>â€¢ "è§£é‡Šä¸€ä¸‹ç‰›é¡¿ç¬¬äºŒå®šå¾‹"ï¼ˆç‰©ç†ï¼‰
                    <br>â€¢ "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"ï¼ˆç”Ÿç‰©ï¼‰
                    <br>â€¢ "å¸®æˆ‘ç†è§£äºŒæˆ˜çš„èµ·å› "ï¼ˆå†å²ï¼‰
                </p>
</div>
</div>
</div>
<div class="flex-grow"></div>
</div>
<!-- Text Input Area -->
<div class="px-6 pb-6 pt-4 bg-background-light dark:bg-background-dark">
<div class="relative">
<input id="messageInput" class="w-full h-12 px-4 pr-12 rounded-lg bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary focus:outline-none transition-shadow text-text-light-primary dark:text-text-dark-primary placeholder-text-light-secondary dark:placeholder-text-dark-secondary" placeholder="Ask a question or type your answer..." type="text" onkeypress="if(event.key==='Enter') handleSend()"/>
<button onclick="handleSend()" class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center size-8 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
<span class="material-symbols-outlined text-xl">send</span>
</button>
</div>
</div>
</main>

<!-- ğŸ†• Learning History Sidebar Panel -->
<div id="historyPanel" class="history-panel">
  <div class="history-panel-content">
    <!-- Header -->
    <div class="history-header">
      <h3 class="text-lg font-bold">ğŸ“š Learning History</h3>
      <button id="historyCloseBtn" class="close-btn">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    
    <!-- Search & Filter -->
    <div class="history-search">
      <input 
        type="text" 
        id="historySearch" 
        placeholder="ğŸ” Search topics..."
        class="search-input"
      />
      
      <div class="filter-buttons">
        <button class="filter-btn active" data-type="all">All</button>
        <button class="filter-btn" data-type="quiz_set">â“</button>
        <button class="filter-btn" data-type="flashcard_set">ğŸ´</button>
        <button class="filter-btn" data-type="notes">ğŸ“</button>
        <button class="filter-btn" data-type="explanation">ğŸ’¡</button>
        <button class="filter-btn" data-type="mindmap">ğŸ—ºï¸</button>
      </div>
    </div>
    
    <!-- Timeline Content -->
    <div id="historyTimeline" class="history-timeline">
      <div class="loading-state">
        <div class="w-2 h-2 rounded-full bg-primary animate-bounce"></div>
        <div class="w-2 h-2 rounded-full bg-primary animate-bounce" style="animation-delay: 0.1s"></div>
        <div class="w-2 h-2 rounded-full bg-primary animate-bounce" style="animation-delay: 0.2s"></div>
        <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary mt-2">Loading history...</p>
      </div>
    </div>
  </div>
</div>

<!-- Overlay for history panel -->
<div id="historyOverlay" class="history-overlay"></div>

</div>

<script>
// API é…ç½®
const API_BASE = 'http://localhost:8000';
const USER_ID = 'demo-user';
const SESSION_ID = 'demo-session';

// å‘é€æ¶ˆæ¯
// ğŸŒŠ æµå¼ç”Ÿæˆæ ‡å¿—ï¼ˆå¯åˆ‡æ¢ï¼‰
const USE_STREAMING = true;  // è®¾ä¸ºfalseä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼

async function handleSend() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    console.log('ğŸ“¤ Sending message:', message);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addUserMessage(message);
    
    if (USE_STREAMING) {
        // ğŸŒŠ ä½¿ç”¨æµå¼API
        await handleStreamingResponse(message);
    } else {
        // ä¼ ç»Ÿæ¨¡å¼
        await handleTraditionalResponse(message);
    }
}

// ğŸŒŠ æµå¼å“åº”å¤„ç†
async function handleStreamingResponse(message) {
    // ç§»é™¤æ—§çš„åŠ è½½æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
    removeLoadingMessage();
    
    // åˆ›å»ºæµå¼å“åº”å®¹å™¨
    const responseId = `response-${Date.now()}`;
    createStreamingResponseContainer(responseId);
    
    try {
        const response = await fetch(`${API_BASE}/api/agent/chat-stream`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: USER_ID,
                session_id: SESSION_ID,
                message: message
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const {done, value} = await reader.read();
            
            if (done) break;
            
            buffer += decoder.decode(value, {stream: true});
            
            // å¤„ç†å¤šä¸ªäº‹ä»¶
            const events = buffer.split('\n\n');
            buffer = events.pop(); // ä¿ç•™æœªå®Œæˆçš„éƒ¨åˆ†
            
            for (const event of events) {
                if (event.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(event.substring(6));
                        handleStreamChunk(responseId, data);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('âŒ Stream error:', error);
        updateStreamError(responseId, error.message);
    }
}

// ğŸ“¦ ä¼ ç»Ÿå“åº”å¤„ç†ï¼ˆä¿ç•™ï¼‰
async function handleTraditionalResponse(message) {
    addLoadingMessage();
    
    try {
        const response = await fetch(`${API_BASE}/api/agent/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: USER_ID,
                session_id: SESSION_ID,
                message: message
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Response data:', data);
        
        removeLoadingMessage();
        addAgentMessage(data);
        
    } catch (error) {
        console.error('âŒ Error:', error);
        removeLoadingMessage();
        addErrorMessage(`è¿æ¥å¤±è´¥: ${error.message}`);
    }
}

// æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
function addUserMessage(text) {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    const userMsg = `
        <div class="flex items-end gap-3 justify-end max-w-2xl self-end">
            <div class="flex flex-1 flex-col gap-1 items-end">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium text-right">User</p>
                <p class="text-base font-normal leading-normal rounded-xl rounded-br-none px-4 py-3 bg-primary text-white">
                    ${text}
                </p>
            </div>
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuArOSw_thOdEPdwA2mvCtr7bEwI1o26yboOOAitTWIHYDPmbnNwTq9qItlBoeGCOr1aJjqMhNBQ6lKQ0-FywpKbLhS4HDngJqzdL16mCaOdDxYNZH0_JjfcAVaUUnkUUssz6tNH7d5-jAxm5SCFvP45wXOq1X3Pwznad2FF4YUy9U54XVc4pKeL7dCeWLUku3EEI8Ji5Xlx2TiG0YH8wH2sZucsahOVDTSIK3tjmHeMyEK779v0aYEOc-BEPveggYSTocakuyeLTCgr");'></div>
        </div>
    `;
    messagesDiv.insertAdjacentHTML('beforeend', userMsg);
    scrollToBottom();
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸŒŠ æµå¼å“åº”UIå‡½æ•°
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function createStreamingResponseContainer(responseId) {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    const streamingContainer = `
        <div class="flex items-start gap-3 w-full" id="${responseId}">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start w-full max-w-4xl">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                
                <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="${responseId}-status" class="flex items-center gap-2 text-sm text-text-light-secondary dark:text-text-dark-secondary mb-2">
                    <div class="w-2 h-2 rounded-full bg-primary animate-bounce"></div>
                    <span>æ­£åœ¨æ€è€ƒ...</span>
                </div>
                
                <!-- ğŸ†• ç»Ÿä¸€å†…å®¹åŒºåŸŸï¼šæ€è€ƒè¿‡ç¨‹ + æœ€ç»ˆç»“æœè¿ç»­æ˜¾ç¤º -->
                <div class="w-full rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark overflow-hidden">
                    <!-- æ€è€ƒè¿‡ç¨‹åŒºåŸŸï¼ˆæµå¼è¿½åŠ ï¼Œç°è‰²èƒŒæ™¯çªå‡ºæ˜¾ç¤ºï¼‰ -->
                    <div id="${responseId}-thinking-section" class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 border-b border-border-light dark:border-border-dark hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <span class="text-sm font-semibold text-text-light-primary dark:text-text-dark-primary">æ€è€ƒè¿‡ç¨‹</span>
                        </div>
                        <pre id="${responseId}-thinking-content" class="whitespace-pre-wrap text-sm text-text-light-secondary dark:text-text-dark-secondary leading-relaxed"></pre>
                    </div>
                    
                    <!-- ğŸ†• Contentæµå¼æ˜¾ç¤ºåŒºåŸŸï¼ˆJSONåŸå§‹æ–‡æœ¬ï¼Œæ‰“å­—æœºæ•ˆæœï¼‰ -->
                    <div id="${responseId}-content-section" class="px-6 py-4 border-b border-border-light dark:border-border-dark hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="text-sm font-semibold text-green-700 dark:text-green-400">æ­£åœ¨ç¼–å†™å®Œæ•´çš„JSON...</span>
                        </div>
                        <pre id="${responseId}-content-text" class="whitespace-pre-wrap text-xs font-mono text-text-light-primary dark:text-text-dark-primary bg-gray-50 dark:bg-gray-800 p-3 rounded leading-relaxed overflow-x-auto"></pre>
                    </div>
                    
                    <!-- æœ€ç»ˆç»“æœåŒºåŸŸï¼ˆæ ¼å¼åŒ–çš„å¡ç‰‡UIï¼‰ -->
                    <div id="${responseId}-final" class="hidden"></div>
                </div>
            </div>
        </div>
    `;
    messagesDiv.insertAdjacentHTML('beforeend', streamingContainer);
    scrollToBottom();
}

function handleStreamChunk(responseId, data) {
    console.log('[Stream]', data.type, data);
    
    const statusEl = document.getElementById(`${responseId}-status`);
    const thinkingSection = document.getElementById(`${responseId}-thinking-section`);
    const thinkingEl = document.getElementById(`${responseId}-thinking-content`);
    const contentSection = document.getElementById(`${responseId}-content-section`);
    const contentTextEl = document.getElementById(`${responseId}-content-text`);
    const finalEl = document.getElementById(`${responseId}-final`);
    
    if (data.type === 'status') {
        if (statusEl) {
            statusEl.querySelector('span').textContent = data.message;
        }
    }
    // ğŸ†• Plan Skillè¿›åº¦äº‹ä»¶
    else if (data.type === 'plan_start') {
        if (statusEl) {
            statusEl.querySelector('span').textContent = `ğŸ“ ç”Ÿæˆå­¦ä¹ åŒ…ï¼š${data.topic} (${data.total_steps}ä¸ªæ­¥éª¤)`;
        }
        
        // ğŸ†• æ¸²æŸ“Plan Previewå¡ç‰‡
        if (data.steps_preview && data.steps_preview.length > 0 && finalEl) {
            const previewHtml = renderPlanPreview(data.topic, data.steps_preview, data.total_steps);
            finalEl.innerHTML = previewHtml;
            finalEl.classList.remove('hidden'); // ğŸ”§ æ˜¾ç¤ºé¢„è§ˆå¡ç‰‡ï¼
            scrollToBottom();
        }
    }
    else if (data.type === 'step_start') {
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå½“å‰æ­¥éª¤
        if (statusEl) {
            statusEl.querySelector('span').textContent = `ğŸ“ Step ${data.step_order}/${data.total_steps}: ${data.step_name}`;
        }
        
        // ğŸ†• æ›´æ–°Plan Previewä¸­çš„è¿›åº¦æŒ‡ç¤ºå™¨
        const stepIndicator = document.getElementById(`plan-step-${data.step_order}`);
        if (stepIndicator) {
            // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„activeçŠ¶æ€
            document.querySelectorAll('.plan-step-item').forEach(el => {
                el.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
                el.classList.add('border-border-light', 'dark:border-border-dark');
            });
            
            // æ ‡è®°å½“å‰æ­¥éª¤ä¸ºè¿›è¡Œä¸­
            stepIndicator.classList.remove('border-border-light', 'dark:border-border-dark');
            stepIndicator.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€å›¾æ ‡
            const statusIcon = stepIndicator.querySelector('.step-status-icon');
            if (statusIcon) {
                statusIcon.textContent = 'â³';
            }
        }
        
        // å¦‚æœæœ‰ä¹‹å‰çš„thinking/contentåŒºåŸŸï¼ŒæŠ˜å å®ƒä»¬
        if (thinkingSection && !thinkingSection.classList.contains('hidden')) {
            // å¯é€‰ï¼šæŠ˜å ä¹‹å‰çš„æ­¥éª¤ï¼Œæˆ–è€…ä¿ç•™å±•å¼€
        }
    }
    else if (data.type === 'step_done') {
        // æ­¥éª¤å®Œæˆï¼Œå¯ä»¥æ·»åŠ å®Œæˆæ ‡è®°
        if (statusEl) {
            statusEl.querySelector('span').textContent = `âœ… Step ${data.step_order}/${data.total_steps} å®Œæˆ`;
        }
        
        // ğŸ†• æ›´æ–°Plan Previewä¸­çš„å®ŒæˆçŠ¶æ€
        const stepIndicator = document.getElementById(`plan-step-${data.step_order}`);
        if (stepIndicator) {
            // æ ‡è®°ä¸ºå·²å®Œæˆ
            stepIndicator.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
            stepIndicator.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€å›¾æ ‡
            const statusIcon = stepIndicator.querySelector('.step-status-icon');
            if (statusIcon) {
                statusIcon.textContent = 'âœ…';
            }
        }
    }
    else if (data.type === 'step_error') {
        // æ­¥éª¤å¤±è´¥
        if (statusEl) {
            statusEl.querySelector('span').textContent = `âš ï¸ Step ${data.step_order} å¤±è´¥: ${data.error}`;
        }
        
        // ğŸ†• æ›´æ–°Plan Previewä¸­çš„é”™è¯¯çŠ¶æ€
        const stepIndicator = document.getElementById(`plan-step-${data.step_order}`);
        if (stepIndicator) {
            // æ ‡è®°ä¸ºå¤±è´¥
            stepIndicator.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
            stepIndicator.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€å›¾æ ‡
            const statusIcon = stepIndicator.querySelector('.step-status-icon');
            if (statusIcon) {
                statusIcon.textContent = 'âŒ';
            }
        }
    } 
    else if (data.type === 'thinking') {
        // å®æ—¶è¿½åŠ æ€è€ƒå†…å®¹
        // é¦–æ¬¡thinkingåˆ°è¾¾æ—¶ï¼Œæ˜¾ç¤ºthinkingåŒºåŸŸ
        if (thinkingSection && thinkingSection.classList.contains('hidden')) {
            thinkingSection.classList.remove('hidden');
        }
        if (thinkingEl) {
            // ğŸ†• ç´¯ç§¯æ–‡æœ¬å¹¶æ¸²æŸ“Markdown + LaTeX
            thinkingEl.textContent += data.text;
            
            // ç®€å•çš„Markdownæ¸²æŸ“ï¼š**ç²—ä½“**
            let renderedText = thinkingEl.textContent
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-text-light-primary dark:text-text-dark-primary">$1</strong>');
            
            thinkingEl.innerHTML = renderedText;
            
            // ğŸ†• LaTeXæ¸²æŸ“ï¼ˆKaTeXï¼‰
            if (typeof renderMathInElement !== 'undefined') {
                try {
                    renderMathInElement(thinkingEl, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\[', right: '\\]', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                } catch (e) {
                    console.warn('LaTeX rendering error:', e);
                }
            }
            
            scrollToBottom();
        }
    } 
    else if (data.type === 'content') {
        // ğŸ†• å®æ—¶æ˜¾ç¤ºcontentæ–‡æœ¬ï¼ˆæµå¼æ‰“å­—æ•ˆæœï¼‰
        const contentSection = document.getElementById(`${responseId}-content-section`);
        const contentTextEl = document.getElementById(`${responseId}-content-text`);
        
        // é¦–æ¬¡contentåˆ°è¾¾æ—¶ï¼Œæ˜¾ç¤ºcontentåŒºåŸŸ
        if (contentSection && contentSection.classList.contains('hidden')) {
            contentSection.classList.remove('hidden');
        }
        
        // å®æ—¶è¿½åŠ contentæ–‡æœ¬
        if (contentTextEl) {
            contentTextEl.textContent += data.text;
            scrollToBottom();
        }
    } 
    else if (data.type === 'done') {
        // ç”Ÿæˆå®Œæˆï¼Œæ¸²æŸ“æœ€ç»ˆç»“æœ
        if (statusEl) statusEl.remove();
        
        // ğŸ†• éšè—contentæ–‡æœ¬åŒºåŸŸï¼ˆåŸå§‹JSONï¼‰ï¼Œæ˜¾ç¤ºæ ¼å¼åŒ–çš„å¡ç‰‡
        const contentSection = document.getElementById(`${responseId}-content-section`);
        if (contentSection) {
            // æ›´æ–°æ ‡é¢˜ä¸º"å®Œæˆ"
            const contentTitle = contentSection.querySelector('span.text-sm');
            if (contentTitle) {
                contentTitle.textContent = 'âœ… JSONç¼–å†™å®Œæˆ';
                contentTitle.classList.remove('text-green-700', 'dark:text-green-400');
                contentTitle.classList.add('text-primary');
            }
        }
        
        // æ¸²æŸ“æœ€ç»ˆæ ¼å¼åŒ–çš„å¡ç‰‡UI
        if (finalEl && data.content) {
            finalEl.classList.remove('hidden');
            const contentType = data.content_type;
            
            // æ¸²æŸ“ä¸åŒç±»å‹çš„å¡ç‰‡
            if (contentType === 'quiz_set' && data.content.questions) {
                finalEl.innerHTML = renderQuizCard(data.content);
            } else if (contentType === 'explanation' && data.content.concept) {
                finalEl.innerHTML = renderExplainCard(data.content);
            } else if (contentType === 'flashcard_set' && data.content.cards) {
                finalEl.innerHTML = renderFlashcardSet(data.content);
            } else if (contentType === 'learning_bundle' && data.content.components) {
                finalEl.innerHTML = renderLearningBundle(data.content);
            } else if (contentType === 'mindmap' && data.content.root) {
                finalEl.innerHTML = renderMindMapCard(data.content);
            } else if (contentType === 'notes' && data.content.structured_notes) {
                finalEl.innerHTML = renderNotesCard(data.content);
            } else {
                // æœªçŸ¥ç±»å‹ï¼Œæ˜¾ç¤ºJSON
                finalEl.innerHTML = `<div class="p-6"><pre class="text-sm">${JSON.stringify(data.content, null, 2)}</pre></div>`;
            }
        }
        
        scrollToBottom();
        console.log('âœ… Stream finished');
    } 
    else if (data.type === 'error') {
        updateStreamError(responseId, data.message);
    }
}

function updateStreamError(responseId, message) {
    const container = document.getElementById(responseId);
    if (container) {
        container.innerHTML = `
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                <div class="w-full max-w-2xl rounded-xl border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20 p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-red-800 dark:text-red-200 mb-2">å‘ç”Ÿé”™è¯¯</h3>
                            <p class="text-sm text-red-700 dark:text-red-300">${escapeHtml(message)}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// æ·»åŠ åŠ è½½æ¶ˆæ¯
function addLoadingMessage() {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    const loadingMsg = `
        <div class="flex items-end gap-3 max-w-2xl" id="loadingMessage">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD4akB4LF1N3Soza8KZVpuDmX2j9J1Bm-Q7ClnC4wgqdXiZ6gWh0GikuESsR5ipv-M9eN48aHZTdCPsjIQAUFgiyvioA_Sk_14dwwbvFKoIJSRPlAq_kFDf1rz5-dqEkf9nEE2-5vA6R0ip58qcct5NzBXsF3iyDqi2LSJgsfUyXFItvX1CwxGl-MVLpHEufw0lwuexPO6Xkfn83jSdg42dyxyrjn8WNSJFcbSuhlcuscBOyRnZuEg6m5G2gYpvxIUvPJ_Cw1xWPRw8");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                <div class="text-base font-normal leading-normal flex items-center gap-2 rounded-xl rounded-bl-none px-4 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light-primary dark:text-text-dark-primary">
                    <div class="w-1.5 h-1.5 rounded-full bg-text-light-secondary dark:bg-text-dark-secondary animate-[bounce_1s_infinite_0.1s]"></div>
                    <div class="w-1.5 h-1.5 rounded-full bg-text-light-secondary dark:bg-text-dark-secondary animate-[bounce_1s_infinite_0.2s]"></div>
                    <div class="w-1.5 h-1.5 rounded-full bg-text-light-secondary dark:bg-text-dark-secondary animate-[bounce_1s_infinite_0.3s]"></div>
                </div>
            </div>
        </div>
    `;
    messagesDiv.insertAdjacentHTML('beforeend', loadingMsg);
    scrollToBottom();
}

// ç§»é™¤åŠ è½½æ¶ˆæ¯
function removeLoadingMessage() {
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) loadingMsg.remove();
}

// æ¸²æŸ“ QuizCard
// ğŸ†• æ¸²æŸ“Plané¢„è§ˆå¡ç‰‡
function renderPlanPreview(topic, stepsPreview, totalSteps) {
    const stepsHtml = stepsPreview.map((step, idx) => {
        const stepNumber = step.step_order;
        const isFirst = idx === 0;
        const isLast = idx === stepsPreview.length - 1;
        
        return `
            <div id="plan-step-${stepNumber}" 
                 class="plan-step-item flex items-start gap-4 p-4 rounded-lg border-2 border-border-light dark:border-border-dark transition-all duration-300">
                <!-- æ­¥éª¤ç¼–å·å’ŒçŠ¶æ€ -->
                <div class="flex flex-col items-center gap-2">
                    <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                        <span class="text-lg font-bold text-primary">${stepNumber}</span>
                    </div>
                    <div class="step-status-icon text-2xl">â¸ï¸</div>
                </div>
                
                <!-- æ­¥éª¤å†…å®¹ -->
                <div class="flex-1 min-w-0">
                    <h4 class="text-lg font-semibold text-text-light-primary dark:text-text-dark-primary mb-2">
                        ${escapeHtml(step.step_name)}
                    </h4>
                    ${step.step_description ? `
                        <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary mb-2">
                            ${escapeHtml(step.step_description)}
                        </p>
                    ` : ''}
                    <div class="flex items-center gap-2 text-xs text-text-light-secondary dark:text-text-dark-secondary">
                        <span class="px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800">
                            ${escapeHtml(step.skill_id)}
                        </span>
                    </div>
                </div>
                
                <!-- è¿æ¥çº¿ï¼ˆä¸æ˜¯æœ€åä¸€ä¸ªæ­¥éª¤æ—¶æ˜¾ç¤ºï¼‰ -->
                ${!isLast ? `
                    <div class="absolute left-10 top-20 w-0.5 h-12 bg-border-light dark:bg-border-dark"></div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    return `
        <div class="w-full max-w-3xl mb-6">
            <div class="border-2 border-primary/30 rounded-xl overflow-hidden bg-gradient-to-br from-blue-50/50 to-purple-50/50 dark:from-blue-900/10 dark:to-purple-900/10">
                <!-- Header -->
                <div class="px-6 py-4 bg-primary/5 border-b border-primary/20">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                            <span class="text-white text-xl">ğŸ“š</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-text-light-primary dark:text-text-dark-primary">
                                å­¦ä¹ åŒ…ç”Ÿæˆè®¡åˆ’
                            </h3>
                            <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary mt-1">
                                ä¸»é¢˜ï¼š${escapeHtml(topic)} Â· å…± ${totalSteps} ä¸ªæ­¥éª¤
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Steps -->
                <div class="p-6 space-y-4 relative">
                    ${stepsHtml}
                </div>
                
                <!-- Footer -->
                <div class="px-6 py-3 bg-gray-50 dark:bg-gray-900 border-t border-border-light dark:border-border-dark">
                    <p class="text-xs text-text-light-secondary dark:text-text-dark-secondary text-center">
                        â³ å‡†å¤‡å¼€å§‹ç”Ÿæˆ...
                    </p>
                </div>
            </div>
        </div>
    `;
}

// ğŸ†• æ¸²æŸ“æ€è€ƒè¿‡ç¨‹ï¼ˆæ”¯æŒMarkdownå’ŒLaTeXï¼‰
function renderThinkingProcess(thinking) {
    if (!thinking) return '';
    
    // ç®€å•çš„Markdownæ¸²æŸ“ï¼š**ç²—ä½“**
    let renderedText = escapeHtml(thinking)
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
    
    return `
        <div class="w-full max-w-3xl mb-4">
            <details class="group border border-border-light dark:border-border-dark rounded-lg overflow-hidden bg-surface-light dark:bg-surface-dark">
                <summary class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <span class="text-base font-semibold text-text-light-primary dark:text-text-dark-primary">ğŸ§  æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <span class="text-xs text-text-light-secondary dark:text-text-dark-secondary">ç‚¹å‡»å±•å¼€</span>
                </summary>
                <div class="px-4 py-3 border-t border-border-light dark:border-border-dark bg-gray-50 dark:bg-gray-900">
                    <div class="prose prose-sm dark:prose-invert max-w-none">
                        <pre class="whitespace-pre-wrap text-sm text-text-light-secondary dark:text-text-dark-secondary leading-relaxed thinking-content">${renderedText}</pre>
                    </div>
                </div>
            </details>
        </div>
    `;
}

function renderQuizCard(content) {
    const questions = content.questions || [];
    if (questions.length === 0) return '<p>æš‚æ— é¢˜ç›®</p>';
    
    // ğŸ†• æ·»åŠ æ€è€ƒè¿‡ç¨‹
    let html = renderThinkingProcess(content._thinking);
    
    html += '<div class="flex flex-col gap-6 w-full">';
    
    questions.forEach((q, idx) => {
        html += `
            <div class="flex flex-col gap-6 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-6 shadow-sm">
                <div class="flex flex-col gap-3">
                    <p class="text-primary text-base font-medium">${content.subject || 'ç»ƒä¹ é¢˜'}</p>
                    <div class="rounded bg-slate-200 dark:bg-slate-700">
                        <div class="h-2 rounded bg-primary" style="width: ${((idx + 1) / questions.length * 100)}%;"></div>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">Question ${idx + 1} of ${questions.length}</p>
                </div>
                <div class="border-t border-border-light dark:border-border-dark"></div>
                <h1 class="text-text-light-primary dark:text-text-dark-primary tracking-tight text-xl font-bold">${q.question_text || ''}</h1>
                <div class="flex flex-col gap-3" style="--radio-dot-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(19,127,236)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3ccircle cx=%278%27 cy=%278%27 r=%273%27/%3e%3c/svg%3e');">`;
        
        (q.options || []).forEach((opt) => {
            html += `
                    <label class="flex items-center gap-4 rounded-lg border border-solid border-border-light dark:border-border-dark p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 has-[:checked]:border-primary has-[:checked]:bg-primary/10">
                        <input class="h-5 w-5 border-2 border-border-light dark:border-border-dark bg-transparent text-transparent checked:border-primary checked:bg-[image:--radio-dot-svg] focus:outline-none focus:ring-0" name="quiz_${idx}" type="radio"/>
                        <div class="flex grow flex-col"><p class="text-text-light-primary dark:text-text-dark-primary text-sm font-medium">${opt}</p></div>
                    </label>`;
        });
        
        html += `
                </div>`;
        
        if (q.explanation) {
            html += `
                <div class="flex flex-col gap-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 p-4 mt-2">
                    <h3 class="text-lg font-bold text-text-light-primary dark:text-text-dark-primary">è§£æ</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300">${q.explanation}</p>
                    <p class="text-sm text-primary font-medium">æ­£ç¡®ç­”æ¡ˆ: ${q.correct_answer}</p>
                </div>`;
        }
        
        html += `
            </div>`;
    });
    
    html += '</div>';
    return html;
}

// æ¸²æŸ“ ExplainCard
function renderExplainCard(content) {
    const concept = content.concept || '';
    const intuition = content.intuition || '';
    const formalDef = content.formal_definition || '';
    const examples = content.examples || [];
    
    // ğŸ†• æ·»åŠ æ€è€ƒè¿‡ç¨‹
    let html = renderThinkingProcess(content._thinking);
    html += `
        <div class="w-full rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-sm">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-text-light-primary dark:text-text-dark-primary tracking-tight">${concept}</h1>
            </div>
            <div class="px-6 pb-6 text-base text-text-light-primary dark:text-text-dark-primary space-y-4">
                <p>${intuition}</p>`;
    
    if (formalDef) {
        html += `
                <div class="my-4 p-4 bg-background-light dark:bg-background-dark rounded-lg font-mono text-sm">
                    <span class="font-bold">${formalDef}</span>
                </div>`;
    }
    
    if (examples && examples.length > 0) {
        html += `
            </div>
            <hr class="border-border-light dark:border-border-dark"/>
            <div class="p-6">
                <h2 class="text-xl font-semibold text-text-light-primary dark:text-text-dark-primary mb-5">ä¾‹å­</h2>
                <div class="space-y-6">`;
        
        examples.forEach((ex, idx) => {
            html += `
                    <div class="flex flex-col gap-3">
                        <h3 class="font-semibold text-text-light-primary dark:text-text-dark-primary">
                            <span class="bg-primary text-white rounded-full h-6 w-6 inline-flex items-center justify-center text-sm mr-2">${idx + 1}</span>
                            ${ex.example || ex.title || ex.problem || 'ä¾‹å­ ' + (idx + 1)}
                        </h3>
                        <div class="pl-8 text-slate-600 dark:text-slate-300 border-l-2 border-primary/50 ml-3">
                            <p>${ex.explanation || ex.solution || ''}</p>
                        </div>
                    </div>`;
        });
        
        html += `
                </div>`;
    }
    
    html += `
            </div>
        </div>`;
    
    return html;
}

// æ¸²æŸ“ FlashcardSet
function renderFlashcardSet(content) {
    const cards = content.cards || [];
    if (cards.length === 0) return '<p>æš‚æ— æŠ½è®¤å¡</p>';
    
    // ğŸ†• æ·»åŠ æ€è€ƒè¿‡ç¨‹
    let html = renderThinkingProcess(content._thinking);
    html += '<div class="flex flex-col gap-4 w-full">';
    html += `<h3 class="text-lg font-bold text-text-light-primary dark:text-text-dark-primary">ğŸ“š æŠ½è®¤å¡é›†åˆ</h3>`;
    
    cards.forEach((card, idx) => {
        html += `
            <div class="rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-6 shadow-sm">
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-primary text-white rounded-full h-6 w-6 inline-flex items-center justify-center text-sm">${idx + 1}</span>
                    <span class="text-sm text-slate-500">${card.card_type || 'basic'}</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-medium text-slate-500 mb-2">æ­£é¢ï¼ˆFrontï¼‰</p>
                        <p class="text-base text-text-light-primary dark:text-text-dark-primary">${card.front}</p>
                    </div>
                    <div class="border-t border-border-light dark:border-border-dark pt-4">
                        <p class="text-sm font-medium text-slate-500 mb-2">èƒŒé¢ï¼ˆBackï¼‰</p>
                        <p class="text-base text-text-light-primary dark:text-text-dark-primary">${card.back}</p>
                    </div>`;
        
        if (card.hints && card.hints.length > 0) {
            html += `
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                        <p class="text-sm font-medium text-primary mb-1">ğŸ’¡ æç¤º</p>
                        <ul class="text-sm text-slate-600 dark:text-slate-300 list-disc list-inside">
                            ${card.hints.map(h => `<li>${h}</li>`).join('')}
                        </ul>
                    </div>`;
        }
        
        html += `
                </div>
            </div>`;
    });
    
    html += '</div>';
    return html;
}

// æ¸²æŸ“ Notes (å­¦ä¹ ç¬”è®°) - Notebook é£æ ¼ï¼Œæ”¯æŒç¼–è¾‘
function renderNotesCard(content) {
    const notes = content.structured_notes || {};
    const sections = notes.sections || [];
    const notesId = content.notes_id || `notes_${Date.now()}`;
    
    let html = `
        <div class="w-full rounded-xl border-2 border-border-light dark:border-border-dark bg-white dark:bg-gray-800 shadow-lg overflow-hidden notebook-container" id="notes_${notesId}" data-notes-id="${notesId}">
            <!-- ç¬”è®°å¤´éƒ¨ -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-white text-3xl">description</span>
                        <div>
                            <p class="text-sm text-blue-100">${content.subject || 'å­¦ä¹ ç¬”è®°'}</p>
                            <h3 class="text-2xl font-bold text-white editable-title" contenteditable="false">${notes.title || content.topic || 'ç¬”è®°'}</h3>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleEditMode('${notesId}')" class="edit-btn px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            <span class="edit-text">ç¼–è¾‘</span>
                        </button>
                        <button onclick="saveNotes('${notesId}')" class="save-btn hidden px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">save</span>
                            <span>ä¿å­˜</span>
                        </button>
                        <button onclick="cancelEdit('${notesId}')" class="cancel-btn hidden px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">close</span>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç¬”è®°å†…å®¹åŒºåŸŸ -->
            <div class="p-8 space-y-6 notes-content bg-amber-50/30 dark:bg-gray-900/30">`;
    
    sections.forEach((section, idx) => {
        html += `
            <div class="notebook-section bg-white dark:bg-gray-800 rounded-lg p-6 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition-shadow" data-section-id="${idx}">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-100 section-heading" contenteditable="false">
                        ${section.heading}
                    </h4>
                    <button onclick="addBulletPoint('${notesId}', ${idx})" class="add-point-btn hidden text-blue-500 hover:text-blue-700 p-1">
                        <span class="material-symbols-outlined text-sm">add_circle</span>
                    </button>
                </div>
                <ul class="space-y-3 bullet-list">`;
        
        (section.bullet_points || []).forEach((point, pointIdx) => {
            html += `
                <li class="flex items-start gap-3 group" data-point-id="${pointIdx}">
                    <span class="text-blue-500 mt-1 text-lg">â€¢</span>
                    <span class="flex-1 text-base text-gray-700 dark:text-gray-300 leading-relaxed bullet-point" contenteditable="false">${point}</span>
                    <button onclick="removeBulletPoint('${notesId}', ${idx}, ${pointIdx})" class="delete-point-btn hidden opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity p-1">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </li>`;
        });
        
        html += `
                </ul>
            </div>`;
    });
    
    html += `
            </div>
            
            <!-- ç¬”è®°åº•éƒ¨ -->
            <div class="bg-gray-50 dark:bg-gray-900 px-8 py-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined text-xs align-middle">info</span>
                    ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå¯ä»¥ä¿®æ”¹æ ‡é¢˜ã€ç« èŠ‚æ ‡é¢˜å’Œè¦ç‚¹å†…å®¹
                </p>
            </div>
        </div>`;
    
    return html;
}

// æ¸²æŸ“ Learning Bundle
function renderLearningBundle(content) {
    const components = content.components || [];
    if (components.length === 0) return '<p>æš‚æ— å­¦ä¹ èµ„æ–™</p>';
    
    let html = '<div class="flex flex-col gap-6 w-full">';
    html += `
        <div class="rounded-xl border border-primary/50 bg-primary/5 p-4">
            <h3 class="text-xl font-bold text-primary mb-2">ğŸ“¦ å®Œæ•´å­¦ä¹ åŒ…</h3>
            <p class="text-sm text-slate-600 dark:text-slate-300">${content.learning_path ? content.learning_path.join(' â†’ ') : 'åŒ…å«å¤šä¸ªå­¦ä¹ ç»„ä»¶'}</p>
            ${content.estimated_time_minutes ? `<p class="text-sm text-primary mt-2">â±ï¸ é¢„è®¡å­¦ä¹ æ—¶é—´ï¼š${content.estimated_time_minutes} åˆ†é’Ÿ</p>` : ''}
        </div>`;
    
    components.forEach((comp, idx) => {
        html += `<div class="border-l-4 border-primary pl-4">`;
        html += `<h4 class="text-md font-bold text-primary mb-3">ç¬¬ ${idx + 1} éƒ¨åˆ†ï¼š${comp.component_type === 'explanation' ? 'æ¦‚å¿µè®²è§£' : comp.component_type === 'quiz' ? 'ç»ƒä¹ é¢˜' : 'æŠ½è®¤å¡'}</h4>`;
        
        if (comp.component_type === 'explanation' && comp.content.concept) {
            html += renderExplainCard(comp.content);
        } else if (comp.component_type === 'quiz' && comp.content.questions) {
            html += renderQuizCard(comp.content);
        } else if (comp.component_type === 'flashcard' && comp.content.cards) {
            html += renderFlashcardSet(comp.content);
        } else {
            html += `<pre class="text-xs">${JSON.stringify(comp.content, null, 2)}</pre>`;
        }
        
        html += `</div>`;
    });
    
    html += '</div>';
    return html;
}

// æ¸²æŸ“ MindMap (æ€ç»´å¯¼å›¾)
function renderMindMapCard(content) {
    if (!content.root) {
        return '<p>æ€ç»´å¯¼å›¾æ•°æ®æ ¼å¼é”™è¯¯</p>';
    }
    
    // ç”Ÿæˆå”¯ä¸€ ID
    const mindmapId = `mindmap-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    let html = `
        <div class="w-full rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-sm overflow-hidden">
            <div class="p-4 border-b border-border-light dark:border-border-dark">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">account_tree</span>
                        <div>
                            <h3 class="text-lg font-bold text-text-light-primary dark:text-text-dark-primary">${content.subject || 'æ€ç»´å¯¼å›¾'} - ${content.topic || ''}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${content.structure_summary || ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-slate-500">edit</span>
                        <span class="text-xs text-slate-500">å¯ç¼–è¾‘</span>
                    </div>
                </div>
            </div>
            <div id="${mindmapId}" class="w-full" style="height: 600px; background: #fff;"></div>
            <div class="p-3 border-t border-border-light dark:border-border-dark bg-slate-50 dark:bg-slate-800">
                <p class="text-xs text-slate-600 dark:text-slate-400">
                    ğŸ’¡ æç¤ºï¼šå³é”®ç‚¹å‡»èŠ‚ç‚¹å¯ä»¥æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤èŠ‚ç‚¹ã€‚æ”¯æŒæ‹–æ‹½ç§»åŠ¨èŠ‚ç‚¹ä½ç½®ã€‚æŒ‰ Tab æ·»åŠ å­èŠ‚ç‚¹ï¼ŒEnter æ·»åŠ å…„å¼ŸèŠ‚ç‚¹ã€‚
                </p>
            </div>
        </div>
    `;
    
    // å»¶è¿Ÿåˆå§‹åŒ– Mind Elixirï¼ˆç­‰å¾… DOM æ’å…¥ï¼‰
    setTimeout(() => {
        initializeMindMap(mindmapId, content);
    }, 100);
    
    return html;
}

// åˆå§‹åŒ–æ€ç»´å¯¼å›¾ï¼ˆæ”¯æŒç¼–è¾‘åŠŸèƒ½ï¼‰
function initializeMindMap(containerId, mindmapData) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`å®¹å™¨ ${containerId} æœªæ‰¾åˆ°`);
        return;
    }
    
    if (typeof MindElixir === 'undefined') {
        console.error('Mind Elixir åº“æœªåŠ è½½');
        container.innerHTML = '<p class="p-4 text-red-500">æ€ç»´å¯¼å›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
        return;
    }
    
    try {
        // è½¬æ¢æ•°æ®æ ¼å¼ä¸º Mind Elixir æ ¼å¼
        const mindElixirData = convertToMindElixirFormat(mindmapData);
        
        // åˆå§‹åŒ– Mind Elixirï¼ˆå¯ç”¨ç¼–è¾‘åŠŸèƒ½ï¼‰
        const mind = new MindElixir({
            el: container,
            direction: MindElixir.SIDE,
            draggable: true,              // å¯ç”¨æ‹–æ‹½
            contextMenu: true,            // å¯ç”¨å³é”®èœå•
            toolBar: true,                // å¯ç”¨å·¥å…·æ ï¼ˆæ·»åŠ ã€åˆ é™¤èŠ‚ç‚¹ç­‰ï¼‰
            keypress: true,               // å¯ç”¨å¿«æ·é”®
            locale: 'zh_CN',
            allowUndo: true,              // å¯ç”¨æ’¤é”€/é‡åš
            overflowHidden: false,
            primaryLinkStyle: 2,
            primaryNodeVerticalGap: 15,
            primaryNodeHorizontalGap: 65,
            contextMenuOption: {
                focus: true,
                link: true,
                extend: [
                    {
                        name: 'æ·»åŠ å­èŠ‚ç‚¹',
                        onclick: () => {
                            mind.addChild();
                        },
                    },
                    {
                        name: 'æ·»åŠ å…„å¼ŸèŠ‚ç‚¹',
                        onclick: () => {
                            mind.insertSibling();
                        },
                    },
                    {
                        name: 'ç¼–è¾‘èŠ‚ç‚¹',
                        onclick: () => {
                            mind.beginEdit();
                        },
                    },
                    {
                        name: 'åˆ é™¤èŠ‚ç‚¹',
                        onclick: () => {
                            mind.removeNode();
                        },
                    },
                ],
            },
            before: {
                insertSibling(el, obj) {
                    console.log('æ’å…¥å…„å¼ŸèŠ‚ç‚¹');
                    return true;
                },
                async addChild(el, obj) {
                    console.log('æ·»åŠ å­èŠ‚ç‚¹');
                    return true;
                },
            },
        });
        
        // åŠ è½½æ•°æ®
        mind.init(mindElixirData);
        
        // ç›‘å¬èŠ‚ç‚¹å˜åŒ–äº‹ä»¶
        if (mind.bus && typeof mind.bus.addListener === 'function') {
            mind.bus.addListener('operation', (operation) => {
                console.log('æ€ç»´å¯¼å›¾æ“ä½œ:', operation.name);
                // å¯ä»¥åœ¨è¿™é‡Œä¿å­˜åˆ°åç«¯
            });
            
            mind.bus.addListener('nodeSelect', (node) => {
                console.log('é€‰ä¸­èŠ‚ç‚¹:', node.nodeData.topic);
            });
        }
        
        console.log('âœ… æ€ç»´å¯¼å›¾æ¸²æŸ“æˆåŠŸï¼ˆæ”¯æŒç¼–è¾‘ï¼‰:', containerId);
    } catch (error) {
        console.error('æ€ç»´å¯¼å›¾æ¸²æŸ“å¤±è´¥:', error);
        container.innerHTML = `<p class="p-4 text-red-500">æ€ç»´å¯¼å›¾æ¸²æŸ“å¤±è´¥: ${error.message}</p>`;
    }
}

// æ¸²æŸ“é¦–æ¬¡è®¿é—®å¼•å¯¼ï¼ˆOnboardingï¼‰
function renderOnboardingCard(content) {
    const { welcome, message, suggestions, call_to_action } = content;
    
    let html = `
        <div class="w-full max-w-3xl rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="p-6 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-white text-4xl">celebration</span>
                    <div>
                        <h3 class="text-2xl font-bold text-white">${welcome}</h3>
                        <p class="text-sm text-indigo-100 mt-1">${message}</p>
                    </div>
                </div>
            </div>
            
            <!-- Topic Suggestions -->
            <div class="p-6">
                <p class="text-base font-semibold text-slate-700 dark:text-slate-300 mb-4">
                    ğŸ¯ æˆ‘å¯ä»¥å¸®æ‚¨å­¦ä¹ ä»¥ä¸‹å­¦ç§‘ï¼š
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">`;
    
    suggestions.forEach(category => {
        html += `
                    <div class="border border-slate-300 dark:border-slate-600 rounded-lg p-4 hover:border-primary hover:shadow-md transition-all">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">${category.icon}</span>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200">${category.category}</h4>
                        </div>
                        <div class="flex flex-wrap gap-2">`;
        
        category.topics.forEach(topic => {
            html += `
                            <button 
                                onclick="startLearning('${topic.replace(/'/g, "\\'")}')"
                                class="px-3 py-1 text-sm rounded-full border border-slate-300 dark:border-slate-600 
                                       hover:bg-primary hover:text-white hover:border-primary transition-all
                                       text-slate-700 dark:text-slate-300">
                                ${topic}
                            </button>`;
        });
        
        html += `
                        </div>
                    </div>`;
    });
    
    html += `
                </div>
            </div>
            
            <!-- Call to Action -->
            <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 border-t border-slate-200 dark:border-slate-700">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-primary text-2xl">lightbulb</span>
                    <p class="text-sm text-slate-700 dark:text-slate-300 flex-1">
                        ${call_to_action}
                    </p>
                </div>
            </div>
        </div>
    `;
    
    return html;
}

// å¤„ç†å¼€å§‹å­¦ä¹ ï¼ˆä»onboardingï¼‰
function startLearning(topic) {
    console.log('ğŸ“ Start learning:', topic);
    
    // æ„å»ºæ¶ˆæ¯å¹¶è®¾ç½®åˆ°è¾“å…¥æ¡†
    const message = `è®²è®²${topic}`;
    const input = document.getElementById('messageInput');
    input.value = message;
    
    // è°ƒç”¨ handleSend ä¼šè‡ªåŠ¨ï¼š
    // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    // 2. å‘é€åˆ°åç«¯
    // 3. æ˜¾ç¤º Agent å“åº”
    handleSend();
}

// æ¸²æŸ“æ¾„æ¸…è¯·æ±‚ï¼ˆClarificationï¼‰
function renderClarificationCard(content) {
    const { question, learned_topics, suggestion } = content;
    
    let html = `
        <div class="w-full max-w-2xl rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-sm overflow-hidden">
            <!-- Header -->
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-500">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-white text-3xl">help_outline</span>
                    <div>
                        <h3 class="text-xl font-bold text-white">éœ€è¦æ‚¨çš„é€‰æ‹©</h3>
                        <p class="text-sm text-blue-100">Please clarify your request</p>
                    </div>
                </div>
            </div>
            
            <!-- Question -->
            <div class="p-6 border-b border-border-light dark:border-border-dark">
                <p class="text-lg text-text-light-primary dark:text-text-dark-primary mb-4">
                    ${question}
                </p>
                
                <!-- Learned Topics -->
                <div class="space-y-2">
                    <p class="text-sm font-semibold text-slate-600 dark:text-slate-400 mb-3">ğŸ“š æ‚¨æœ€è¿‘å­¦ä¹ è¿‡ï¼š</p>`;
    
    learned_topics.forEach((item, idx) => {
        const icon = item.type === 'explanation' ? 'ğŸ“–' : 
                     item.type === 'quiz_set' ? 'âœï¸' : 
                     item.type === 'flashcard_set' ? 'ğŸ´' : 'ğŸ“';
        html += `
                    <button 
                        onclick="selectTopic('${item.topic.replace(/'/g, "\\'")}', '${content.intent || 'notes'}')"
                        class="w-full text-left px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-600 
                               hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all
                               text-text-light-primary dark:text-text-dark-primary">
                        <span class="mr-2">${icon}</span>
                        <span class="font-medium">${item.topic}</span>
                    </button>`;
    });
    
    html += `
                </div>
            </div>
            
            <!-- Suggestion -->
            <div class="p-4 bg-slate-50 dark:bg-slate-800/50">
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    ğŸ’¡ ${suggestion}
                </p>
            </div>
        </div>
    `;
    
    return html;
}

// å¤„ç†ç”¨æˆ·é€‰æ‹©ä¸»é¢˜
function selectTopic(topic, intent) {
    console.log('ğŸ¯ User selected topic:', topic, 'for intent:', intent);
    
    // æ ¹æ®intentæ„å»ºæ¶ˆæ¯ï¼ˆæ”¯æŒæ‰€æœ‰skillsï¼‰
    const intentMessages = {
        'notes': `åš${topic}çš„ç¬”è®°`,
        'quiz_request': `ç”Ÿæˆ${topic}çš„é¢˜ç›®`,
        'flashcard_request': `ç”Ÿæˆ${topic}çš„é—ªå¡`,
        'explain_request': `è®²è§£${topic}`,
        'mindmap': `ç”Ÿæˆ${topic}çš„æ€ç»´å¯¼å›¾`,
        'learning_bundle': `è·å–${topic}çš„å­¦ä¹ èµ„æ–™`
    };
    
    const message = intentMessages[intent] || `å­¦ä¹ ${topic}`;
    
    // è®¾ç½®æ¶ˆæ¯åˆ°è¾“å…¥æ¡†å¹¶å‘é€
    const input = document.getElementById('messageInput');
    input.value = message;
    
    // è°ƒç”¨ handleSend ä¼šè‡ªåŠ¨ï¼š
    // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    // 2. å‘é€åˆ°åç«¯
    // 3. æ˜¾ç¤º Agent å“åº”
    handleSend();
}

// å°†åç«¯æ•°æ®è½¬æ¢ä¸º Mind Elixir æ ¼å¼
function convertToMindElixirFormat(mindmapData) {
    return {
        nodeData: {
            id: mindmapData.root.id,
            topic: mindmapData.root.text,
            children: mindmapData.root.children.map(convertMindMapNode),
            style: {
                fontSize: '18px',
                color: mindmapData.root.color || '#10b981',
                fillColor: '#fff',
                borderColor: mindmapData.root.color || '#10b981',
                borderWidth: 2,
            },
        },
    };
}

// é€’å½’è½¬æ¢èŠ‚ç‚¹
function convertMindMapNode(node) {
    return {
        id: node.id,
        topic: node.text,
        children: node.children?.map(convertMindMapNode) || [],
        style: {
            fontSize: '14px',
            color: node.color || '#333',
            fillColor: '#fff',
            borderColor: node.color || '#ccc',
            borderWidth: 1,
        },
    };
}

// æ·»åŠ  Agent å“åº”
function addAgentMessage(data) {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    
    // ğŸ” è°ƒè¯•ï¼šæ‰“å°å®Œæ•´å“åº”
    console.log('ğŸ“¥ Agent response:', {
        content_type: data.content_type,
        intent: data.intent,
        skill_id: data.skill_id,
        has_structured_notes: !!data.response_content?.structured_notes,
        response_content_keys: Object.keys(data.response_content || {}),
        full_response: data
    });
    
    // æ ¹æ® content_type æ¸²æŸ“ä¸åŒçš„å¡ç‰‡
    let contentHtml = '';
    
    if (data.content_type === 'mixed_response' && data.response_content.results) {
        // æ··åˆè¯·æ±‚ï¼šæ¸²æŸ“å¤šä¸ªç»“æœ
        console.log('ğŸ­ Mixed response results:', data.response_content.results);
        data.response_content.results.forEach((result, idx) => {
            console.log(`ğŸ“¦ Result ${idx + 1}:`, {
                content_type: result.content_type,
                has_structured_notes: !!result.content?.structured_notes,
                content_keys: Object.keys(result.content || {})
            });
        });
        
        contentHtml = '<div class="flex flex-col gap-6 w-full">';
        data.response_content.results.forEach((result, idx) => {
            contentHtml += `<div class="border-l-4 border-primary pl-4">`;
            contentHtml += `<h3 class="text-lg font-bold text-primary mb-3">ğŸ“¦ ç»“æœ ${idx + 1}</h3>`;
            
            if (result.content_type === 'quiz_set' && result.content.questions) {
                contentHtml += renderQuizCard(result.content);
            } else if (result.content_type === 'explanation' && result.content.concept) {
                contentHtml += renderExplainCard(result.content);
            } else if (result.content_type === 'flashcard_set' && result.content.cards) {
                contentHtml += renderFlashcardSet(result.content);
            } else if (result.content_type === 'learning_bundle' && result.content.components) {
                contentHtml += renderLearningBundle(result.content);
            } else if (result.content_type === 'mindmap' && result.content.root) {
                contentHtml += renderMindMapCard(result.content);
            } else if (result.content_type === 'notes' && result.content.structured_notes) {
                contentHtml += renderNotesCard(result.content);
            } else {
                contentHtml += `<pre class="text-xs">${JSON.stringify(result.content, null, 2)}</pre>`;
            }
            
            contentHtml += `</div>`;
        });
        contentHtml += '</div>';
    } else if (data.content_type === 'quiz_set' && data.response_content.questions) {
        contentHtml = renderQuizCard(data.response_content);
    } else if (data.content_type === 'explanation' && data.response_content.concept) {
        // Debug: æ‰“å° examples æ•°ç»„æŸ¥çœ‹ç»“æ„
        console.log('Explanation content:', data.response_content);
        console.log('Examples:', data.response_content.examples);
        contentHtml = renderExplainCard(data.response_content);
    } else if (data.content_type === 'flashcard_set' && data.response_content.cards) {
        contentHtml = renderFlashcardSet(data.response_content);
    } else if (data.content_type === 'learning_bundle' && data.response_content.components) {
        contentHtml = renderLearningBundle(data.response_content);
    } else if (data.content_type === 'mindmap' && data.response_content.root) {
        // æ€ç»´å¯¼å›¾æ¸²æŸ“
        contentHtml = renderMindMapCard(data.response_content);
    } else if (data.content_type === 'notes') {
        // å­¦ä¹ ç¬”è®°æ¸²æŸ“
        console.log('ğŸ“ æ¸²æŸ“ç¬”è®°, response_content:', data.response_content);
        if (data.response_content.structured_notes) {
            contentHtml = renderNotesCard(data.response_content);
        } else {
            console.warn('âš ï¸ Notes æ•°æ®ç»“æ„ä¸æ­£ç¡®ï¼Œç¼ºå°‘ structured_notes');
            contentHtml = `<pre class="text-xs overflow-auto p-4 bg-gray-100 dark:bg-gray-800 rounded">${JSON.stringify(data.response_content, null, 2)}</pre>`;
        }
    } else if (data.content_type === 'onboarding') {
        // ğŸ†• é¦–æ¬¡è®¿é—®å¼•å¯¼
        contentHtml = renderOnboardingCard(data.response_content);
    } else if (data.content_type === 'clarification') {
        // ğŸ†• æ¾„æ¸…è¯·æ±‚ï¼šè¯¢é—®ç”¨æˆ·é€‰æ‹©ä¸»é¢˜
        // âœ… ä¼ é€’å®Œæ•´çš„ dataï¼ŒåŒ…å« intent ä¿¡æ¯
        contentHtml = renderClarificationCard({
            ...data.response_content,
            intent: data.intent  // â† æ˜¾å¼ä¼ é€’ intent
        });
    } else if (data.content_type === 'text' && data.response_content.text) {
        // æ–‡æœ¬å¯¹è¯ï¼ˆå¦‚ "other" æ„å›¾ï¼‰
        contentHtml = renderThinkingProcess(data.response_content._thinking);
        contentHtml += `<p class="text-base font-normal leading-normal rounded-xl rounded-bl-none px-4 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light-primary dark:text-text-dark-primary whitespace-pre-wrap max-w-2xl">${data.response_content.text}</p>`;
    } else if (data.content_type === 'error') {
        // ğŸ†• Error ç±»å‹ä¸“é—¨å¤„ç†ï¼ˆåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
        contentHtml = renderThinkingProcess(data.response_content._thinking);
        contentHtml += `<div class="w-full max-w-2xl rounded-xl border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20 p-4">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div class="flex-1">
                    <h3 class="text-base font-semibold text-red-800 dark:text-red-200 mb-2">${data.response_content.error || 'å‘ç”Ÿé”™è¯¯'}</h3>
                    ${data.response_content.suggestion ? `<p class="text-sm text-red-700 dark:text-red-300">${data.response_content.suggestion}</p>` : ''}
                </div>
            </div>
        </div>`;
    } else {
        // é»˜è®¤æ¸²æŸ“ JSONï¼ˆä¹ŸåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
        contentHtml = renderThinkingProcess(data.response_content._thinking);
        contentHtml += `<p class="text-base font-normal leading-normal rounded-xl rounded-bl-none px-4 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light-primary dark:text-text-dark-primary whitespace-pre-wrap font-mono text-xs overflow-x-auto max-w-2xl">${JSON.stringify(data.response_content, null, 2)}</p>`;
    }
    
    const agentMsg = `
        <div class="flex items-start gap-3 w-full">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start w-full">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                ${contentHtml}
            </div>
        </div>
    `;
    messagesDiv.insertAdjacentHTML('beforeend', agentMsg);
    scrollToBottom();
}

// æ·»åŠ é”™è¯¯æ¶ˆæ¯
function addErrorMessage(errorText) {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    const errorMsg = `
        <div class="flex items-end gap-3 max-w-2xl">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                <p class="text-base font-normal leading-normal rounded-xl rounded-bl-none px-4 py-3 bg-red-50 border border-red-200 text-red-600">
                    âŒ ${errorText}
                </p>
            </div>
        </div>
    `;
    messagesDiv.insertAdjacentHTML('beforeend', errorMsg);
    scrollToBottom();
}

// ğŸ†• æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
let userScrolledAway = false;
let scrollCheckTimeout = null;
let lastScrollTop = 0;
let isAutoScrolling = false;

function scrollToBottom() {
    const chatArea = document.getElementById('chatMessages');
    
    // æ£€æµ‹ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ»šåŠ¨åˆ°å…¶ä»–ä½ç½®
    const isNearBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 100;
    
    // åªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
    if (isNearBottom && !userScrolledAway) {
        isAutoScrolling = true;
        chatArea.scrollTop = chatArea.scrollHeight;
        // çŸ­æš‚å»¶è¿Ÿåé‡ç½®æ ‡å¿—ï¼Œé¿å…è¯¯åˆ¤
        setTimeout(() => { isAutoScrolling = false; }, 50);
    }
}

// ç›‘å¬ç”¨æˆ·çš„æ»šåŠ¨è¡Œä¸º
document.addEventListener('DOMContentLoaded', () => {
    const chatArea = document.getElementById('chatMessages');
    
    chatArea.addEventListener('scroll', () => {
        // å¦‚æœæ˜¯è‡ªåŠ¨æ»šåŠ¨è§¦å‘çš„ï¼Œå¿½ç•¥
        if (isAutoScrolling) {
            lastScrollTop = chatArea.scrollTop;
            return;
        }
        
        clearTimeout(scrollCheckTimeout);
        
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…é¢‘ç¹è§¦å‘
        scrollCheckTimeout = setTimeout(() => {
            const scrollTop = chatArea.scrollTop;
            const scrollHeight = chatArea.scrollHeight;
            const clientHeight = chatArea.clientHeight;
            const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
            
            // æ£€æµ‹ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨
            const userScrolledUp = scrollTop < lastScrollTop;
            
            if (userScrolledUp || !isNearBottom) {
                // ç”¨æˆ·ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨ï¼Œæˆ–è€…ä¸åœ¨åº•éƒ¨
                userScrolledAway = true;
                console.log('ğŸ›‘ ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨');
            } else if (isNearBottom) {
                // ç”¨æˆ·æ»šå›åº•éƒ¨
                userScrolledAway = false;
                console.log('âœ… ç”¨æˆ·è¿”å›åº•éƒ¨ï¼Œæ¢å¤è‡ªåŠ¨æ»šåŠ¨');
            }
            
            lastScrollTop = scrollTop;
        }, 100);
    });
});

// æ–°å»ºèŠå¤©
function handleNewChat() {
    const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
    messagesDiv.innerHTML = `
        <div class="flex items-end gap-3 max-w-2xl">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCxe92kEf7gMHjbEHfZQu3F-p4XUO0nyA37zYAuOz7CiVXM_3hgmQ9gTI6zw7siePySKKolumdfXax7FjZ1tuLAnsb5rDYnZjw4LaKpR0MpYWUilv2DSX2VlCD416jAvXmMW3d3TA0MfMgLOkvyyvAqiNcFnqdLIk1LOdKh1Axylm3hUbhf-JtzopMhBhZ5WxEDvTgpGF0E65VLCr805vqY4iosbw4L8Qmm-sViAPSF8dXyszl2XldUnwHCnAakeX7o04PO1S6iwT_m");'></div>
            <div class="flex flex-1 flex-col gap-1 items-start">
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium">StudyX Agent</p>
                <p class="text-base font-normal leading-normal rounded-xl rounded-bl-none px-4 py-3 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark text-text-light-primary dark:text-text-dark-primary">
                    å¼€å§‹å’Œ AI å­¦ä¹ åŠ©æ‰‹å¯¹è¯å§ï¼ä½ å¯ä»¥å°è¯•ï¼š
                    <br>â€¢ "ç»™æˆ‘å‡ é“å¾®ç§¯åˆ†ç»ƒä¹ é¢˜"ï¼ˆæ•°å­¦ï¼‰
                    <br>â€¢ "è§£é‡Šä¸€ä¸‹ç‰›é¡¿ç¬¬äºŒå®šå¾‹"ï¼ˆç‰©ç†ï¼‰
                    <br>â€¢ "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"ï¼ˆç”Ÿç‰©ï¼‰
                    <br>â€¢ "å¸®æˆ‘ç†è§£äºŒæˆ˜çš„èµ·å› "ï¼ˆå†å²ï¼‰
                </p>
            </div>
        </div>
    `;
}

// ========================================
// ç¬”è®°ç¼–è¾‘åŠŸèƒ½
// ========================================

// åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
function toggleEditMode(notesId) {
    const container = document.getElementById(`notes_${notesId}`);
    if (!container) return;
    
    const isEditing = container.classList.contains('editing-mode');
    
    if (isEditing) {
        exitEditMode(container);
    } else {
        enterEditMode(container);
    }
}

// è¿›å…¥ç¼–è¾‘æ¨¡å¼
function enterEditMode(container) {
    container.classList.add('editing-mode');
    
    container.querySelector('.edit-btn').classList.add('hidden');
    container.querySelector('.save-btn').classList.remove('hidden');
    container.querySelector('.cancel-btn').classList.remove('hidden');
    
    container.querySelectorAll('[contenteditable]').forEach(el => {
        el.contentEditable = 'true';
        el.classList.add('editing', 'bg-yellow-50', 'dark:bg-yellow-900/20', 'px-2', 'py-1', 'rounded', 'border', 'border-yellow-300', 'dark:border-yellow-700');
    });
    
    container.querySelectorAll('.add-point-btn, .delete-point-btn').forEach(btn => {
        btn.classList.remove('hidden');
    });
    
    container.dataset.originalContent = container.innerHTML;
    console.log('âœï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼');
}

// é€€å‡ºç¼–è¾‘æ¨¡å¼
function exitEditMode(container) {
    container.classList.remove('editing-mode');
    
    container.querySelector('.edit-btn').classList.remove('hidden');
    container.querySelector('.save-btn').classList.add('hidden');
    container.querySelector('.cancel-btn').classList.add('hidden');
    
    container.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.contentEditable = 'false';
        el.classList.remove('editing', 'bg-yellow-50', 'dark:bg-yellow-900/20', 'px-2', 'py-1', 'rounded', 'border', 'border-yellow-300', 'dark:border-yellow-700');
    });
    
    container.querySelectorAll('.add-point-btn, .delete-point-btn').forEach(btn => {
        btn.classList.add('hidden');
    });
    
    delete container.dataset.originalContent;
    console.log('ğŸ‘ï¸ é€€å‡ºç¼–è¾‘æ¨¡å¼');
}

// ä¿å­˜ç¬”è®°
async function saveNotes(notesId) {
    const container = document.getElementById(`notes_${notesId}`);
    if (!container) return;
    
    try {
        const title = container.querySelector('.editable-title').textContent.trim();
        const sections = [];
        
        container.querySelectorAll('.notebook-section').forEach(sectionEl => {
            const heading = sectionEl.querySelector('.section-heading').textContent.trim();
            const bullet_points = [];
            
            sectionEl.querySelectorAll('.bullet-point').forEach(pointEl => {
                const text = pointEl.textContent.trim();
                if (text) bullet_points.push(text);
            });
            
            if (heading && bullet_points.length > 0) {
                sections.push({ heading, bullet_points });
            }
        });
        
        const updatedNotes = {
            notes_id: notesId,
            structured_notes: { title, sections }
        };
        
        console.log('ğŸ’¾ ä¿å­˜ç¬”è®°:', updatedNotes);
        
        // TODO: å‘é€åˆ°åç«¯ä¿å­˜
        // await fetch(`${API_BASE}/api/notes/${notesId}`, {
        //     method: 'PUT',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(updatedNotes)
        // });
        
        exitEditMode(container);
        showNotification('âœ… ç¬”è®°å·²ä¿å­˜', 'success');
        
    } catch (error) {
        console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
        showNotification('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit(notesId) {
    const container = document.getElementById(`notes_${notesId}`);
    if (!container) return;
    
    if (container.dataset.originalContent) {
        container.innerHTML = container.dataset.originalContent;
    }
    
    console.log('ğŸš« å–æ¶ˆç¼–è¾‘');
}

// æ·»åŠ è¦ç‚¹
function addBulletPoint(notesId, sectionIdx) {
    const container = document.getElementById(`notes_${notesId}`);
    if (!container) return;
    
    const section = container.querySelector(`[data-section-id="${sectionIdx}"]`);
    if (!section) return;
    
    const bulletList = section.querySelector('.bullet-list');
    const newPointIdx = bulletList.children.length;
    
    const newPoint = document.createElement('li');
    newPoint.className = 'flex items-start gap-3 group';
    newPoint.dataset.pointId = newPointIdx;
    newPoint.innerHTML = `
        <span class="text-blue-500 mt-1 text-lg">â€¢</span>
        <span class="flex-1 text-base text-gray-700 dark:text-gray-300 leading-relaxed bullet-point editing bg-yellow-50 dark:bg-yellow-900/20 px-2 py-1 rounded border border-yellow-300 dark:border-yellow-700" contenteditable="true">æ–°è¦ç‚¹ï¼ˆç‚¹å‡»ç¼–è¾‘ï¼‰</span>
        <button onclick="removeBulletPoint('${notesId}', ${sectionIdx}, ${newPointIdx})" class="delete-point-btn opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity p-1">
            <span class="material-symbols-outlined text-sm">delete</span>
        </button>
    `;
    
    bulletList.appendChild(newPoint);
    
    const editableSpan = newPoint.querySelector('.bullet-point');
    editableSpan.focus();
    
    const range = document.createRange();
    range.selectNodeContents(editableSpan);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    console.log('â• æ·»åŠ æ–°è¦ç‚¹');
}

// åˆ é™¤è¦ç‚¹
function removeBulletPoint(notesId, sectionIdx, pointIdx) {
    const container = document.getElementById(`notes_${notesId}`);
    if (!container) return;
    
    const section = container.querySelector(`[data-section-id="${sectionIdx}"]`);
    if (!section) return;
    
    const point = section.querySelector(`[data-point-id="${pointIdx}"]`);
    if (!point) return;
    
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¦ç‚¹å—ï¼Ÿ')) {
        point.remove();
        console.log('ğŸ—‘ï¸ åˆ é™¤è¦ç‚¹');
    }
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ============= Learning HistoryåŠŸèƒ½ =============

// å†å²è®°å½•çŠ¶æ€
let historyData = {
  artifacts: [],
  filteredArtifacts: [],
  currentFilter: 'all',
  searchTerm: '',
  page: 1,
  hasMore: true,
  isLoading: false
};

// åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
function initHistory() {
  const historyPanel = document.getElementById('historyPanel');
  const historyOverlay = document.getElementById('historyOverlay');
  const historyToggleBtn = document.getElementById('historyToggleBtn');
  const historyCloseBtn = document.getElementById('historyCloseBtn');
  const historySearch = document.getElementById('historySearch');
  
  // æ‰“å¼€é¢æ¿
  historyToggleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openHistoryPanel();
  });
  
  // å…³é—­é¢æ¿
  historyCloseBtn.addEventListener('click', closeHistoryPanel);
  historyOverlay.addEventListener('click', closeHistoryPanel);
  
  // æœç´¢
  historySearch.addEventListener('input', (e) => {
    historyData.searchTerm = e.target.value.toLowerCase();
    filterAndRenderHistory();
  });
  
  // ç­›é€‰æŒ‰é’®
  document.querySelectorAll('#historyPanel .filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('#historyPanel .filter-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      historyData.currentFilter = e.target.dataset.type;
      filterAndRenderHistory();
    });
  });
  
  console.log('âœ… History initialized');
}

// æ‰“å¼€å†å²è®°å½•é¢æ¿
async function openHistoryPanel() {
  const historyPanel = document.getElementById('historyPanel');
  const historyOverlay = document.getElementById('historyOverlay');
  
  historyPanel.classList.add('open');
  historyOverlay.classList.add('active');
  
  // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡æ•°æ®ï¼Œåˆ™åŠ è½½
  if (historyData.artifacts.length === 0 && !historyData.isLoading) {
    await loadHistory();
  }
}

// å…³é—­å†å²è®°å½•é¢æ¿
function closeHistoryPanel() {
  const historyPanel = document.getElementById('historyPanel');
  const historyOverlay = document.getElementById('historyOverlay');
  
  historyPanel.classList.remove('open');
  historyOverlay.classList.remove('active');
}

// åŠ è½½å†å²è®°å½•
async function loadHistory() {
  if (historyData.isLoading || !historyData.hasMore) return;
  
  historyData.isLoading = true;
  
  try {
    const response = await fetch(
      `${API_BASE}/api/sessions/${SESSION_ID}/artifacts?page=${historyData.page}&limit=50`
    );
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // åˆå¹¶æ–°æ•°æ®
    historyData.artifacts = [...historyData.artifacts, ...data.artifacts];
    historyData.hasMore = data.has_more;
    historyData.page += 1;
    
    console.log(`ğŸ“š Loaded ${data.artifacts.length} artifacts, total: ${historyData.artifacts.length}`);
    
    filterAndRenderHistory();
  } catch (error) {
    console.error('âŒ Failed to load history:', error);
    showHistoryError('Failed to load history. Please try again.');
  } finally {
    historyData.isLoading = false;
  }
}

// ç­›é€‰å¹¶æ¸²æŸ“å†å²è®°å½•
function filterAndRenderHistory() {
  let filtered = historyData.artifacts;
  
  // æŒ‰ç±»å‹ç­›é€‰
  if (historyData.currentFilter !== 'all') {
    filtered = filtered.filter(item => item.artifact_type === historyData.currentFilter);
  }
  
  // æŒ‰æœç´¢è¯ç­›é€‰
  if (historyData.searchTerm) {
    filtered = filtered.filter(item => 
      item.topic.toLowerCase().includes(historyData.searchTerm) ||
      item.summary.toLowerCase().includes(historyData.searchTerm)
    );
  }
  
  historyData.filteredArtifacts = filtered;
  renderHistory();
}

// æ¸²æŸ“å†å²è®°å½•
function renderHistory() {
  const timeline = document.getElementById('historyTimeline');
  
  // ç©ºçŠ¶æ€
  if (historyData.artifacts.length === 0 && !historyData.isLoading) {
    timeline.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“š</div>
        <p class="text-lg font-medium mb-2">No Learning History Yet</p>
        <p class="text-sm opacity-70">Start learning to see your history here!</p>
      </div>
    `;
    return;
  }
  
  // æ— æœç´¢ç»“æœ
  if (historyData.filteredArtifacts.length === 0 && !historyData.isLoading) {
    timeline.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ”</div>
        <p class="text-lg font-medium mb-2">No Results Found</p>
        <p class="text-sm opacity-70">Try a different search term or filter</p>
      </div>
    `;
    return;
  }
  
  // æŒ‰æ—¥æœŸåˆ†ç»„
  const grouped = groupByDate(historyData.filteredArtifacts);
  
  // ç”Ÿæˆ HTML
  let html = '';
  for (const [label, items] of Object.entries(grouped)) {
    html += `
      <div class="date-group">
        <div class="date-label">${label}</div>
        <div class="history-items">
          ${items.map(item => renderHistoryItem(item)).join('')}
        </div>
      </div>
    `;
  }
  
  // åŠ è½½æ›´å¤šæŒ‰é’®
  if (historyData.hasMore && historyData.filteredArtifacts.length > 0) {
    html += `
      <div class="load-more">
        <button onclick="loadHistory()">Load More...</button>
      </div>
    `;
  }
  
  timeline.innerHTML = html;
}

// æ¸²æŸ“å•æ¡å†å²è®°å½•
function renderHistoryItem(item) {
  const icon = getArtifactIcon(item.artifact_type);
  const time = formatTime(item.timestamp);
  const count = getArtifactCount(item);
  
  return `
    <div class="history-item" onclick="viewArtifact('${item.id}')">
      <div class="item-icon">${icon}</div>
      <div class="item-content">
        <div class="item-title">${escapeHtml(item.topic)}</div>
        <div class="item-meta">
          <span class="item-time">${time}</span>
          ${count ? `<span class="item-count">${count}</span>` : ''}
        </div>
      </div>
    </div>
  `;
}

// æŸ¥çœ‹å†å²è®°å½•ï¼ˆå›æº¯ï¼‰
async function viewArtifact(artifactId) {
  try {
    console.log(`ğŸ“– Viewing artifact: ${artifactId}`);
    
    // ä»æœ¬åœ°æŸ¥æ‰¾
    const artifact = historyData.artifacts.find(a => a.id === artifactId);
    
    if (!artifact) {
      console.error('Artifact not found');
      return;
    }
    
    // å…³é—­å†å²é¢æ¿
    closeHistoryPanel();
    
    // åœ¨ Chat ä¸­æ·»åŠ å›æº¯æ ‡ç­¾
    const timestamp = formatDateTime(artifact.timestamp);
    addSystemMessage(`ğŸ”™ [å›æº¯] ${timestamp}`);
    
    // æ ¹æ®ç±»å‹æ¸²æŸ“å†…å®¹
    const messageData = {
      content_type: artifact.artifact_type,
      response_content: artifact.content
    };
    
    addAgentMessage(messageData);
    
    // æ·»åŠ æç¤º
    addSystemMessage('ğŸ’¡ ä½ å¯ä»¥åŸºäºæ­¤å†…å®¹ç»§ç»­å¯¹è¯ï¼Œä¾‹å¦‚ï¼š"å†å‡º3é“ç±»ä¼¼çš„é¢˜"');
    
    console.log('âœ… Artifact displayed');
    
  } catch (error) {
    console.error('âŒ Failed to view artifact:', error);
    addErrorMessage('Failed to load artifact. Please try again.');
  }
}

// æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
function addSystemMessage(text) {
  const messagesDiv = document.getElementById('chatMessages').querySelector('.flex.flex-col.gap-6');
  const systemMsg = `
    <div class="flex items-center justify-center my-4">
      <div class="px-4 py-2 rounded-full bg-primary/10 text-primary text-sm font-medium">
        ${text}
      </div>
    </div>
  `;
  messagesDiv.insertAdjacentHTML('beforeend', systemMsg);
  scrollToBottom();
}

// æ˜¾ç¤ºå†å²è®°å½•é”™è¯¯
function showHistoryError(message) {
  const timeline = document.getElementById('historyTimeline');
  timeline.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">âŒ</div>
      <p class="text-lg font-medium mb-2">Error</p>
      <p class="text-sm opacity-70">${message}</p>
    </div>
  `;
}

// ============= è¾…åŠ©å‡½æ•° =============

// æŒ‰æ—¥æœŸåˆ†ç»„
function groupByDate(artifacts) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today - 86400000);
  const thisWeek = new Date(today - 7 * 86400000);
  
  const groups = {
    'ğŸ“… ä»Šå¤©': [],
    'ğŸ“… æ˜¨å¤©': [],
    'ğŸ“… æœ¬å‘¨': [],
    'ğŸ“… æ›´æ—©': []
  };
  
  artifacts.forEach(item => {
    const date = new Date(item.timestamp);
    if (date >= today) {
      groups['ğŸ“… ä»Šå¤©'].push(item);
    } else if (date >= yesterday) {
      groups['ğŸ“… æ˜¨å¤©'].push(item);
    } else if (date >= thisWeek) {
      groups['ğŸ“… æœ¬å‘¨'].push(item);
    } else {
      groups['ğŸ“… æ›´æ—©'].push(item);
    }
  });
  
  // ç§»é™¤ç©ºåˆ†ç»„
  Object.keys(groups).forEach(key => {
    if (groups[key].length === 0) {
      delete groups[key];
    }
  });
  
  return groups;
}

// è·å– artifact å›¾æ ‡
function getArtifactIcon(type) {
  const icons = {
    'quiz_set': 'â“',
    'flashcard_set': 'ğŸ´',
    'notes': 'ğŸ“',
    'explanation': 'ğŸ’¡',
    'mindmap': 'ğŸ—ºï¸',
    'learning_bundle': 'ğŸ“¦'
  };
  return icons[type] || 'ğŸ“„';
}

// è·å– artifact æ•°é‡
function getArtifactCount(item) {
  if (item.artifact_type === 'quiz_set' && item.content.questions) {
    return `${item.content.questions.length} é¢˜`;
  } else if (item.artifact_type === 'flashcard_set' && item.content.cards) {
    return `${item.content.cards.length} å¡`;
  }
  return null;
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function formatDateTime(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleString('zh-CN');
}

// HTML è½¬ä¹‰
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============= LaTeXæ¸²æŸ“è¾…åŠ©å‡½æ•° =============
function renderMathInContent(element) {
    if (typeof renderMathInElement !== 'undefined') {
        try {
            renderMathInElement(element, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\[', right: '\\]', display: true},
                    {left: '\\(', right: '\\)', display: false}
                ],
                throwOnError: false
            });
        } catch (e) {
            console.warn('LaTeX rendering error:', e);
        }
    }
}

// ============= é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– =============
document.addEventListener('DOMContentLoaded', () => {
  initHistory();
  console.log('ğŸ‰ Page loaded and history initialized');
  
  // ğŸ†• åˆå§‹åŒ–KaTeXè‡ªåŠ¨æ¸²æŸ“
  if (typeof renderMathInElement !== 'undefined') {
      // ç›‘å¬DOMå˜åŒ–ï¼Œè‡ªåŠ¨æ¸²æŸ“LaTeX
      const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
              mutation.addedNodes.forEach((node) => {
                  if (node.nodeType === 1) { // Element node
                      // æ¸²æŸ“thinkingå†…å®¹
                      if (node.classList && node.classList.contains('thinking-content')) {
                          renderMathInContent(node);
                      }
                      // æ¸²æŸ“æ‰€æœ‰æ–°æ·»åŠ çš„å†…å®¹
                      const thinkingElements = node.querySelectorAll && node.querySelectorAll('.thinking-content, .prose');
                      if (thinkingElements) {
                          thinkingElements.forEach(el => renderMathInContent(el));
                      }
                  }
              });
          });
      });
      
      observer.observe(document.getElementById('chatMessages'), {
          childList: true,
          subtree: true
      });
  }
});

</script>
</body>
</html>

