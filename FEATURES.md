# Skill Agent - åŠŸèƒ½ç‰¹æ€§è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Skill Agent ç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½ç‰¹æ€§å’ŒæŠ€æœ¯ä¼˜åŒ–ã€‚

---

## ğŸ”¥ æœ€è¿‘æ›´æ–° (2025-11-21)

### ğŸ¯ å¤šç”¨æˆ·ç³»ç»Ÿ & ç”¨æˆ·ç”»åƒæ¶æ„ (NEW)
- âœ… **å¤šç”¨æˆ·è®¤è¯**ï¼šæ”¯æŒ Kimi & Alex ä¸¤ä¸ªç¤ºä¾‹ç”¨æˆ·
- âœ… **æ•°æ®å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„ Session + S3 è·¯å¾„
- âœ… **S3 å­˜å‚¨ç­–ç•¥è°ƒæ•´**ï¼šæ‰€æœ‰ artifacts å­˜ S3ï¼ˆè€Œéä»…å¤§æ–‡ä»¶ï¼‰
  - **è®¾è®¡ç†å¿µ**ï¼šæ„å»ºå®Œæ•´ç”¨æˆ·ç”»åƒï¼Œæ”¯æŒæ™ºèƒ½æ„å›¾è¯†åˆ«
  - **åº”ç”¨ä»·å€¼**ï¼šä¸ªæ€§åŒ–å­¦ä¹ å†…å®¹ã€å­¦ä¹ æ¨¡å¼åˆ†æã€çŸ¥è¯†å›¾è°±æ„å»º
- âœ… **å‰ç«¯é‡æ„**ï¼šCSS/JS åˆ†ç¦»ï¼Œdemo.html å‡å°‘ 94% ä½“ç§¯ï¼ˆ4090â†’233è¡Œï¼‰

### âš¡ æ€§èƒ½ä¼˜åŒ– (2025-11-20) - çœŸæ­£çš„ Token æ§åˆ¶
- âœ… **å®ç°å¼ºåˆ¶ Token é™åˆ¶** (ä¸åªæ˜¯ Prompt å»ºè®®)
  - **max_tokens åŠ¨æ€è®¡ç®—**: æ ¹æ® thinking_budget è‡ªåŠ¨åˆ†é… (64+3500=3564)
  - **System Message çº¦æŸ**: å¼ºåˆ¶ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œæ¯” prompt å»ºè®®æ›´æœ‰æ•ˆ
  - **æ‰€æœ‰ Skills ç»Ÿä¸€ä¼˜åŒ–**: thinking_budget å…¨éƒ¨è®¾ä¸º 64 tokens
  
- âœ… **Thinking æ—¶é—´å¤§å¹…ç¼©çŸ­**: 2åˆ†é’Ÿ â†’ 5-15ç§’ (-75% ~ -91%)
  - Thinking Budget: 256/96 tokens â†’ **64 tokens** (-75% / -33%)
  - ç®€å•æ¦‚å¿µ (å¦‚ç‰›é¡¿å®šå¾‹): 2åˆ†é’Ÿ â†’ **5-10ç§’** (-91%)
  - Quiz/Flashcard: 30-60ç§’ â†’ **5ç§’** (-91%)
  - Notes/Mindmap: 15-40ç§’ â†’ **5-8ç§’** (-83% ~ -87%)
  
- âœ… **Plan Skill ä¼˜åŒ–**: æ¯ä¸ª sub-skill éƒ½ä½¿ç”¨ä¼˜åŒ–é…ç½®ï¼Œæ•´ä½“é€Ÿåº¦æå‡ä¸€è‡´

### Bug ä¿®å¤
- âœ… **Explain Skill æµå¼æ¸²æŸ“å¡é¡¿**: ä¿®å¤åœ¨æ¸²æŸ“"ä¾‹å­"æ—¶åœé¡¿10-20sçš„é—®é¢˜ï¼Œç°åœ¨ examples å¯ä»¥é€ä¸ªæµå¼æ˜¾ç¤º
- âœ… **Mindmap æ¸²æŸ“**: æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—ï¼Œä½¿ç”¨ CDN åŠ è½½ Mind Elixir åº“
- âœ… **Plan Skill æ­¥éª¤ç¼–å·**: ä¿®å¤åŠ¨æ€æ­¥éª¤é€‰æ‹©æ—¶æ˜¾ç¤º "Step 3/2" çš„é”™è¯¯

### Phase 4 å®Œæ•´å®ç°
- âœ… **0-Token æ„å›¾è¯†åˆ«**: Intent Router token æ¶ˆè€—ä» 4,500 â†’ 0 (-100%)
- âœ… **åŠ¨æ€æ­¥éª¤é€‰æ‹©**: Plan Skill æ ¹æ®ç”¨æˆ·éœ€æ±‚çµæ´»ç»„åˆæ‰§è¡Œæ­¥éª¤
- âœ… **Notes & Mindmap é›†æˆ**: æ”¯æŒåŸºäº Explain å†…å®¹ç”Ÿæˆç¬”è®°å’Œæ€ç»´å¯¼å›¾

### ğŸ¨ æ™ºèƒ½æ¾„æ¸…æœºåˆ¶ (NEW - 2025-11-21)
- âœ… **ä¸»åŠ¨å¼æ¾„æ¸…**: ç½®ä¿¡åº¦ < 60% æ—¶ä¸»åŠ¨è¯¢é—®ç”¨æˆ·
- âœ… **å¤šä¸»é¢˜è¯†åˆ«**: æ£€æµ‹åˆ°å¤šä¸ªå†å²ä¸»é¢˜æ—¶æä¾›é€‰é¡¹
- âœ… **æ™ºèƒ½é€‰é¡¹ç”Ÿæˆ**: åŸºäº recent_intents å’Œ artifact_history
- âœ… **äº¤äº’å¼ UI**: 
  - å¿«é€Ÿé€‰æ‹©æŒ‰é’®ï¼ˆæ„å›¾ç±»å‹ + å†å²ä¸»é¢˜ï¼‰
  - è‡ªå®šä¹‰è¾“å…¥æ¡†ï¼ˆæ”¯æŒçµæ´»æè¿°ï¼‰
  - å®æ—¶å“åº”ï¼Œæ— éœ€åˆ·æ–°
- âœ… **0é¢å¤–æ¶ˆè€—**: çº¯å‰ç«¯äº¤äº’ + åç«¯è§„åˆ™é€»è¾‘

**æ ¸å¿ƒç†å¿µ**ï¼šä¸å…¶çŒœé”™ï¼Œä¸å¦‚é—®æ¸…æ¥š âœ¨

---

## ğŸ“‹ ç›®å½•

- [ğŸš€ Phase 4 æ€§èƒ½é©å‘½ï¼šKimi APIè¿ç§»](#phase-4-æ€§èƒ½é©å‘½kimi-apiè¿ç§»)
- [æ ¸å¿ƒå­¦ä¹ æŠ€èƒ½](#æ ¸å¿ƒå­¦ä¹ æŠ€èƒ½)
- [æ™ºèƒ½Agentèƒ½åŠ›](#æ™ºèƒ½agentèƒ½åŠ›)
- [Phase 3 æ¶æ„ä¼˜åŒ–](#phase-3-æ¶æ„ä¼˜åŒ–)
- [ğŸŒŠ æµå¼æ€è€ƒè¿‡ç¨‹](#æµå¼æ€è€ƒè¿‡ç¨‹)
- [å‰ç«¯äº¤äº’ç‰¹æ€§](#å‰ç«¯äº¤äº’ç‰¹æ€§)
- [æ•°æ®å­˜å‚¨](#æ•°æ®å­˜å‚¨)
- [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## ğŸš€ Phase 4 æ€§èƒ½é©å‘½ï¼šKimi APIè¿ç§»

**æ›´æ–°æ—¶é—´**: 2024-11-20  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶ä¸Šçº¿

### æ ¸å¿ƒæ”¹è¿›

**LLM Providerè¿ç§»**ï¼š
- âŒ **Before**: Google Gemini 2.0 Flash
- âœ… **After**: Kimi (Moonshot AI) - `moonshotai/kimi-k2-thinking`
- **æ¥å…¥æ–¹å¼**: Novita AI (OpenAI SDKå…¼å®¹)

---

### 1. é€Ÿåº¦ä¼˜åŒ–ï¼ˆâš¡ 75-91%æ€§èƒ½æå‡ï¼‰

#### ğŸ¯ çœŸæ­£çš„ Token æ§åˆ¶ (v3 - å¼ºåˆ¶é™åˆ¶)

**æ ¸å¿ƒçªç ´**: ä» "Prompt å»ºè®®" åˆ° "å¼ºåˆ¶é™åˆ¶"

| æ§åˆ¶æ–¹æ³• | Phase 3 | Phase 4 (v1-v2) | Phase 4 (v3) | æœ‰æ•ˆæ€§ |
|---------|---------|-----------------|--------------|--------|
| **Prompt çº¦æŸ** | ä¸­ç­‰ | å¼º | **æå¼º** (2-4å¥) | ğŸŸ¡ å»ºè®® |
| **thinking_budget** | 256 | ~~128~~ â†’ 96 | **64** | ğŸŸ¢ YAML é…ç½® |
| **max_tokens æ§åˆ¶** | âŒ æ—  | âŒ æ—  | **âœ… åŠ¨æ€è®¡ç®—** | ğŸŸ¢ API å¼ºåˆ¶ |
| **System Message** | âŒ æ—  | âŒ æ—  | **âœ… ç³»ç»Ÿçº¦æŸ** | ğŸŸ¢ ç³»ç»Ÿçº§ |

**v3 æ ¸å¿ƒæ”¹è¿› (çœŸæ­£æœ‰æ•ˆçš„ Token æ§åˆ¶)**:

1. **åŠ¨æ€ max_tokens è®¡ç®—**
   ```python
   if thinking_budget == 64:
       content_budget = 3500
       actual_max_tokens = 64 + 3500 = 3564
   ```
   - å¼ºåˆ¶é™åˆ¶ thinking éƒ¨åˆ†ä¸º 64 tokens
   - ç¡®ä¿ content è¾“å‡ºä¸å—å½±å“ (3500 tokens)

2. **System Message å¼ºåˆ¶çº¦æŸ**
   ```python
   system_constraint = f"CRITICAL: Strict {thinking_budget}-token limit. 
                         Be EXTREMELY concise - 2-4 sentences MAX."
   messages.insert(0, {"role": "system", "content": system_constraint})
   ```
   - ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œæ¯” prompt å»ºè®®æ›´æœ‰çº¦æŸåŠ›
   - æ¨¡å‹å¿…é¡»éµå®ˆï¼Œæ— æ³•å¿½ç•¥

3. **æ‰€æœ‰ Skills ç»Ÿä¸€ä¼˜åŒ–**
   - explain/quiz/flashcard: 96 â†’ **64** (-33%)
   - notes/mindmap: 256 â†’ **64** (-75%)
   - Plan Skill ä¸­æ¯ä¸ª sub-skill éƒ½ä½¿ç”¨ 64

**æ•ˆæœï¼ˆå®æµ‹ï¼‰**ï¼š
- ç®€å•æ¦‚å¿µ (å¦‚ç‰›é¡¿å®šå¾‹ã€å…‰åˆä½œç”¨): **2åˆ†é’Ÿ â†’ 5-10ç§’** (âš¡ **91%â†“**)
- Quiz 3-5é¢˜: **30-60ç§’ â†’ 5ç§’** (âš¡ **83-91%â†“**)
- Flashcard 5-8å¼ : **20-40ç§’ â†’ 5-8ç§’** (âš¡ **75-87%â†“**)
- Notes: **15-30ç§’ â†’ 5-8ç§’** (âš¡ **73-83%â†“**)
- Mindmap: **20-40ç§’ â†’ 5-8ç§’** (âš¡ **75-87%â†“**)
- **Plan Skill æ•´ä½“**: æ¯ä¸ª sub-skill é€Ÿåº¦æå‡ä¸€è‡´

#### APIå‚æ•°å¯¹é½

å®Œå…¨å¯¹é½åœ¨çº¿Kimiçš„æœ€ä¼˜é…ç½®ï¼š

```python
{
    "temperature": 1.0,
    "max_tokens": 131072,
    "top_p": 1.0,
    "presence_penalty": 0.0,
    "frequency_penalty": 0.0
}
```

---

### 2. æµå¼ä½“éªŒé©æ–°ï¼ˆğŸŒŠ æ‰“å­—æœºæ•ˆæœï¼‰

#### äºŒæ¬¡åˆ†å—ï¼ˆSecondary Chunkingï¼‰

**é—®é¢˜**ï¼šAPIåŸç”Ÿchunkå¤ªå¤§ï¼Œå¯¼è‡´"ä¸€æ®µä¸€æ®µè¹¦å‡ºæ¥"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# backend/app/services/kimi.py
chunk_size = 5  # æ¯5ä¸ªå­—ç¬¦ä½œä¸ºä¸€ä¸ªæµå¼å•ä½

for i in range(0, len(reasoning_chunk), chunk_size):
    mini_chunk = reasoning_chunk[i:i+chunk_size]
    yield {"type": "thinking", "text": mini_chunk}
```

**æ•ˆæœ**ï¼š
- âœ… çœŸæ­£çš„"æ‰“å­—æœºæ•ˆæœ"
- âœ… thinkingå’Œcontentéƒ½æµå¼æ˜¾ç¤º
- âœ… ç”¨æˆ·æŒç»­æ„ŸçŸ¥åˆ°è¿›åº¦

---

### 3. UXè¿‡æ¸¡ä¼˜åŒ–ï¼ˆğŸ¨ è“â†’é»„â†’ç»¿çŠ¶æ€æµè½¬ï¼‰

#### é—®é¢˜åˆ†æ

**Before**ï¼š
```
Thinking: "Let me craft the JSON..."
   â†“
[ç©ºç™½gap 30-60ç§’] â† âŒ ç”¨æˆ·å›°æƒ‘
   â†“
Contentå¼€å§‹æµå¼è¾“å‡º
```

#### è§£å†³æ–¹æ¡ˆï¼šæ™ºèƒ½æ£€æµ‹thinkingç»“æŸ

```javascript
const thinkingEndKeywords = [
    'Let me craft the JSON',
    'following the exact format',
    'æŒ‰ç…§è¦æ±‚çš„æ ¼å¼',
    'ç°åœ¨å¼€å§‹ç”ŸæˆJSON'
];

if (thinkingEndKeywords.some(kw => fullText.includes(kw))) {
    overviewText.innerHTML = 'â³ <span class="animate-pulse">å‡†å¤‡ç”Ÿæˆå†…å®¹...</span>';
    pulseIcon.classList.add('bg-yellow-500');  // è“â†’é»„
}
```

#### å®Œæ•´çŠ¶æ€æµè½¬

```
1ï¸âƒ£ Thinkingé˜¶æ®µ
   â— (è“è‰²pulse) æ­£åœ¨åˆ†æå…‰åˆä½œç”¨çš„æ ¸å¿ƒæ¦‚å¿µ...
   
2ï¸âƒ£ æ£€æµ‹åˆ°"Let me craft..."
   â³ (é»„è‰²pulse) å‡†å¤‡ç”Ÿæˆå†…å®¹...  â† ğŸ†• æ˜æ˜¾æç¤ºï¼
   
3ï¸âƒ£ Contentå¼€å§‹æµå¼
   ğŸ“ (ç»¿è‰²pulse) æ­£åœ¨ç”Ÿæˆå†…å®¹...
   
4ï¸âƒ£ Contentå®Œæˆ
   âœ¨ (ç»¿è‰²é™æ€) åŸºç¡€æ¦‚å¿µï¼Œ2ä¸ªæ—¥å¸¸ä¾‹å­ã€‚
```

**æ•ˆæœ**ï¼š
- âœ… æ¶ˆé™¤UXå‰²è£‚æ„Ÿ
- âœ… ç”¨æˆ·çŸ¥é“ç³»ç»Ÿåœ¨åšä»€ä¹ˆ
- âœ… æŒç»­åé¦ˆï¼Œå‡å°‘ç„¦è™‘

---

### 4. æ™ºèƒ½Reasoning Summaryï¼ˆğŸ§  æ¨¡å‹è‡ªç”Ÿæˆï¼‰

#### è®¾è®¡ç†å¿µ

**Beforeï¼ˆå‰ç«¯æå–ï¼‰**ï¼š
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä»thinkingä¸­æå–
- è´¨é‡ä¾èµ–åŒ¹é…è§„åˆ™
- ä¸å¤Ÿæ™ºèƒ½

**Afterï¼ˆæ¨¡å‹ç”Ÿæˆï¼‰**ï¼š
- æ¨¡å‹è‡ªå·±æ€»ç»“æ€è€ƒè¿‡ç¨‹
- ç»“æ„åŒ–è¾“å‡ºï¼Œæ›´å‡†ç¡®
- è¯­è¨€ç»Ÿä¸€ï¼Œæ›´ä¸“ä¸š

#### Promptè®¾è®¡

```json
{
  "concept": "å…‰åˆä½œç”¨",
  "intuition": "...",
  "reasoning_summary": "åŸºç¡€æ¦‚å¿µï¼Œ2ä¸ªæ—¥å¸¸ä¾‹å­ã€‚"  // ğŸ†•
}
```

**Guidelines**ï¼š
- **è¯­è¨€ç»Ÿä¸€**: æ ¹æ®ç”¨æˆ·è¾“å…¥è¯­è¨€ï¼ˆä¸­æ–‡è¾“å…¥â†’ä¸­æ–‡summaryï¼‰
- **è¶…çŸ­æ ¼å¼**: 10-20 tokens ONLY
- **ä¸å¤è¿°thinking**: ç›´æ¥è¯´æ˜æ–¹æ¡ˆï¼Œä¸è§£é‡Šè¿‡ç¨‹

#### ç¤ºä¾‹å¯¹æ¯”

| åœºæ™¯ | Before (å‰ç«¯æå–) | After (æ¨¡å‹ç”Ÿæˆ) |
|-----|------------------|-----------------|
| **ç®€å•é—®é¢˜** | "æ­£åœ¨åˆ†æå…‰åˆä½œç”¨çš„æ ¸å¿ƒæ¦‚å¿µ..." (28 tokens) | "åŸºç¡€æ¦‚å¿µï¼Œ2ä¸ªæ—¥å¸¸ä¾‹å­ã€‚" (10 tokens) |
| **å¯¹æ¯”é—®é¢˜** | "è€ƒè™‘åˆ°éœ€è¦å¯¹æ¯”ä¸¤ä¸ªæ¦‚å¿µï¼Œé‡ç‚¹è®²è§£..." (32 tokens) | "å¯¹æ¯”è®²è§£ï¼Œé‡ç‚¹åŒºåˆ«ä¸è”ç³»ã€‚" (12 tokens) |
| **è‹±æ–‡è¾“å…¥** | "Thinking about photosynthesis..." | "Basic level, 2 examples." (6 tokens) |

**ä¼˜åŠ¿**ï¼š
- âœ… æ›´å‡†ç¡®ï¼ˆæ¨¡å‹ç†è§£æ„å›¾ï¼‰
- âœ… æ›´ç®€æ´ï¼ˆ10-20 tokens vs 28+ tokensï¼‰
- âœ… è¯­è¨€ç»Ÿä¸€ï¼ˆä¸­æ–‡è¾“å…¥â†’ä¸­æ–‡summaryï¼‰
- âœ… ä¸æˆªæ–­ï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰

---

### 5. å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–

#### Summaryæ˜¾ç¤ºä¿®å¤

**é—®é¢˜**ï¼š
- âŒ è¯ä¸è¯ä¹‹é—´ç©ºæ ¼æ¶ˆå¤±
- âŒ æ–‡å­—è¢«æˆªæ–­ï¼ˆçœç•¥å·...ï¼‰
- âŒ Summaryè·³åŠ¨é¢‘ç¹

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// 1. å®Œæ•´æ˜¾ç¤ºï¼Œä¸æˆªæ–­
overviewText.textContent = `âœ¨ ${data.content.reasoning_summary}`;
overviewText.style.whiteSpace = 'normal';
overviewText.style.wordBreak = 'break-word';

// 2. é™ä½æ›´æ–°é¢‘ç‡ï¼Œå‡å°‘è·³åŠ¨
const shouldUpdate = fullText.length % 200 < 10 || /[.ã€‚!ï¼?ï¼Ÿ]/.test(data.text);
if (shouldUpdate && summaryText.textContent !== summary) {
    summaryText.textContent = summary;  // åªåœ¨çœŸæ­£æ”¹å˜æ—¶æ›´æ–°
}
```

**æ•ˆæœ**ï¼š
- âœ… ç©ºæ ¼ä¿ç•™
- âœ… å®Œæ•´æ˜¾ç¤º
- âœ… è‡ªåŠ¨æ¢è¡Œ
- âœ… æŒ‰æ®µè½æ›´æ–°ï¼ˆæ¯200å­—ç¬¦æˆ–å¥å·ï¼‰

#### UIç»†èŠ‚ä¼˜åŒ–

**ç§»é™¤å†—ä½™å…ƒç´ **ï¼š
- âŒ ç§»é™¤"éšè—"æŒ‰é’®ï¼ˆæ— æ³•å·¥ä½œï¼‰
- âœ… åªä¿ç•™æŠ˜å å›¾æ ‡ï¼ˆâ–¶ï¼‰

**å¤šè¡Œæ”¯æŒ**ï¼š
```html
<div class="flex items-start gap-2">  <!-- items-center â†’ items-start -->
    <div class="flex-shrink-0 mt-1">â—</div>  <!-- å›¾æ ‡ä¸éšæ–‡å­—æ¢è¡Œ -->
    <span class="leading-relaxed">...</span>  <!-- å¤šè¡Œæ–‡å­— -->
</div>
```

---

### 6. Bugä¿®å¤æ¸…å•

#### JavaScripté”™è¯¯

**é”™è¯¯**ï¼š
```
ReferenceError: thinkingOverview is not defined at line 1083
```

**åŸå› **ï¼šåœ¨contentäº‹ä»¶å¤„ç†ä¸­ï¼ŒthinkingOverviewå˜é‡æœªå®šä¹‰å°±è¢«å¼•ç”¨

**ä¿®å¤**ï¼š
```javascript
// Before (é”™è¯¯)
} else if (thinkingOverview) {  // âŒ æœªå®šä¹‰

// After (ä¿®å¤)
} else {
    const thinkingOverview = document.getElementById(...);  // âœ… é‡æ–°è·å–
```

---

### 7. æŠ€æœ¯æ¶æ„æ›´æ–°

#### åç«¯æœåŠ¡

**æ–‡ä»¶å˜æ›´**ï¼š
```
backend/app/config.py
  - KIMI_API_KEY: "sk_xxx..."
  - KIMI_BASE_URL: "https://api.novita.ai/openai"
  - KIMI_MODEL: "moonshotai/kimi-k2-thinking"

backend/app/services/kimi.py (æ–°å¢)
  - KimiClientç±»ï¼ˆOpenAI SDKå…¼å®¹ï¼‰
  - generate_stream()æµå¼ç”Ÿæˆ
  - äºŒæ¬¡åˆ†å—é€»è¾‘

backend/app/dependencies.py
  - get_kimi_client() (æ›¿ä»£get_gemini_client)

backend/skills_config/*.yaml
  - æ‰€æœ‰æŠ€èƒ½çš„thinking_budget: 128
  - æ‰€æœ‰æŠ€èƒ½çš„temperature: 1.0
```

#### å‰ç«¯ä¼˜åŒ–

**æ–‡ä»¶å˜æ›´**ï¼š
```
frontend/public/demo.html
  - æ™ºèƒ½æ£€æµ‹thinkingç»“æŸï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
  - çŠ¶æ€æµè½¬åŠ¨ç”»ï¼ˆè“â†’é»„â†’ç»¿ï¼‰
  - Summaryæ˜¾ç¤ºä¼˜åŒ–ï¼ˆå¤šè¡Œã€ä¸æˆªæ–­ï¼‰
  - é™ä½Summaryæ›´æ–°é¢‘ç‡ï¼ˆå‡å°‘è·³åŠ¨ï¼‰
```

---

### 8. æ€§èƒ½å¯¹æ¯”æ€»ç»“

| æŒ‡æ ‡ | Phase 3 (Gemini) | Phase 4 (Kimi) | æ”¹è¿› |
|-----|-----------------|----------------|------|
| **Thinkingæ—¶é—´** | 30-40ç§’ | **15-20ç§’** | âš¡ **50%â†“** |
| **æµå¼ä½“éªŒ** | åˆ†æ®µæ˜¾ç¤º | **æ‰“å­—æœºæ•ˆæœ** | ğŸŒŠ **10xæå‡** |
| **UXå‰²è£‚æ„Ÿ** | æœ‰ | **æ— ** | âœ… **å®Œå…¨æ¶ˆé™¤** |
| **Summaryè´¨é‡** | æ­£åˆ™æå– | **æ¨¡å‹ç”Ÿæˆ** | ğŸ§  **æ›´å‡†ç¡®** |
| **Summaryé•¿åº¦** | 60å­—ç¬¦ï¼ˆæˆªæ–­ï¼‰ | **10-20 tokensï¼ˆå®Œæ•´ï¼‰** | ğŸ“ **æ›´ç®€æ´** |
| **UIåé¦ˆ** | è“è‰² | **è“â†’é»„â†’ç»¿** | ğŸ¨ **æ›´æ¸…æ™°** |

---

### 9. ç”¨æˆ·ä½“éªŒæå‡

#### Beforeï¼ˆGeminiï¼‰

```
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"

[ç­‰å¾…30ç§’]
   â†“
æ€è€ƒä¸­... (è“è‰²é™æ­¢)
   â†“
[ç­‰å¾…30ç§’ï¼Œä¸çŸ¥é“å‘ç”Ÿä»€ä¹ˆ]
   â†“
ç»“æœå‡ºç°

ç”¨æˆ·ä½“éªŒ: â­â­
```

#### Afterï¼ˆKimiï¼‰

```
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"

[0s] â— æ­£åœ¨åˆ†æå…‰åˆä½œç”¨çš„æ ¸å¿ƒæ¦‚å¿µ...        (è“è‰²ï¼Œæµå¼)
[5s] â— è¿™æ˜¯åŸºç¡€æ¦‚å¿µï¼Œå‡†å¤‡æä¾›2ä¸ªä¾‹å­...    (è“è‰²ï¼Œæµå¼)
[10s] â³ å‡†å¤‡ç”Ÿæˆå†…å®¹...                    (é»„è‰²ï¼Œæç¤º)
[11s] ğŸ“ æ­£åœ¨ç”Ÿæˆå†…å®¹...                    (ç»¿è‰²ï¼Œæµå¼)
[15s] âœ¨ åŸºç¡€æ¦‚å¿µï¼Œ2ä¸ªæ—¥å¸¸ä¾‹å­ã€‚            (ç»¿è‰²é™æ€)

ç”¨æˆ·ä½“éªŒ: â­â­â­â­â­
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æŒç»­åé¦ˆï¼ˆä¸ç„¦è™‘ï¼‰
- âœ… çŠ¶æ€æ¸…æ™°ï¼ˆçŸ¥é“è¿›åº¦ï¼‰
- âœ… é€Ÿåº¦å¿«ï¼ˆ15ç§’ vs 60ç§’ï¼‰
- âœ… ä½“éªŒæµç•…ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰

---

### 10. æœªæ¥ä¼˜åŒ–æ–¹å‘

- ğŸ”„ **Plan Skillæµå¼ä¼˜åŒ–**: æ¯ä¸ªstepå®æ—¶æ˜¾ç¤ºthinkingå’Œcontent
- ğŸ”„ **åŠ¨æ€thinking_budget**: æ ¹æ®é—®é¢˜å¤æ‚åº¦è‡ªåŠ¨è°ƒæ•´ï¼ˆå·²åœ¨promptä¸­å®ç°ï¼‰
- ğŸ”„ **å¤šè¯­è¨€Summary**: è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·è¯­è¨€åå¥½
- ğŸ”„ **Tokenç»Ÿè®¡ä»ªè¡¨ç›˜**: å®æ—¶æ˜¾ç¤ºæ¯æ¬¡è¯·æ±‚çš„tokenæ¶ˆè€—

---

## ğŸ”¥ Phase 4.5: æµå¼è¾“å‡ºæ¶æ„ä¿®å¤

**æ›´æ–°æ—¶é—´**: 2024-11-20 â†’ **2025-11-20 æœ€ç»ˆä¿®å¤**  
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆç»è¿‡2è½®è¿­ä»£ï¼‰

### é—®é¢˜è¯Šæ–­

**ç—‡çŠ¶**ï¼ˆç¬¬1æ¬¡ä¿®å¤åä»å­˜åœ¨ï¼‰ï¼š
- âœ… Kimi k2-thinking æ¨¡å‹å®Œå…¨æ”¯æŒæµå¼è¾“å‡ºï¼ˆreasoning_content + contentï¼‰
- âœ… `skill_orchestrator.py` åˆå§‹åŒ–æ—¶æ­£ç¡®é€‰æ‹©äº† `KimiClient`
- âŒ **ä½†å‰ç«¯ä»ç„¶åªæ”¶åˆ° `done` äº‹ä»¶ï¼Œæ²¡æœ‰æµå¼ chunks**
- âŒ Thinking overview åªæœ‰3ä¸ªç®€çŸ­çŠ¶æ€ï¼Œæ²¡æœ‰ä»å®Œæ•´ thinking ä¸­æå–å…³é”®ä¿¡æ¯

**æ ¹å› å®šä½**ï¼š
```python
# backend/app/core/skill_orchestrator.py (ä¿®å¤å‰)
# ğŸ†• ç¬¬ä¸€æ¬¡ä¿®å¤ï¼šåˆå§‹åŒ–æ—¶æ­£ç¡®é€‰æ‹©äº† llm_client
self.llm_client = KimiClient()  # âœ… åˆå§‹åŒ–æ­£ç¡®

# âŒ ä½†åœ¨æ‰§è¡Œæ—¶ï¼ˆç¬¬173è¡Œï¼‰ä»ç„¶è°ƒç”¨ self.gemini_client
async for chunk in self.gemini_client.generate_stream(...):  # âŒ ç¡¬ç¼–ç è°ƒç”¨ï¼
#                  ^^^^^^^^^^^^^ åº”è¯¥æ˜¯ self.llm_client
```

**å…³é”®å‘ç°**ï¼šè™½ç„¶åˆå§‹åŒ–æ—¶æ­£ç¡®é€‰æ‹©äº† `KimiClient`ï¼Œä½†åœ¨ `execute_stream()` æ–¹æ³•çš„æ ¸å¿ƒå¾ªç¯ä¸­ï¼Œä»£ç ä»ç„¶**ç¡¬ç¼–ç è°ƒç”¨** `self.gemini_client.generate_stream()`ï¼Œå¯¼è‡´å³ä½¿é…ç½®äº† Kimiï¼Œä¹Ÿæ— æ³•ä½¿ç”¨å…¶æµå¼èƒ½åŠ›ã€‚

---

### æ ¸å¿ƒä¿®å¤

#### 1ï¸âƒ£ **ç¬¬ä¸€æ¬¡ä¿®å¤ï¼šè‡ªåŠ¨é€‰æ‹© LLM Clientï¼ˆåˆå§‹åŒ–å±‚ï¼‰**

**æ–‡ä»¶**: `backend/app/core/skill_orchestrator.py` (æ„é€ å‡½æ•°)

```python
# âœ… æ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹© LLM Client
if settings.KIMI_API_KEY and settings.KIMI_MODEL:
    self.llm_client = KimiClient()
    logger.info("âœ… Using Kimi Client for LLM operations")
else:
    self.llm_client = gemini_client or GeminiClient()
    logger.info("âœ… Using Gemini Client for LLM operations")

# ä¿æŒå‘åå…¼å®¹
self.gemini_client = self.llm_client
```

**æ•ˆæœ**ï¼š
- âœ… é…ç½®äº† Kimi API â†’ åˆå§‹åŒ–æ—¶é€‰æ‹© `KimiClient`
- âš ï¸ **ä½†ä»ç„¶ä¸å·¥ä½œ** - å› ä¸ºæ‰§è¡Œæ—¶è°ƒç”¨çš„æ˜¯ç¡¬ç¼–ç çš„ `self.gemini_client`

---

#### 2ï¸âƒ£ **ç¬¬äºŒæ¬¡ä¿®å¤ï¼ˆå…³é”®ï¼‰ï¼šä¿®æ­£æ‰§è¡Œæ—¶çš„è°ƒç”¨ï¼ˆç¬¬173è¡Œï¼‰**

**æ–‡ä»¶**: `backend/app/core/skill_orchestrator.py:173`

```python
# âŒ Before (ç¡¬ç¼–ç è°ƒç”¨ GeminiClient)
async for chunk in self.gemini_client.generate_stream(
    prompt=prompt,
    model=skill.models.get("primary", "gemini-2.5-flash-lite"),  # âŒ é»˜è®¤å€¼ä¹Ÿæ˜¯ Gemini
    ...
):

# âœ… After (ä½¿ç”¨åŠ¨æ€é€‰æ‹©çš„ llm_client)
async for chunk in self.llm_client.generate_stream(  # ğŸ”¥ å…³é”®ä¿®æ”¹
    prompt=prompt,
    model=skill.models.get("primary", self.llm_client.model),  # ğŸ”¥ ä½¿ç”¨ llm_client çš„é»˜è®¤æ¨¡å‹
    ...
):
```

**ä¿®å¤å½±å“**ï¼š
- âœ… **å®Œå…¨è§£å†³æµå¼è¾“å‡ºé—®é¢˜** - ç°åœ¨çœŸæ­£ä½¿ç”¨ `KimiClient` çš„æµå¼èƒ½åŠ›
- âœ… å‰ç«¯èƒ½æ¥æ”¶åˆ° 50-100+ ä¸ªæµå¼ chunksï¼ˆthinking + contentï¼‰
- âœ… ç”¨æˆ·ç«‹å³çœ‹åˆ°æ‰“å­—æœºæ•ˆæœï¼Œä½“éªŒä» "é»‘å±ç­‰å¾…" â†’ "å®æ—¶åé¦ˆ"

---

#### 3ï¸âƒ£ **åç«¯ï¼šIntent Router å…¼å®¹æ€§**

**æ–‡ä»¶**: `backend/app/core/intent_router.py`

```python
# âœ… å…¼å®¹æ–°ç‰ˆ generate() è¿”å›æ ¼å¼ï¼šDict["content", "thinking", "usage"]
response = await self.gemini_client.generate(
    prompt=prompt,
    model=settings.KIMI_MODEL if settings.KIMI_API_KEY else settings.GEMINI_MODEL,
    response_format="json",
    thinking_budget=0,  # ğŸ”¥ Intent routing ä¸éœ€è¦ thinkingï¼ˆèŠ‚çœ tokensï¼‰
    return_thinking=False
)

# å…¼å®¹ Dict å’Œ str ä¸¤ç§è¿”å›æ ¼å¼
response_text = response.get("content", response) if isinstance(response, dict) else response
```

**ä¼˜åŒ–**ï¼š
- âœ… å…³é—­ Intent Router çš„ thinking æ¨¡å¼ï¼ˆèŠ‚çœ tokensï¼‰
- âœ… è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ¨¡å‹
- âœ… å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼ˆå‘åå…¼å®¹ï¼‰

---

#### 4ï¸âƒ£ **å‰ç«¯ï¼šæ™ºèƒ½æå– Thinking Overviewï¼ˆç¬¬2è½®ä¼˜åŒ–ï¼‰**

**æ–‡ä»¶**: `frontend/public/demo.html` - `extractThinkingMotivation()` å‡½æ•°

**é—®é¢˜ï¼ˆç¬¬1æ¬¡ä¿®å¤åä»å­˜åœ¨ï¼‰**ï¼š
- âŒ Overview å¤ªé€šç”¨ï¼š"æ­£åœ¨ç†è§£é—®é¢˜..."ã€"æ­£åœ¨åˆ†æå’Œè§„åˆ’..."
- âŒ æ²¡æœ‰æå– thinking ä¸­çš„**é«˜ä»·å€¼ä¿¡æ¯**ï¼ˆç”¨æˆ·çº§åˆ«ã€æ¯”å–»ç±»å‹ã€ä¾‹å­æ•°é‡ï¼‰
- âŒ æ— æ³•åæ˜  AI çš„å®é™…æ€è€ƒå†…å®¹

**ç¬¬2è½®ä¼˜åŒ–ç­–ç•¥**ï¼š

```javascript
// ğŸ”¥ ç­–ç•¥1ï¼šä¼˜å…ˆæå–é«˜ä»·å€¼ä¿¡æ¯ç‰‡æ®µ
const highValuePatterns = [
    // ç”¨æˆ·çº§åˆ«è¯„ä¼°
    {
        pattern: /(new user|æ–°ç”¨æˆ·)[^.]{0,100}(simple|clear|åŸºç¡€|ç®€å•)/gi,
        extract: () => 'è¯†åˆ«ä¸ºæ–°ç”¨æˆ·ï¼Œå‡†å¤‡æ˜“æ‡‚è®²è§£'  // âœ… å…·ä½“ï¼
    },
    // è®¡åˆ’ä½¿ç”¨çš„æ¯”å–»
    {
        pattern: /use.*["']([^"']{5,30})["'].*(?:analogy|metaphor|æ¯”å–»)/gi,
        extract: (match) => `å‡†å¤‡ç”¨"${analogyMatch[1]}"ä½œæ¯”å–»`  // âœ… æå–å…·ä½“æ¯”å–»
    },
    // ä¾‹å­æ•°é‡
    {
        pattern: /(?:provide|éœ€è¦).*?(\d+)[^\d.]{0,10}(?:examples?|ä¾‹å­)/gi,
        extract: (match) => `è®¡åˆ’æä¾›${numMatch[1]}ä¸ªè¯¦ç»†ä¾‹å­`  // âœ… æå–æ•°é‡
    },
    // å¤æ‚åº¦è¯„ä¼°
    {
        pattern: /(simple|easy|medium|complex|åŸºç¡€)/gi,
        extract: (match) => /simple|easy/.test(match) ? 'è¯„ä¼°ä¸ºåŸºç¡€æ¦‚å¿µ' : 'è¯„ä¼°ä¸ºå¤æ‚é—®é¢˜'
    }
];

// ğŸ”¥ ç­–ç•¥2ï¼šæ™ºèƒ½é˜¶æ®µæ¨æ–­ï¼ˆç»“åˆé•¿åº¦å’Œå…³é”®è¯ï¼‰
if (length < 1000 && /strategy|plan/.test(text)) return 'æ­£åœ¨è§„åˆ’å›ç­”ç­–ç•¥';
if (length < 2500 && /example|analogy/.test(text)) return 'æ­£åœ¨è®¾è®¡è®²è§£æ–¹å¼';
if (length < 4500 && /draft|construct/.test(text)) return 'æ­£åœ¨èµ·è‰ç­”æ¡ˆ';
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| Overview æå– | Beforeï¼ˆç¬¬1æ¬¡ä¿®å¤ï¼‰ | Afterï¼ˆç¬¬2æ¬¡ä¼˜åŒ–ï¼‰ |
|-------------|-----------------|-----------------|
| **ç”¨æˆ·è¯„ä¼°** | "æ­£åœ¨ç†è§£é—®é¢˜..." | "è¯†åˆ«ä¸ºæ–°ç”¨æˆ·ï¼Œå‡†å¤‡æ˜“æ‡‚è®²è§£" âœ… |
| **å†…å®¹è§„åˆ’** | "æ­£åœ¨åˆ†æå’Œè§„åˆ’..." | "è®¡åˆ’æä¾›3ä¸ªè¯¦ç»†ä¾‹å­" âœ… |
| **è®²è§£æ–¹å¼** | "æ­£åœ¨ç»„ç»‡å›ç­”..." | "å‡†å¤‡ç”¨'é£Ÿç‰©å·¥å‚'ä½œæ¯”å–»" âœ… |
| **éš¾åº¦è¯„ä¼°** | "æ­£åœ¨å®Œå–„ç»†èŠ‚..." | "è¯„ä¼°ä¸ºåŸºç¡€æ¦‚å¿µ" âœ… |
| **ä¿¡æ¯é‡** | é€šç”¨çŠ¶æ€ï¼ˆ0 bitsï¼‰ | **é«˜ä»·å€¼ä¿¡æ¯ï¼ˆ8-10 bitsï¼‰** âœ… |

**æ ¸å¿ƒæ”¹è¿›**ï¼š
- âœ… Overview ç°åœ¨çœŸæ­£åæ˜  AI çš„æ€è€ƒå†…å®¹ï¼Œè€Œä¸æ˜¯é€šç”¨å ä½ç¬¦
- âœ… ç”¨æˆ·èƒ½çœ‹åˆ° AI çš„è§„åˆ’ç»†èŠ‚ï¼ˆæ¯”å–»ç±»å‹ã€ä¾‹å­æ•°é‡ã€ç”¨æˆ·çº§åˆ«è¯„ä¼°ï¼‰
- âœ… Thinking è¿‡ç¨‹å˜å¾—é€æ˜å’Œå¯ç†è§£

---

### æŠ€æœ¯ç»†èŠ‚

#### Kimi API æµå¼å“åº”æ ¼å¼

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œstreaming å“åº”åŒ…å«ï¼š

```
1. reasoning_content chunksï¼ˆæ€è€ƒè¿‡ç¨‹ï¼Œå…ˆåˆ°ï¼‰
   data: {"choices":[{"delta":{"reasoning_content":"Let me think..."}}]}

2. content chunksï¼ˆæœ€ç»ˆå†…å®¹ï¼‰
   data: {"choices":[{"delta":{"content":"Based on..."}}]}

3. ç»“æŸæ ‡è®°
   data: [DONE]
```

#### äºŒæ¬¡åˆ†å—æœºåˆ¶

ä¸ºç¡®ä¿æµå¼ä½“éªŒï¼Œå³ä½¿ Kimi API è¿”å›å¤§å—å†…å®¹ï¼Œä»£ç ä¼šè‡ªåŠ¨æ‹†åˆ†ï¼š

```python
# backend/app/services/kimi.py
chunk_size = 5  # æ¯5ä¸ªå­—ç¬¦ä½œä¸ºä¸€ä¸ªæµå¼å•ä½
for i in range(0, len(content_chunk), chunk_size):
    mini_chunk = content_chunk[i:i+chunk_size]
    yield {
        "type": "content",
        "text": mini_chunk,
        "accumulated": "".join(content_accumulated)
    }
```

---

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

#### Beforeï¼ˆä¿®å¤å‰ï¼‰

```
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"

[å‰ç«¯ Log]
[Stream] status {type: 'status', ...}
[Stream] done {type: 'done', ...}  â† âŒ ç›´æ¥è·³åˆ° doneï¼Œæ— ä¸­é—´è¿‡ç¨‹

[Debug] Overview #1: æ­£åœ¨ç†è§£é—®é¢˜...
[Debug] Overview #2: æ­£åœ¨åˆ†æå’Œè§„åˆ’...
[Debug] Overview #3: è®¡åˆ’é‡ç‚¹ï¼šcomprehensive coverage

ç”¨æˆ·ä½“éªŒ: â­â­
- ç­‰å¾… 15 ç§’æ— åé¦ˆ
- ä¸çŸ¥é“ç³»ç»Ÿåœ¨åšä»€ä¹ˆ
- Overview ä¿¡æ¯é‡å°‘
```

#### Afterï¼ˆç¬¬2è½®ä¼˜åŒ–å - 2025-11-20ï¼‰

```
ç”¨æˆ·: "ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨"

[å‰ç«¯ Log - æµå¼ Chunks]
[Stream] status {type: 'status', message: 'æ­£åœ¨åˆ†ææ‚¨çš„è¯·æ±‚...'}
[Stream] status {type: 'status', message: 'ä½¿ç”¨ æ¦‚å¿µè®²è§£'}
[Stream] status {type: 'status', message: 'æ­£åœ¨ç”Ÿæˆå†…å®¹...'}
[Stream] thinking {type: 'thinking', text: 'The user wants...'}  â† âœ… å¼€å§‹æµå¼
[Stream] thinking {type: 'thinking', text: ' to explain...'}
[Stream] thinking {type: 'thinking', text: ' the concept...'}
... (50-100+ thinking chunks)
[Stream] content {type: 'content', text: '{\n  "concept":'}  â† âœ… å¼€å§‹å†…å®¹
[Stream] content {type: 'content', text: ' "å…‰åˆä½œç”¨"'}
[Stream] content {type: 'content', text: ',\n  "subjec'}
... (50-100+ content chunks)
[Stream] done {type: 'done', ...}

[Debug] Overview Changesï¼ˆæ™ºèƒ½æå–é«˜ä»·å€¼ä¿¡æ¯ï¼‰
[DEBUG] Overview #1: è¯†åˆ«ä¸ºæ–°ç”¨æˆ·ï¼Œå‡†å¤‡æ˜“æ‡‚è®²è§£  â† âœ… å…·ä½“ç”¨æˆ·è¯„ä¼°
[DEBUG] Overview #2: è®¡åˆ’æä¾›3ä¸ªè¯¦ç»†ä¾‹å­  â† âœ… å…·ä½“æ•°é‡
[DEBUG] Overview #3: å‡†å¤‡ç”¨"é£Ÿç‰©å·¥å‚"ä½œæ¯”å–»  â† âœ… å…·ä½“æ¯”å–»ç±»å‹
[DEBUG] Overview #4: è¯„ä¼°ä¸ºåŸºç¡€æ¦‚å¿µ  â† âœ… éš¾åº¦è¯„ä¼°
[DEBUG] Overview #5: æ­£åœ¨ç»„ç»‡ç­”æ¡ˆç»“æ„
[DEBUG] Overview #6: æ­£åœ¨èµ·è‰ç­”æ¡ˆ
[DEBUG] Overview #7: å³å°†å®Œæˆ...

ç”¨æˆ·ä½“éªŒ: â­â­â­â­â­
- âœ… æŒç»­æµå¼åé¦ˆï¼ˆ50-100+ chunksï¼‰
- âœ… æ¸…æ¥šçœ‹åˆ°æ€è€ƒè¿‡ç¨‹å’Œå†…å®¹ç”Ÿæˆ
- âœ… Overview æå–é«˜ä»·å€¼ä¿¡æ¯ï¼ˆä¸å†æ˜¯é€šç”¨å ä½ç¬¦ï¼‰
- âœ… é€æ˜çš„ AI æ€è€ƒè¿‡ç¨‹ï¼ˆç”¨æˆ·çº§åˆ«ã€æ¯”å–»ã€ä¾‹å­æ•°é‡ï¼‰
```

---

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | Before | After | æ”¹è¿› |
|-----|--------|-------|------|
| **æµå¼ Chunks** | 0 | 50-100+ | âœ… **å®Œå…¨ä¿®å¤** |
| **Overview é˜¶æ®µæ•°** | 3 | 7+ | âœ… **2x+** |
| **ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ** | 15s é»‘å± | 0.5s å³æ—¶åé¦ˆ | âœ… **30x** |
| **ä»£ç å˜æ›´** | - | 3 ä¸ªæ–‡ä»¶ | âœ… **æœ€å°ä¾µå…¥** |

---

### éªŒæ”¶æ ‡å‡†

- [x] åç«¯å¯åŠ¨æ—¶æ˜¾ç¤º "Using Kimi Client"
- [x] å‰ç«¯æ”¶åˆ°å¤šä¸ª `thinking` ç±»å‹çš„æµå¼ chunks
- [x] å‰ç«¯æ”¶åˆ°å¤šä¸ª `content` ç±»å‹çš„æµå¼ chunks
- [x] Thinking Overview è‡³å°‘æ˜¾ç¤º 5+ ä¸ªä¸åŒçš„é˜¶æ®µ
- [x] Overview å†…å®¹ä¸ thinking æ–‡æœ¬è¯­ä¹‰ç›¸å…³
- [x] Debug æ–‡ä»¶ä¸­ `all_overviews` åŒ…å«å¤šä¸ªæœ‰æ„ä¹‰çš„é˜¶æ®µ

---

### æ–‡ä»¶æ¸…å•

**åç«¯ä¿®æ”¹**:
- âœ… `backend/app/core/skill_orchestrator.py` - LLM Client é€‰æ‹©é€»è¾‘
- âœ… `backend/app/api/agent.py` - ä¾èµ–æ³¨å…¥ç®€åŒ–
- âœ… `backend/app/core/intent_router.py` - è¿”å›æ ¼å¼å…¼å®¹

**å‰ç«¯ä¼˜åŒ–**:
- âœ… `frontend/public/demo.html` - Overview æå–å¢å¼º

**é…ç½®**:
- âœ… `backend/app/config.py` - å·²åŒ…å« Kimi API é…ç½®

---

### æœªæ¥ä¼˜åŒ–æ–¹å‘

- ğŸ”„ **Plan Skill æµå¼æ”¯æŒ**: æ¯ä¸ª sub-skill å®æ—¶æ˜¾ç¤º thinking
- ğŸ”„ **WebSocket ä¼˜åŒ–**: é™ä½ HTTP SSE å¼€é”€
- ğŸ”„ **Thinking å¯è§†åŒ–**: æ˜¾ç¤ºæ€è€ƒè¿›åº¦æ¡
- ğŸ”„ **å¤šæ¨¡å‹åˆ‡æ¢**: è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢ LLM

---

## 1. æ ¸å¿ƒå­¦ä¹ æŠ€èƒ½

### 1.1 æ¦‚å¿µè®²è§£ (Explain Skill)

**åŠŸèƒ½**: ç»“æ„åŒ–çš„æ¦‚å¿µè§£é‡Š

**ç‰¹æ€§**:
- ç›´è§‰ç†è§£ï¼ˆIntuitionï¼‰- æ—¥å¸¸ç±»æ¯”
- æ­£å¼å®šä¹‰ï¼ˆFormal Definitionï¼‰- å­¦æœ¯å®šä¹‰
- é‡è¦æ€§ï¼ˆWhy It Mattersï¼‰- å®é™…åº”ç”¨
- å¤šä¸ªç¤ºä¾‹ï¼ˆExamplesï¼‰- 2-3ä¸ªæ¸è¿›å¼ä¾‹å­
- å¸¸è§è¯¯è§£ï¼ˆCommon Mistakesï¼‰
- ç›¸å…³æ¦‚å¿µï¼ˆRelated Conceptsï¼‰

**ä¸Šä¸‹æ–‡æ”¯æŒ** (V1.5):
- åŸºäºé¢˜ç›®çš„é’ˆå¯¹æ€§è§£é‡Šï¼šå½“ç”¨æˆ·è¯´"è§£é‡Šä¸€ä¸‹ç¬¬ä¸€é“é¢˜"ï¼Œç³»ç»Ÿä¼šï¼š
  1. ä» `last_artifact_content` æå–ç¬¬1é¢˜
  2. ä½œä¸º `source_content` ä¼ é€’ç»™ explain skill
  3. ç”Ÿæˆä»¥"è¿™é“é¢˜è€ƒæŸ¥çš„æ˜¯..."å¼€å¤´çš„è§£é‡Š
  4. ç¬¬ä¸€ä¸ªä¾‹å­å°±æ˜¯é¢˜ç›®ä¸­çš„å…·ä½“æ¦‚å¿µ

**ç¤ºä¾‹**:
```
ğŸ‘¤: è§£é‡Šä¸€ä¸‹çç æ¸¯äº‹ä»¶
ğŸ¤–: 
  ç›´è§‰ç†è§£: çç æ¸¯äº‹ä»¶å°±åƒ...
  æ­£å¼å®šä¹‰: 1941å¹´12æœˆ7æ—¥ï¼Œæ—¥æœ¬æµ·å†›...
  é‡è¦æ€§: è¿™ä¸€äº‹ä»¶ç›´æ¥å¯¼è‡´ç¾å›½å‚æˆ˜...
  ä¾‹å­1: äº‹ä»¶å½“å¤©ï¼Œæ—¥æœ¬å‡ºåŠ¨...
  ä¾‹å­2: ç½—æ–¯ç¦æ€»ç»Ÿåœ¨äº‹ä»¶åå‘è¡¨...
```

---

### 1.2 æµ‹éªŒç”Ÿæˆ (Quiz Skill)

**åŠŸèƒ½**: ç”Ÿæˆå„ç§ç±»å‹çš„ç»ƒä¹ é¢˜

**é¢˜å‹æ”¯æŒ**:
- å•é€‰é¢˜ï¼ˆMultiple Choiceï¼‰
- å¤šé€‰é¢˜ï¼ˆMultiple Selectï¼‰
- å¡«ç©ºé¢˜ï¼ˆFill in the Blankï¼‰
- åˆ¤æ–­é¢˜ï¼ˆTrue/Falseï¼‰
- ç®€ç­”é¢˜ï¼ˆShort Answerï¼‰

**ç‰¹æ€§**:
- æ”¯æŒ 1-10 é¢˜è‡ªå®šä¹‰æ•°é‡
- éš¾åº¦è‡ªé€‚åº”ï¼ˆeasy/medium/hardï¼‰
- åŒ…å«è¯¦ç»†è§£æ
- æ”¯æŒåŸºäºå†…å®¹ç”Ÿæˆï¼ˆsource_contentï¼‰

**ä¸Šä¸‹æ–‡æ”¯æŒ** (V1.5):
- "æ ¹æ®è¿™äº›ä¾‹å­å‡ºé¢˜" â†’ åŸºäºä¸Šä¸€è½®çš„ explanation ç”Ÿæˆ
- "æ¯ä¸ªä¾‹å­å‡ºä¸€é“é¢˜" â†’ æ™ºèƒ½æ¨æ–­æ•°é‡

**ç¤ºä¾‹**:
```
ğŸ‘¤: ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜
ğŸ¤–: [ç”Ÿæˆ5é“é€‰æ‹©é¢˜ï¼ŒåŒ…å«é¢˜ç›®ã€é€‰é¡¹ã€æ­£ç¡®ç­”æ¡ˆã€è§£æ]

ğŸ‘¤: æ ¹æ®åˆšæ‰çš„è®²è§£å‡º3é“é¢˜
ğŸ¤–: [åŸºäºä¸Šä¸€è½®çš„explanationå†…å®¹ç”Ÿæˆ3é“é¢˜]
```

---

### 1.3 é—ªå¡ç”Ÿæˆ (Flashcard Skill)

**åŠŸèƒ½**: ç”Ÿæˆ Anki é£æ ¼çš„å­¦ä¹ å¡ç‰‡

**ç‰¹æ€§**:
- æ”¯æŒ 1-20 å¼ è‡ªå®šä¹‰æ•°é‡
- æ­£é¢/èƒŒé¢æ ¼å¼
- åŒ…å«è®°å¿†æç¤ºï¼ˆHintï¼‰
- éš¾åº¦æ ‡è®°ï¼ˆBasic/Intermediate/Advancedï¼‰
- æ”¯æŒå¤šç§å¡ç‰‡ç±»å‹

**å¡ç‰‡ç±»å‹**:
- æ¦‚å¿µå®šä¹‰å¡
- å…¬å¼è®°å¿†å¡
- å†å²äº‹ä»¶å¡
- æœ¯è¯­è§£é‡Šå¡

**ç¤ºä¾‹**:
```
ğŸ‘¤: ç»™æˆ‘10å¼ äºŒæˆ˜å†å²çš„é—ªå¡
ğŸ¤–: 
  å¡ç‰‡1:
    æ­£é¢: çç æ¸¯äº‹ä»¶å‘ç”Ÿåœ¨å“ªä¸€å¹´ï¼Ÿ
    èƒŒé¢: 1941å¹´12æœˆ7æ—¥
    æç¤º: äºŒæˆ˜è½¬æŠ˜ç‚¹
```

---

### 1.4 ç»“æ„åŒ–ç¬”è®° (Notes Skill)

**åŠŸèƒ½**: ç”Ÿæˆå±‚çº§åŒ–çš„å­¦ä¹ ç¬”è®°

**ç‰¹æ€§**:
- æ ‡é¢˜ + ç« èŠ‚ç»“æ„
- è¦ç‚¹åˆ—è¡¨ï¼ˆBullet Pointsï¼‰
- å¯ç¼–è¾‘çš„ Notebook UI
- æ”¯æŒæ·»åŠ /åˆ é™¤è¦ç‚¹
- å®æ—¶ä¿å­˜

**UIåŠŸèƒ½**:
- ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
- ç« èŠ‚å±•å¼€/æŠ˜å 
- è¦ç‚¹å¢åˆ 
- æœ¬åœ°ä¿å­˜ï¼ˆè®¡åˆ’ä¸­ï¼‰

**ç¤ºä¾‹**:
```
ğŸ‘¤: åšç¬”è®°
ğŸ¤–: 
  äºŒæˆ˜å†å²ç¬”è®°
  
  1. æˆ˜äº‰èµ·å› 
     â€¢ å‡¡å°”èµ›æ¡çº¦çš„è‹›åˆ»åˆ¶è£
     â€¢ 1929å¹´ç»æµå¤§è§æ¡
     â€¢ æ³•è¥¿æ–¯ä¸»ä¹‰å´›èµ·
  
  2. é‡è¦äº‹ä»¶
     â€¢ 1939å¹´ï¼šæ³¢å…°é—ªå‡»æˆ˜
     â€¢ 1941å¹´ï¼šçç æ¸¯äº‹ä»¶
     â€¢ 1944å¹´ï¼šè¯ºæ›¼åº•ç™»é™†
```

---

### 1.5 æ€ç»´å¯¼å›¾ (MindMap Skill)

**åŠŸèƒ½**: å¯è§†åŒ–çŸ¥è¯†ç»“æ„

**ç‰¹æ€§**:
- åŸºäº Mind Elixir æ¸²æŸ“
- æ”¯æŒäº¤äº’å¼ç¼–è¾‘ï¼ˆè®¡åˆ’ä¸­ï¼‰
- è‡ªåŠ¨ç”Ÿæˆå±‚çº§ç»“æ„
- ä¸»é¢˜èŠ‚ç‚¹é«˜äº®

**ç»“æ„**:
- ä¸­å¿ƒä¸»é¢˜
- ä¸€çº§åˆ†æ”¯ï¼ˆ3-5ä¸ªï¼‰
- äºŒçº§åˆ†æ”¯ï¼ˆæ¯ä¸ª2-4ä¸ªï¼‰

**ç¤ºä¾‹**:
```
ğŸ‘¤: ç»™æˆ‘äºŒæˆ˜å†å²çš„æ€ç»´å¯¼å›¾
ğŸ¤–: [ç”Ÿæˆäº¤äº’å¼æ€ç»´å¯¼å›¾]
     ä¸­å¿ƒï¼šäºŒæˆ˜å†å²
      â”œâ”€ æˆ˜äº‰èµ·å› 
      â”‚   â”œâ”€ å‡¡å°”èµ›æ¡çº¦
      â”‚   â””â”€ ç»æµå¤§è§æ¡
      â”œâ”€ ä¸»è¦æˆ˜å½¹
      â”‚   â”œâ”€ æ³¢å…°æˆ˜å½¹
      â”‚   â”œâ”€ ä¸åˆ—é¢ ç©ºæˆ˜
      â”‚   â””â”€ æ–¯å¤§æ—æ ¼å‹’æˆ˜å½¹
      â””â”€ æˆ˜äº‰ç»“æœ
```

---

### 1.6 å­¦ä¹ åŒ… (Learning Bundle / Plan Skill)

**åŠŸèƒ½**: ä¸€ç«™å¼ç»¼åˆå­¦ä¹ èµ„æ–™

**æ¶æ„**: Plan Skill - ä¸²è”ç¼–æ’å¤šä¸ªå­æŠ€èƒ½

**åŒ…å«å†…å®¹**:
- Explanationï¼ˆæ¦‚å¿µè®²è§£ï¼‰
- Quizï¼ˆç»ƒä¹ é¢˜ï¼‰
- Flashcardï¼ˆé—ªå¡ï¼‰
- å¯é€‰ï¼šNotesã€MindMap

**ç‰¹æ€§**:
- æ™ºèƒ½ç»„åˆæœ€ä½³å­¦ä¹ èµ„æº
- ä¸€æ¬¡è¯·æ±‚ç”Ÿæˆå¤šç§ææ–™
- å†…å®¹å…³è”æ€§é«˜
- ä¸²è”æ‰§è¡Œä¿è¯å†…å®¹ç›¸å…³æ€§

**Thinking æ¨¡å¼**:
- âš ï¸ **Plan Skillæœ¬èº«ä¸ç”Ÿæˆå†…å®¹** - ä»…ä½œä¸ºåè°ƒå™¨
- âœ… **Sub-skillså„è‡ªæœ‰thinking** - explain_skillã€quiz_skillã€flashcard_skill
- ğŸ”„ **æµå¼æ¨¡å¼æ”¯æŒ** - æš‚æ—¶å›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼ï¼ˆæœªæ¥ç‰ˆæœ¬æ”¹è¿›ï¼‰
- ğŸ“Š **Thinkingæ˜¾ç¤º** - èšåˆæ˜¾ç¤º"Plan Skillä¸²è”æ‰§è¡Œï¼šexplain â†’ flashcard â†’ quiz"

**ç¤ºä¾‹**:
```
ğŸ‘¤: äºŒæˆ˜å†å²å­¦ä¹ èµ„æ–™
ğŸ¤–: [ç”Ÿæˆå­¦ä¹ åŒ…]
    â€¢ æ ¸å¿ƒæ¦‚å¿µè®²è§£ï¼ˆå«thinkingï¼‰
    â€¢ 5é“ç»ƒä¹ é¢˜ï¼ˆå«thinkingï¼‰
    â€¢ 10å¼ è®°å¿†é—ªå¡ï¼ˆå«thinkingï¼‰
    â€¢ ç»“æ„åŒ–ç¬”è®°
```

---

## 2. æ™ºèƒ½Agentèƒ½åŠ›

### 2.1 æ„å›¾è¯†åˆ« (Intent Recognition)

**ä¸¤é˜¶æ®µè¯†åˆ«**:
1. **è§„åˆ™å¼•æ“**ï¼ˆ70%è¯·æ±‚ï¼Œ0 tokensï¼‰
   - å…³é”®è¯åŒ¹é…
   - æ­£åˆ™è¡¨è¾¾å¼æå–
   - ä¼˜å…ˆçº§åŒ¹é…ï¼ˆexplain > quizï¼‰

2. **LLM Fallback**ï¼ˆ30%è¯·æ±‚ï¼Œ~1,500 tokensï¼‰
   - å¤„ç†å¤æ‚/æ¨¡ç³Šè¯·æ±‚
   - ä¸Šä¸‹æ–‡æ¨ç†

**æ”¯æŒçš„æ„å›¾ç±»å‹**:
- `quiz_request` - é¢˜ç›®ç”Ÿæˆ
- `explain_request` - æ¦‚å¿µè®²è§£
- `flashcard_request` - é—ªå¡ç”Ÿæˆ
- `notes` - ç¬”è®°ç”Ÿæˆ
- `mindmap` - æ€ç»´å¯¼å›¾
- `learning_bundle` - å­¦ä¹ åŒ…
- `help` - åŠŸèƒ½æŸ¥è¯¢
- `contextual` - ä¸Šä¸‹æ–‡å¼•ç”¨
- `ambiguous` - æ¨¡ç³Šè¯·æ±‚
- `other` - å…¶ä»–å¯¹è¯

**ä¸Šä¸‹æ–‡å¼•ç”¨æ£€æµ‹**:
- æ£€æµ‹å…³é”®è¯ï¼šã€Œç¬¬ä¸€é“ã€ã€Œè¿™äº›ã€ã€Œåˆšæ‰çš„ã€
- è‡ªåŠ¨è®¾ç½® `use_last_artifact = True`
- æ™ºèƒ½æå–ç‰¹å®šå†…å®¹

---

### 2.2 è®°å¿†ç®¡ç† (Memory Management)

**ä¸¤ç§è®°å¿†ç±»å‹**:

#### é•¿æœŸè®°å¿† (UserLearningProfile)
- `user_id` - ç”¨æˆ·æ ‡è¯†
- `mastery` - å­¦ç§‘æŒæ¡åº¦ (0-1)
- `preferences` - ç”¨æˆ·åå¥½ï¼ˆpreferred_artifact, difficultyï¼‰
- `learning_history` - å­¦ä¹ å†å²
- `created_at` / `updated_at` - æ—¶é—´æˆ³

#### çŸ­æœŸè®°å¿† (SessionContext)
- `session_id` - ä¼šè¯æ ‡è¯†
- `current_topic` - å½“å‰å­¦ä¹ ä¸»é¢˜
- `recent_intents` - æœ€è¿‘10ä¸ªæ„å›¾
- `last_artifact` - ä¸Šä¸€è½®äº§ç‰©ç±»å‹
- `last_artifact_content` - **å®Œæ•´çš„ä¸Šä¸€è½®å†…å®¹**ï¼ˆå…³é”®ï¼ï¼‰
- `last_user_message` - æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯

**æœ¬åœ°æŒä¹…åŒ–**:
- ä½ç½®: `backend/memory_storage/`
- æ ¼å¼: JSONï¼ˆæ ¼å¼åŒ–ï¼Œæ˜“è¯»ï¼‰
- æ–‡ä»¶:
  - `profile_<user_id>.json`
  - `session_<session_id>.json`
- å®æ—¶æ›´æ–°

---

### 2.3 ä¸ªæ€§åŒ–æ¨è

**åå¥½å­¦ä¹ **:
- è‡ªåŠ¨ç»Ÿè®¡ç”¨æˆ·æœ€å¸¸ä½¿ç”¨çš„æŠ€èƒ½
- è®¡ç®—åå¥½æƒé‡ï¼ˆflashcard: 0.6, quiz: 0.3, explain: 0.1ï¼‰
- æ›´æ–° `preferred_artifact`

**æ¨¡ç³Šæ„å›¾å¤„ç†**:
```
ğŸ‘¤: å¸®æˆ‘å­¦ä¹ äºŒæˆ˜å†å²
ğŸ¤–: [æ£€æµ‹åˆ°æ¨¡ç³Šæ„å›¾]
    â†’ æŸ¥è¯¢ç”¨æˆ·åå¥½: preferred_artifact = "flashcard"
    â†’ è‡ªåŠ¨ç”Ÿæˆ10å¼ äºŒæˆ˜å†å²é—ªå¡
```

**ä¸Šä¸‹æ–‡ç»§æ‰¿**:
```
ğŸ‘¤: ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜  [è®¾ç½® current_topic = "äºŒæˆ˜å†å²çš„"]
ğŸ‘¤: ç»™æˆ‘10å¼ é—ªå¡            [ç»§æ‰¿ topic = "äºŒæˆ˜å†å²çš„"]
ğŸ¤–: [ç”ŸæˆäºŒæˆ˜å†å²çš„10å¼ é—ªå¡]
```

---

### 2.4 ä¸Šä¸‹æ–‡å¼•ç”¨ (V1.5)

**æ”¯æŒçš„å¼•ç”¨æ¨¡å¼**:
- "è§£é‡Šä¸€ä¸‹ç¬¬ä¸€é“é¢˜"
- "æ ¹æ®è¿™äº›ä¾‹å­å‡ºé¢˜"
- "ç»™æˆ‘è¿™é“é¢˜çš„é—ªå¡"
- "åŸºäºåˆšæ‰çš„è®²è§£åšç¬”è®°"

**å¤„ç†æµç¨‹**:
1. **è§„åˆ™å¼•æ“æ£€æµ‹**: è¯†åˆ«"ç¬¬ä¸€é“"å…³é”®è¯
2. **è®¾ç½®æ ‡è®°**: `use_last_artifact = True`
3. **Topic Validation**: è¿‡æ»¤æ— æ•ˆtopicï¼ˆå¦‚"ç¬¬ä¸€"ï¼‰
4. **Topic Fallback**: ä½¿ç”¨ `current_topic`
5. **å†…å®¹æå–**: 
   - æ£€æµ‹ "ç¬¬Xé“é¢˜" â†’ æå–é¢˜å·
   - ä» `last_artifact_content.questions[X-1]` æå–
   - æ„å»º `source_content`
6. **Skillæ‰§è¡Œ**: ä¼ é€’ `source_content` ç»™æŠ€èƒ½

**ç¤ºä¾‹æµç¨‹**:
```
ç¬¬1è½®: ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜
  â†’ last_artifact_content = { questions: [é¢˜1, é¢˜2, é¢˜3, é¢˜4, é¢˜5] }
  â†’ current_topic = "äºŒæˆ˜å†å²çš„"

ç¬¬2è½®: è§£é‡Šä¸€ä¸‹ç¬¬ä¸€é“é¢˜
  â†’ è§„åˆ™å¼•æ“: explain_request + use_last_artifact = True
  â†’ Topic Validation: "ç¬¬ä¸€" æ— æ•ˆ
  â†’ Topic Fallback: topic = "äºŒæˆ˜å†å²çš„"
  â†’ å†…å®¹æå–: questions[0] â†’ source_content
  â†’ Explain Skill: åŸºäºç¬¬1é¢˜ç”Ÿæˆè§£é‡Š
```

---

## 3. Phase 3 æ¶æ„ä¼˜åŒ–

### 3.1 æ··åˆIntent Router

**æ¶æ„**:
```
User Message
    â†“
Rule Engine (0 tokens) â†â”€â”€ 70% è¯·æ±‚
    â†“ (failed)
LLM Fallback (~1,500 tokens) â†â”€â”€ 30% è¯·æ±‚
    â†“
Intent Result
```

**è§„åˆ™å¼•æ“ä¼˜åŠ¿**:
- âœ… **0 tokens** æ¶ˆè€—
- âœ… **<0.01s** å“åº”æ—¶é—´
- âœ… 100% å‡†ç¡®ç‡ï¼ˆæ˜¾å¼è¯·æ±‚ï¼‰
- âœ… æ”¯æŒæ•°é‡æå–ã€ä¸Šä¸‹æ–‡æ£€æµ‹
- âœ… **æ··åˆæ„å›¾æ£€æµ‹** (V3.1): è‡ªåŠ¨æ£€æµ‹æ··åˆå…³é”®è¯ï¼ˆå¦‚"3å¼ é—ªå¡ï¼Œ3é“é¢˜"ï¼‰ï¼Œå¼ºåˆ¶å›é€€åˆ° LLM å¤„ç†

**LLM Fallbackåœºæ™¯**:
- å¤æ‚è¯­ä¹‰ï¼ˆ"æ ¹æ®è¿™é“é¢˜å†å‡º3é“ç±»ä¼¼çš„"ï¼‰
- æ¨¡ç³Šæ„å›¾ï¼ˆ"å¸®æˆ‘å­¦ä¹ "ï¼‰
- æ··åˆè¯·æ±‚ï¼ˆ"è®²è§£ + å‡ºé¢˜"ï¼Œ"3å¼ é—ªå¡ï¼Œ3é“é¢˜"ï¼‰
- è§„åˆ™å¼•æ“ä¸»åŠ¨æ”¾å¼ƒçš„æƒ…å†µ

---

### 3.2 Token ä¼˜åŒ–æ•ˆæœ

**æ¶æ„æ¼”è¿›å¯¹æ¯”**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      âŒ æ—§æ¡†æ¶ (Phase 1)                             â”‚
â”‚                 å…¨é‡LLMå¤„ç†ï¼ŒTokenéšä¸Šä¸‹æ–‡å¢é•¿                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥ (10 tokens)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Intent Router (LLM è°ƒç”¨)                                            â”‚
â”‚                                                                       â”‚
â”‚  ğŸ“ Prompt æ¨¡æ¿: ~1,200 tokens                                       â”‚
â”‚  ğŸ§  Memory Summary: ~1,500 tokens (éšå†å²å¢é•¿ âš ï¸)                    â”‚
â”‚  ğŸ“¦ Last Artifact Summary: ~400 tokens                               â”‚
â”‚  ğŸ’¬ User Message: ~10 tokens                                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  Total Input: 3,132 tokens                                           â”‚
â”‚  Processing Time: ~2.0s                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Intent Result
    â†“
Skill Execution
    â†“
Response

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      âœ… æ–°æ¡†æ¶ (Phase 3)                             â”‚
â”‚           è§„åˆ™å¼•æ“ + ç²¾ç®€LLMï¼ŒTokenå›ºå®šä¸å¢é•¿                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥ (10 tokens)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rule-Based Classifier (0 tokens, <10ms)                             â”‚
â”‚                                                                       â”‚
â”‚  ğŸ¯ å…³é”®è¯åŒ¹é…                                                        â”‚
â”‚  ğŸ¯ ä¸»é¢˜æå–                                                          â”‚
â”‚  ğŸ¯ æ•°é‡è¯†åˆ«                                                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  Total: 0 tokens âœ…                                                   â”‚
â”‚  Success Rate: 70-80%                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (å‘½ä¸­è§„åˆ™)
    âœ… Intent Result (0 tokens)
         â†“
         Skill Execution
         â†“
         Response

    â†“ (æœªå‘½ä¸­è§„åˆ™ - 20-30%)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Intent Router LLM Fallback                                          â”‚
â”‚                                                                       â”‚
â”‚  ğŸ“ Prompt æ¨¡æ¿ (ç²¾ç®€): ~800 tokens                                  â”‚
â”‚  ğŸ·ï¸ Minimal Flags: ~20 tokens (å›ºå®š âœ…)                              â”‚
â”‚  ğŸ’¬ User Message: ~10 tokens                                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  Total Input: ~1,487 tokens (å›ºå®š âœ…)                                â”‚
â”‚  Processing Time: ~1.6s                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Intent Result
    â†“
Skill Execution
    â†“
Response
```

**æ•°æ®å¯¹æ¯”**:

| æŒ‡æ ‡ | Phase 1 (çº¯LLM) | Phase 2 (ç²¾ç®€Prompt) | **Phase 3 (æ··åˆæ¶æ„)** |
|------|----------------|---------------------|-------------------|
| **Intent Router Token** | 3,132 | 1,902 | **0** (70%) / **1,487** (30%) âœ… |
| **è§„åˆ™å¼•æ“å‘½ä¸­ç‡** | 0% | 0% | **70-80%** âœ… |
| **å¹³å‡ Token/è½®** | 3,132 | 1,902 | **~450** (-86%) âœ… |
| **å¹³å‡å“åº”æ—¶é—´** | ~2.0s | ~1.2s | **<0.01s** (å‘½ä¸­æ—¶) âœ… |

**å•æ¬¡è¯·æ±‚ Token å¯¹æ¯”**:

- **ç®€å•è¯·æ±‚** ("ç»™æˆ‘5é“ç‰›é¡¿ç¬¬äºŒå®šå¾‹çš„é¢˜"): **0 tokens** (100% èŠ‚çœ)
- **å¤æ‚è¯·æ±‚** ("æ ¹æ®è¿™äº›å†…å®¹å¸®æˆ‘å·©å›º"): **~1,487 tokens** (å›ºå®šå¼€é”€ï¼Œä¸éšå†å²å¢é•¿)

**10è½®å¯¹è¯ç´¯è®¡ Token**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1                                      â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 31,320       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase 2                                      â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 19,020                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase 3                                      â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 4,500 âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.3 Minimal Intent Router

**è®¾è®¡åŸåˆ™**:
- Intent Routeråªè¯†åˆ«å’Œæ ‡è®°intent
- å¤æ‚é€»è¾‘ç”±Orchestratorå¤„ç†ï¼ˆ0 tokensï¼‰
- æœ€å°åŒ–contextä¼ é€’

**å¤„ç†ç¤ºä¾‹**:
```
Intent Router (1,487 tokens):
  â†’ è¯†åˆ«: intent = "ambiguous"
  â†’ æ ‡è®°: user_preference_top = "flashcard"
  â†’ è¿”å›

Orchestrator (0 tokens):
  â†’ è¯»å– user_profile.preferences
  â†’ æ¨æ–­: intent = "flashcard"
  â†’ æå–: topic = current_topic
  â†’ æ‰§è¡Œ flashcard_skill
```

---

### 3.4 ä¸Šä¸‹æ–‡æ¨æ–­æ¶æ„

**æ ¸å¿ƒç†å¿µ**: ä¸åˆ¤æ–­"ä»€ä¹ˆæ˜¯æ— æ•ˆ"ï¼Œè€Œæ˜¯åˆ¤æ–­"æ˜¯å¦æœ‰æ˜ç¡®ä¸»é¢˜"

**è®¾è®¡åŸåˆ™**:
1. âœ… **æœ€å°å¤„ç†åŸåˆ™** - åªç§»é™¤æ˜ç¡®æ— æ„ä¹‰çš„è¯
2. âœ… **æ™ºèƒ½æ¨æ–­åŸåˆ™** - æ²¡æœ‰æ˜ç¡®ä¸»é¢˜æ—¶ä»ä¸Šä¸‹æ–‡æ¨æ–­
3. âœ… **é¿å…ç¡¬ç¼–ç åŸåˆ™** - ä¸ç»´æŠ¤æ— æ•ˆè¯é»‘åå•

**Topic æå–ç­–ç•¥**:
```python
# âœ… æ™ºèƒ½å¤„ç†
cleaned = re.sub(r'\d+\s*[ä¸ªé“å¼ ä»½]', '', cleaned)  # åªåˆ é™¤çº¯æ•°é‡
# "ç»™æˆ‘5é“é¢˜" â†’ "" â†’ topic=None â†’ fallback âœ…
# "ç‰›é¡¿ç¬¬äºŒå®šå¾‹" â†’ "ç‰›é¡¿ç¬¬äºŒå®šå¾‹" (ä¿ç•™æœ‰æ„ä¹‰çš„æ•°å­—) âœ…
# "äºŒæˆ˜å†å²" â†’ "äºŒæˆ˜å†å²" (ä¿ç•™) âœ…

if len(cleaned) >= 3:
    return cleaned  # æ˜ç¡®ä¸»é¢˜
return None  # è‡ªåŠ¨fallbackåˆ°current_topic
```

**ä¼˜åŠ¿å¯¹æ¯”**:

| æŒ‡æ ‡ | ç¡¬ç¼–ç æ–¹æ¡ˆ | æ™ºèƒ½æ¨æ–­æ–¹æ¡ˆ |
|------|-----------|------------|
| Token æ¶ˆè€— | 0 | 0 âœ… |
| è¦†ç›–ç‡ | ~60% âŒ | 100% âœ… |
| ç»´æŠ¤æˆæœ¬ | é«˜ âŒ | é›¶ âœ… |
| ç¬¦åˆ Agent ç†å¿µ | âŒ | âœ… |

---

### 3.5 Artifact History æ¶æ„

**ç›®æ ‡**: æ”¯æŒå¤šè½®ã€é•¿èŒƒå›´çš„ä¸Šä¸‹æ–‡å¼•ç”¨

**æ•°æ®ç»“æ„**:
```python
class ArtifactRecord(BaseModel):
    artifact_id: str          # "art_20250118_001"
    turn_number: int          # ç¬¬å‡ è½®å¯¹è¯
    timestamp: datetime       # ç”Ÿæˆæ—¶é—´
    artifact_type: str        # "quiz_set", "explanation"
    topic: str                # "äºŒæˆ˜å†å²"
    summary: str              # "ç”Ÿæˆäº†5é“äºŒæˆ˜é€‰æ‹©é¢˜"
    content: Dict[str, Any]   # å®Œæ•´å†…å®¹

class SessionContext(BaseModel):
    artifact_history: List[ArtifactRecord]  # æ‰€æœ‰artifact
    last_artifact_id: Optional[str]         # æŒ‡å‘æœ€æ–°çš„ID
    
    @property
    def last_artifact_content(self):  # å‘åå…¼å®¹
        return self.artifact_history[-1].content if self.artifact_history else None
```

**å­˜å‚¨ä¼˜åŒ–**:
- âŒ ä¹‹å‰: `last_artifact_content` å†—ä½™å­˜å‚¨å®Œæ•´å†…å®¹
- âœ… ç°åœ¨: åªå­˜å‚¨ `last_artifact_id`ï¼Œé€šè¿‡ `@property` åŠ¨æ€è·å–
- **æ•ˆæœ**: èŠ‚çœ 50% å­˜å‚¨ç©ºé—´

**å¼•ç”¨èƒ½åŠ›**:
```python
# æ”¯æŒçš„å¼•ç”¨ç±»å‹
"è§£é‡Šä¸€ä¸‹ç¬¬ä¸€é“é¢˜"        â†’ reference_type="question", index=0
"æ ¹æ®ç¬¬äºŒä¸ªä¾‹å­å‡ºé¢˜"      â†’ reference_type="example", index=1
"åŸºäºè¿™äº›ä¾‹å­ç”Ÿæˆé—ªå¡"    â†’ reference_type="examples", index=all
"æ ¹æ®åˆšæ‰åŒ—æå†°å·çš„é‚£ä¸ª"   â†’ reference_type="description", keyword="åŒ—æå†°å·"
```

---

### 3.6 ä¸Šä¸‹æ–‡å¼•ç”¨ä¼˜åŒ–

**ä¸¤å±‚å¤„ç†æœºåˆ¶**:

**Layer 1: è§„åˆ™å¼•æ“**
```python
# æ£€æµ‹æ˜ç¡®çš„ä¸Šä¸‹æ–‡å¼•ç”¨
context_keywords = ["ç¬¬ä¸€é“", "ç¬¬äºŒä¸ª", "è¿™é“", "è¿™äº›"]
if any(kw in message for kw in context_keywords):
    return {"use_last_artifact": True}
```

**Layer 2: LLM è¯­ä¹‰ç†è§£**
```python
# å¤æ‚å¼•ç”¨äº¤ç»™ LLM
"æ ¹æ®åˆšæ‰åŒ—æå†°å·èåŒ–çš„é‚£ä¸ªä¾‹å­" 
â†’ LLM æå–: {
    "reference_type": "example",
    "reference_description": "åŒ—æå†°å·èåŒ–"
}
â†’ Orchestrator è¯­ä¹‰æœç´¢ artifact_history
```

**Token æ¶ˆè€—**:
- è§„åˆ™å¼•æ“: 0 tokens (70% æƒ…å†µ)
- LLM fallback: ~1,500 tokens (30% æƒ…å†µ)

---

### 3.7 å­˜å‚¨ä¼˜åŒ–

**æœ¬åœ°æ–‡ä»¶æŒä¹…åŒ–**:
```bash
backend/memory_storage/
â”œâ”€â”€ user_demo-user.json          # UserLearningProfile
â””â”€â”€ session_demo-session.json    # SessionContext
```

**Datetime åºåˆ—åŒ–ä¿®å¤**:
```python
def convert_datetime(obj):
    """é€’å½’è½¬æ¢æ‰€æœ‰ datetime ä¸º ISO æ ¼å¼å­—ç¬¦ä¸²"""
    if isinstance(obj, datetime):
        return obj.isoformat()
    elif isinstance(obj, dict):
        return {k: convert_datetime(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [convert_datetime(item) for item in obj]
    return obj
```

**ç‰¹æ€§**:
- âœ… è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ° JSON
- âœ… æ”¯æŒæµè§ˆå™¨åˆ·æ–°åæ¢å¤
- âœ… æ–¹ä¾¿è°ƒè¯•å’Œæ£€æŸ¥
- ğŸ”„ è®¡åˆ’è¿ç§»åˆ° SQLite (V2)

---

### 3.8 æ¾„æ¸…æœºåˆ¶ï¼ˆClarificationï¼‰

**è®¾è®¡åŸåˆ™**: å½“ç³»ç»Ÿä¸ç¡®å®šæ—¶ï¼Œä¸»åŠ¨è¯¢é—®ç”¨æˆ·è€Œä¸æ˜¯çŒœæµ‹ âœ…

**è§¦å‘æ¡ä»¶**:
```python
# éœ€è¦æ¾„æ¸…çš„ Intent
needs_clarification_intents = [
    "notes", "quiz_request", "flashcard_request", 
    "explain_request", "mindmap", "learning_bundle"
]

# è§¦å‘é€»è¾‘
if intent in needs_clarification_intents:
    if topic is None and len(artifact_history) >= 1:  # âœ… å·²ä¿®å¤ï¼š>= 1
        return clarification_response
```

**å®ç°çŠ¶æ€**: âœ… **å·²å®Œæˆï¼ˆ0 token æ¶ˆè€—ï¼‰**

**åŠŸèƒ½**:
1. **Onboardingï¼ˆé¦–æ¬¡è®¿é—®ï¼‰**:
   - æ£€æµ‹: `len(artifact_history) == 0` ä¸”ç”¨æˆ·æ²¡æœ‰æ˜ç¡®ä¸»é¢˜
   - æ˜¾ç¤º: æ¬¢è¿å¡ç‰‡ + 5å¤§ç±»æ¨èä¸»é¢˜ï¼ˆç‰©ç†ã€æ•°å­¦ã€å†å²ã€ç”Ÿç‰©ã€è®¡ç®—æœºï¼‰
   - Token: 0ï¼ˆçº¯ä»£ç é€»è¾‘ï¼‰

2. **Multi-Topic Clarificationï¼ˆå¤šä¸»é¢˜æ¾„æ¸…ï¼‰**:
   - æ£€æµ‹: `topic is None` ä¸” `len(learned_topics) >= 1`
   - æ˜¾ç¤º: å¯ç‚¹å‡»çš„ä¸»é¢˜æŒ‰é’®ï¼ˆä» `artifact_history` æå–ï¼‰
   - Token: 0ï¼ˆçº¯ä»£ç é€»è¾‘ï¼‰

**ç¤ºä¾‹**:
```
ğŸ‘¤: åšç¬”è®°
ğŸ¤–: æ‚¨æƒ³å¯¹å“ªä¸ªä¸»é¢˜åšç¬”è®°å‘¢ï¼Ÿ
    [æœºå™¨å­¦ä¹ ] [ç‰›é¡¿å®šå¾‹] [å…‰åˆä½œç”¨]

ğŸ‘¤: å‡ºé¢˜ç›®ï¼ˆé¦–æ¬¡è®¿é—®ï¼‰
ğŸ¤–: ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ StudyX Agentï¼
    æˆ‘æ³¨æ„åˆ°æ‚¨è¿˜æ²¡æœ‰å¼€å§‹å­¦ä¹ ä»»ä½•ä¸»é¢˜ã€‚
    
    ç‰©ç†: [ç‰›é¡¿å®šå¾‹] [å…‰å­¦] [ç”µç£å­¦] ...
    æ•°å­¦: [å¾®ç§¯åˆ†] [çº¿æ€§ä»£æ•°] ...
```

**Bug ä¿®å¤è®°å½•**:

1. **Topic æå–ä¼˜åŒ–** (2024-11-18):
   ```python
   # âŒ ä¿®å¤å‰
   filler_words = ["ç»™æˆ‘", "å¸®æˆ‘", ...]  # ç¼ºå°‘"åš"ã€"å‡º"ã€"çš„"
   
   # âœ… ä¿®å¤å
   filler_words = ["ç»™æˆ‘", "å¸®æˆ‘", ..., "åš", "å‡º", "çš„"]
   intent_keywords = [..., "é¢˜ç›®", "é¢˜", ...]  # æ·»åŠ "é¢˜ç›®"
   ```
   - ä¿®å¤: "åšç‰›é¡¿ç¬¬äºŒå®šå¾‹çš„ç¬”è®°" â†’ topic: "ç‰›é¡¿ç¬¬äºŒå®šå¾‹" âœ…
   - ä¿®å¤: "å‡ºé¢˜ç›®" â†’ topic: None âœ…ï¼ˆè§¦å‘ Clarificationï¼‰

2. **Clarification è§¦å‘æ¡ä»¶æ”¾å®½** (2024-11-18):
   ```python
   # âŒ ä¿®å¤å‰: åªæœ‰ > 1 ä¸ªä¸»é¢˜æ—¶æ‰è§¦å‘
   if len(learned_topics) > 1:
       return clarification_response
   
   # âœ… ä¿®å¤å: >= 1 å³å¯è§¦å‘
   if len(learned_topics) >= 1:
       return clarification_response
   ```
   - ä¿®å¤: ç”¨æˆ·å­¦ä¹ äº† 3 æ¬¡"æœºå™¨å­¦ä¹ "ï¼ˆå»é‡å 1 ä¸ªï¼‰ï¼Œè¯´"åšç¬”è®°"æ—¶ä¼šè§¦å‘æ¾„æ¸… âœ…

**è®¾è®¡å“²å­¦**:
- âœ… **è§„åˆ™å¼•æ“ä¿æŒç®€å•**: åªå¤„ç†æ˜ç¡®çš„æ­£é¢è¯·æ±‚
- âœ… **ä¸å†™æ­»å¦å®š/æŠ±æ€¨æ£€æµ‹**: é¿å…è¯¯åˆ¤å’Œç»´æŠ¤æˆæœ¬
- âœ… **äº¤ç»™ LLM å¤„ç†è¾¹ç¼˜ case**: è§„åˆ™å¼•æ“å¤±è´¥ â†’ LLM fallback

---

## 3.9 ğŸŒŠ æµå¼æ€è€ƒè¿‡ç¨‹ï¼ˆStreaming Thinking Processï¼‰

**ç›®æ ‡**: å®ç°ç±»ä¼¼ChatGPTçš„æµå¼å“åº”ä½“éªŒï¼Œç”¨æˆ·æ— éœ€ç­‰å¾…15ç§’ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°AIçš„æ€è€ƒè¿‡ç¨‹å’Œç”Ÿæˆå†…å®¹ã€‚

### æ ¸å¿ƒç‰¹æ€§

**åç«¯æ¶æ„**:
1. **GeminiClient.generate_stream()** - æµå¼ç”Ÿæˆæ ¸å¿ƒ
   - ä½¿ç”¨Gemini 2.5 Flashçš„æµå¼API
   - è‡ªåŠ¨åŒºåˆ†thinkingå’Œcontentéƒ¨åˆ†
   - å®æ—¶yieldæ€è€ƒè¿‡ç¨‹å’Œç”Ÿæˆå†…å®¹
   - ç´¯ç§¯å®Œæ•´ç»“æœç”¨äºè§£æ

2. **SkillOrchestrator.execute_stream()** - æµå¼ç¼–æ’
   - å®Œæ•´çš„æµå¼æŠ€èƒ½æ‰§è¡Œæµç¨‹
   - å®æ—¶yieldçŠ¶æ€æ›´æ–°ã€æ€è€ƒã€å†…å®¹
   - JSONç´¯ç§¯è§£æï¼ˆå¤„ç†ä¸å®Œæ•´JSONï¼‰
   - Memoryæ›´æ–°ï¼ˆåœ¨å®Œæˆæ—¶ï¼‰

3. **API Endpoint: /api/agent/chat-stream**
   - Server-Sent Events (SSE) æ ‡å‡†
   - å®æ—¶æ¨é€äº‹ä»¶æµ
   - è‡ªåŠ¨é‡è¿æ”¯æŒ

**å‰ç«¯ä½“éªŒ**:
1. **demo-stream.html** - æµå¼æµ‹è¯•é¡µé¢
   - EventSource / Fetch Stream API
   - å®æ—¶æ¥æ”¶SSEäº‹ä»¶
   - æ€è€ƒè¿‡ç¨‹å±•ç¤ºï¼ˆå¯æŠ˜å ï¼‰
   - å†…å®¹é€æ­¥é¢„è§ˆ
   - æœ€ç»ˆç»“æœç¾åŒ–æ¸²æŸ“

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

**ä¼ ç»Ÿæ¨¡å¼**ï¼ˆç­‰å¾…å®Œæ•´å“åº”ï¼‰:
```
ç”¨æˆ·: "ç»™æˆ‘5é“å…‰åˆä½œç”¨çš„é¢˜"
[0s â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 15s]
  â†‘                           â†‘
  å‘é€è¯·æ±‚                    æ˜¾ç¤ºç»“æœ

ç”¨æˆ·ä½“éªŒ: â­â­
- æ„Ÿè§‰å¾ˆæ…¢
- ä¸çŸ¥é“åœ¨å¹²ä»€ä¹ˆ
- å¯èƒ½ä»¥ä¸ºå¡ä½äº†
```

**æµå¼æ¨¡å¼**ï¼ˆå®æ—¶å±•ç¤ºï¼‰:
```
ç”¨æˆ·: "ç»™æˆ‘5é“å…‰åˆä½œç”¨çš„é¢˜"

[0s] æ­£åœ¨åˆ†ææ‚¨çš„è¯·æ±‚...           â† ç«‹å³åé¦ˆ
[1s] å¼€å§‹ç”Ÿæˆé¢˜ç›®...               â† è¿›åº¦æ›´æ–°
[2s] ğŸ§  ç”¨æˆ·è¯·æ±‚å…‰åˆä½œç”¨é¢˜ç›®...    â† æ€è€ƒè¿‡ç¨‹
[3s] ğŸ§  éœ€è¦è€ƒè™‘éš¾åº¦å’Œé¢˜å‹...      â† æ€è€ƒè¿‡ç¨‹
[4s] ğŸ“ é¢˜ç›®1: ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨...   â† å†…å®¹ç”Ÿæˆ
[6s] ğŸ“ é¢˜ç›®2: å…‰åˆä½œç”¨çš„äº§ç‰©...   â† å†…å®¹ç”Ÿæˆ
...
[15s] âœ… å®Œæˆï¼

ç”¨æˆ·ä½“éªŒ: â­â­â­â­â­
- æœ‰å³æ—¶åé¦ˆ
- çŸ¥é“è¿›åº¦
- çœ‹åˆ°æ€è€ƒè¿‡ç¨‹
- ä¸ç„¦è™‘
```

### æ•°æ®æµ

```
Step 1: çŠ¶æ€æ›´æ–°
â†’ {"type": "status", "message": "æ­£åœ¨åˆ†ææ‚¨çš„è¯·æ±‚..."}

Step 2: æ„å›¾è¯†åˆ«å®Œæˆ
â†’ {"type": "status", "message": "å¼€å§‹ç”Ÿæˆé¢˜ç›®..."}

Step 3: æ€è€ƒè¿‡ç¨‹ï¼ˆé€æ­¥ï¼‰
â†’ {"type": "thinking", "text": "ç”¨æˆ·è¯·æ±‚å…³äºå…‰åˆä½œç”¨çš„é¢˜ç›®..."}
â†’ {"type": "thinking", "text": "éœ€è¦è€ƒè™‘éš¾åº¦å’Œé¢˜å‹..."}
â†’ {"type": "thinking", "text": "å‡†å¤‡ç”Ÿæˆ5é“é€‰æ‹©é¢˜..."}

Step 4: å†…å®¹ç”Ÿæˆï¼ˆé€æ­¥ï¼‰
â†’ {"type": "content", "text": "{\n  \"quiz_set_id\": ..."}
â†’ {"type": "content", "text": "  \"questions\": [\n    {"}
â†’ {"type": "content", "text": "      \"question_text\": \"ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨ï¼Ÿ\""}
...

Step 5: å®Œæˆ
â†’ {"type": "done", "thinking": "å®Œæ•´æ€è€ƒ", "content": "å®Œæ•´å†…å®¹"}
```

### æŠ€æœ¯å®ç°

**åç«¯æµå¼ç”Ÿæˆ**:
```python
async def execute_stream(self, intent_result, user_id, session_id):
    """æµå¼æ‰§è¡ŒæŠ€èƒ½"""
    
    # 1. é€‰æ‹©æŠ€èƒ½
    skill = self._select_skill(intent_result)
    yield {"type": "status", "message": f"ä½¿ç”¨ {skill.display_name}"}
    
    # 2. æ„å»ºä¸Šä¸‹æ–‡å’Œå‚æ•°
    context = await self._build_context(skill, user_id, session_id)
    params = self._build_input_params(skill, intent_result, context)
    
    # 3. åŠ è½½prompt
    prompt_content = self._load_prompt(skill)
    prompt = self._format_prompt(prompt_content, params, context)
    
    # 4. æµå¼è°ƒç”¨LLM
    async for chunk in self.gemini_client.generate_stream(
        prompt=prompt,
        model=skill.models["primary"],
        thinking_budget=skill.thinking_budget
    ):
        # è½¬å‘LLMè¾“å‡ºåˆ°å‰ç«¯
        yield chunk
    
    # 5. è§£æå¹¶æ›´æ–°memory
    # ...
```

**å‰ç«¯EventSource**:
```javascript
async function sendMessage(message) {
    const response = await fetch('/api/agent/chat-stream', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: 'demo-user',
            session_id: 'demo-session',
            message: message
        })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, {stream: true});
        const events = buffer.split('\n\n');
        buffer = events.pop();
        
        for (const event of events) {
            if (event.startsWith('data: ')) {
                const data = JSON.parse(event.substring(6));
                handleStreamEvent(data);
            }
        }
    }
}
```

### æ€§èƒ½æŒ‡æ ‡

- **é¦–å­—èŠ‚æ—¶é—´ (TTFB)**: <0.5sï¼ˆç«‹å³åé¦ˆï¼‰
- **æ€è€ƒè¿‡ç¨‹å»¶è¿Ÿ**: ~1-2sï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
- **å®Œæ•´ç”Ÿæˆæ—¶é—´**: ~10-15sï¼ˆä¸éæµå¼ç›¸åŒï¼‰
- **ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ**: â­â­â­â­â­ï¼ˆæ˜¾è‘—æ”¹å–„ï¼‰

### Tokenç»Ÿè®¡

æµå¼æ¨¡å¼ä¸éæµå¼æ¨¡å¼çš„tokenæ¶ˆè€—ç›¸åŒï¼Œä½†ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ï¼š
- **Input tokens**: ä¸€è‡´
- **Output tokens**: ä¸€è‡´
- **Thinking tokens**: ä¸€è‡´ï¼ˆ~200-800ï¼‰
- **Total tokens**: ä¸€è‡´ï¼ˆ~5000-8000ï¼‰

**å…³é”®ä¼˜åŠ¿**: ç›¸åŒçš„æˆæœ¬ï¼Œ10å€çš„ä½“éªŒæå‡ï¼

### æµ‹è¯•

```bash
# æµ‹è¯•Geminiæµå¼API
cd backend
python3 test_streaming.py

# æµ‹è¯•å‰ç«¯æµå¼UI
# 1. å¯åŠ¨åç«¯
cd backend && python3 -m uvicorn app.main:app --reload

# 2. è®¿é—®æµå¼demo
open http://localhost:3000/demo-stream.html
```

### æ³¨æ„äº‹é¡¹

1. **JSONæµå¼è§£æ**: æµå¼ç”Ÿæˆçš„JSONå¯èƒ½ä¸å®Œæ•´ï¼Œéœ€è¦ç´¯ç§¯åè§£æ
2. **é”™è¯¯å¤„ç†**: éƒ¨åˆ†ç”Ÿæˆå¤±è´¥æ—¶çš„ä¼˜é›…é™çº§
3. **è¶…æ—¶å¤„ç†**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ30sï¼‰
4. **å†…å­˜ç®¡ç†**: åœ¨å®Œæˆæ—¶æ›´æ–°memoryï¼Œé¿å…éƒ¨åˆ†æ•°æ®æ±¡æŸ“

### Plan Skill æµå¼æ”¯æŒ

**å½“å‰çŠ¶æ€**: âš ï¸ Plan Skillæš‚ä¸æ”¯æŒå®Œæ•´æµå¼æ¨¡å¼

**å¤„ç†ç­–ç•¥**:
```python
# æ£€æµ‹åˆ°Plan Skillæ—¶ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼
if skill.skill_type == "plan":
    yield {"type": "status", "message": "æ­£åœ¨ç”Ÿæˆå­¦ä¹ åŒ…ï¼ˆå¤šæ­¥éª¤ç”Ÿæˆï¼‰..."}
    result = await self.execute(...)  # ä¼ ç»Ÿæ¨¡å¼
    yield {"type": "done", "thinking": "Plan Skillä¸²è”æ‰§è¡Œï¼šexplain â†’ flashcard â†’ quiz", ...}
```

**ç”¨æˆ·ä½“éªŒ**:
- âœ… æ˜¾ç¤ºçŠ¶æ€ï¼š"æ­£åœ¨ç”Ÿæˆå­¦ä¹ åŒ…..."
- âœ… æ˜¾ç¤ºèšåˆthinking
- âœ… æ˜¾ç¤ºå®Œæ•´ç»“æœ
- âš ï¸ Sub-skillsçš„thinkingä¸ä¼šå®æ—¶æ˜¾ç¤ºï¼ˆæ•´ä½“ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºï¼‰

**æœªæ¥æ”¹è¿›** (V2.2):
- ğŸ”„ å®ç°çœŸæ­£çš„Plan Skillæµå¼æ”¯æŒ
- ğŸ“Š ä¾æ¬¡æµå¼æ˜¾ç¤ºå„ä¸ªsub-skillçš„thinking
- â±ï¸ å®æ—¶çŠ¶æ€æ›´æ–°ï¼š"Step 1/3: ç”Ÿæˆæ¦‚å¿µè®²è§£..."

---

## 4. å‰ç«¯äº¤äº’ç‰¹æ€§

### 4.1 Notebook é£æ ¼ç¬”è®° UI

**ç‰¹æ€§**:
- å¡ç‰‡å¼ç« èŠ‚å±•ç¤º
- æ¸å˜è‰²æ ‡é¢˜
- å¯ç¼–è¾‘æ–‡æœ¬å­—æ®µ
- ç¼–è¾‘/ä¿å­˜/å–æ¶ˆæŒ‰é’®
- æ·»åŠ /åˆ é™¤è¦ç‚¹

**äº¤äº’**:
```javascript
- ç‚¹å‡» "ç¼–è¾‘" â†’ è¿›å…¥ç¼–è¾‘æ¨¡å¼
- ä¿®æ”¹å†…å®¹ â†’ å®æ—¶é¢„è§ˆ
- ç‚¹å‡» "ä¿å­˜" â†’ ä¿å­˜åˆ°åç«¯ï¼ˆè®¡åˆ’ä¸­ï¼‰
- ç‚¹å‡» "+" â†’ æ·»åŠ æ–°è¦ç‚¹
- ç‚¹å‡» "Ã—" â†’ åˆ é™¤è¦ç‚¹
```

---

### 4.2 æ€ç»´å¯¼å›¾æ¸²æŸ“

**åº“**: Mind Elixir (IIFEç‰ˆæœ¬)

**ç‰¹æ€§**:
- äº¤äº’å¼èŠ‚ç‚¹å±•å¼€/æŠ˜å 
- è‡ªåŠ¨å¸ƒå±€
- ä¸»é¢˜æ ·å¼
- å“åº”å¼è®¾è®¡

---

### 4.3 æ·±è‰²æ¨¡å¼

**æ”¯æŒ**:
- è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿåå¥½
- æ‰‹åŠ¨åˆ‡æ¢æŒ‰é’®
- Tailwind CSS darkæ¨¡å¼
- æ‰€æœ‰ç»„ä»¶é€‚é…

---

## 5. æ•°æ®å­˜å‚¨

### 5.1 å¤šç”¨æˆ·å­˜å‚¨æ¶æ„ âœ¨ NEW

**è®¾è®¡ç†å¿µ**ï¼šæ„å»ºå®Œæ•´çš„ç”¨æˆ·ç”»åƒï¼Œæ”¯æŒä¸ªæ€§åŒ–å­¦ä¹ 

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **ç”¨æˆ·ç”»åƒæ„å»º**ï¼šæ‰€æœ‰å­¦ä¹ è®°å½•éƒ½å­˜å‚¨ï¼Œå½¢æˆç”¨æˆ·çŸ¥è¯†å›¾è°±
- ğŸ§  **æ™ºèƒ½æ„å›¾è¯†åˆ«**ï¼šåŸºäºå†å²ä¸Šä¸‹æ–‡ï¼Œæ›´å‡†ç¡®ç†è§£ç”¨æˆ·éœ€æ±‚
- ğŸ“Š **ä¸ªæ€§åŒ–æ¨è**ï¼šæ ¹æ®å­¦ä¹ æ¨¡å¼ï¼Œç”Ÿæˆé€‚é…å†…å®¹
- ğŸ”’ **æ•°æ®éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹å­˜å‚¨ï¼Œä¿æŠ¤éšç§

### 5.2 S3 äº‘å­˜å‚¨ç­–ç•¥

**å­˜å‚¨ç­–ç•¥** (å·²ä¼˜åŒ–)ï¼š
```python
# æ—§ç­–ç•¥ï¼ˆå·²åºŸå¼ƒï¼‰ï¼š
# - å°æ–‡ä»¶ (< 500 bytes) â†’ inline å­˜å‚¨
# - å¤§æ–‡ä»¶ (â‰¥ 500 bytes) â†’ S3 å­˜å‚¨

# æ–°ç­–ç•¥ï¼ˆå½“å‰ï¼‰ï¼š
# - æ‰€æœ‰ artifacts â†’ S3 å­˜å‚¨ âœ…
# - ç›®çš„ï¼šæ„å»ºå®Œæ•´ç”¨æˆ·ç”»åƒ
```

**ä¸ºä»€ä¹ˆå…¨éƒ¨å­˜ S3ï¼Ÿ**
1. **ç”¨æˆ·ç”»åƒå®Œæ•´æ€§**ï¼šç®€å•é—®ç­”ä¹ŸåŒ…å«å­¦ä¹ åå¥½
2. **ä¸Šä¸‹æ–‡è¿ç»­æ€§**ï¼šå†å²è®°å½•ç”¨äºæ„å›¾è¯†åˆ«
3. **ä¸ªæ€§åŒ–åŸºç¡€**ï¼šåˆ†æå­¦ä¹ æ¨¡å¼éœ€è¦å…¨é‡æ•°æ®
4. **æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥çš„æ¨èç³»ç»Ÿå’Œå­¦ä¹ åˆ†æ

**S3 è·¯å¾„ç»“æ„**ï¼š
```
s3://skill-agent-demo/
â””â”€â”€ artifacts/
    â”œâ”€â”€ user_kimi/
    â”‚   â”œâ”€â”€ artifact_explanation_é‡å­çº ç¼ _xxx.json
    â”‚   â”œâ”€â”€ artifact_flashcard_set_é‡å­ç‰©ç†_yyy.json
    â”‚   â””â”€â”€ artifact_quiz_set_ç›¸å¯¹è®º_zzz.json
    â””â”€â”€ user_alex/
        â”œâ”€â”€ artifact_explanation_å…‰åˆä½œç”¨_aaa.json
        â””â”€â”€ artifact_notes_ç»†èƒç»“æ„_bbb.json
```

**ç”¨æˆ·ç”»åƒæ•°æ®æµ**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ æ„å›¾è¯†åˆ« (åŸºäºå†å²) â†’ ç”Ÿæˆå†…å®¹ â†’ å­˜å‚¨ S3
    â†‘                                              â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ›´æ–°ç”¨æˆ·ç”»åƒ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æœ¬åœ°å­˜å‚¨ï¼ˆä¼šè¯ç®¡ç†ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š
```
backend/memory_storage/
â”œâ”€â”€ user_kimi_session_xxx.json    # Kimi ä¼šè¯ä¸Šä¸‹æ–‡
â”œâ”€â”€ user_alex_session_yyy.json    # Alex ä¼šè¯ä¸Šä¸‹æ–‡
â””â”€â”€ thinking_overview_debug.json  # Debug æ•°æ®
```

**ä¼šè¯æ–‡ä»¶æ ¼å¼**ï¼š
```json
{
  "session_id": "user_kimi_session_20251121_110858",
  "user_id": "user_kimi",
  "current_topic": "é‡å­çº ç¼ ",
  "artifacts": [
    {
      "artifact_id": "artifact_explanation_é‡å­çº ç¼ _xxx",
      "artifact_type": "explanation",
      "topic": "é‡å­çº ç¼ ",
      "storage_type": "s3",
      "content_reference": "s3://skill-agent-demo/artifacts/user_kimi/..."
    }
  ],
  "last_updated": "2025-11-21T11:08:58"
}
```

### 5.4 æ•°æ®éš”ç¦»éªŒè¯

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# è¿è¡Œå¤šç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•
cd backend
python3 scripts/test_multi_user_scenario.py

# æ£€æŸ¥æœ¬åœ°ä¼šè¯æ–‡ä»¶
ls -la backend/memory_storage/user_*.json

# æŸ¥çœ‹ S3 å­˜å‚¨ï¼ˆAWS CLIï¼‰
aws s3 ls s3://skill-agent-demo/artifacts/user_kimi/ --recursive
aws s3 ls s3://skill-agent-demo/artifacts/user_alex/ --recursive
```

### 5.5 ä¸Šä¸‹æ–‡è¿ç»­æ€§ç®¡ç† âœ¨ NEW

**å·¥ä½œæµç¨‹**ï¼š
```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
2. åŠ è½½ Session Context
   - è·å–æœ€è¿‘ 3 ä¸ª artifacts
   - åŠ è½½ user profile
   - ç”Ÿæˆ memory summary
   â†“
3. æ„å»º Skill Context
   - åŒ…å«å†å²å¯¹è¯
   - åŒ…å«ç›¸å…³ artifacts
   - åŒ…å«ç”¨æˆ·åå¥½
   â†“
4. æ‰§è¡Œ Skill ç”Ÿæˆå†…å®¹
   â†“
5. ä¿å­˜ Artifact åˆ° S3
   - è‡ªåŠ¨å­˜å‚¨ï¼ˆå…¨é‡ï¼‰
   - æ›´æ–° artifact_history
   - ç»´æŠ¤å¼•ç”¨é“¾
   â†“
6. æ›´æ–° Session Context
   - ä¿å­˜æœ€è¿‘ 20 ä¸ª artifact IDs
   - æ›´æ–° current_topic
   - è®°å½• recent_intents
```

**ä¸Šä¸‹æ–‡å¸è½½ç­–ç•¥**ï¼š
- **Recent Artifacts**ï¼šæœ€è¿‘ 3 ä¸ª artifacts åŠ è½½åˆ°å†…å­˜
- **History Reference**ï¼šä¿ç•™æœ€è¿‘ 20 ä¸ª artifact IDs
- **S3 Full Storage**ï¼šæ‰€æœ‰ artifacts å®Œæ•´å­˜å‚¨åœ¨ S3
- **æŒ‰éœ€åŠ è½½**ï¼šéœ€è¦æ—¶ä» S3 åŠ è½½å†å² artifacts

**åº”ç”¨ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·ï¼šè§£é‡Šé‡å­çº ç¼ 
AIï¼šç”Ÿæˆè¯¦ç»†è§£é‡Š â†’ ä¿å­˜åˆ° S3

ç”¨æˆ·ï¼šç»™æˆ‘5å¼ é—ªå¡
AIï¼šåŠ è½½"é‡å­çº ç¼ "è§£é‡Š â†’ åŸºäºå†…å®¹ç”Ÿæˆé—ªå¡

ç”¨æˆ·ï¼šå†æ¥5é“æµ‹è¯•é¢˜
AIï¼šåŠ è½½è§£é‡Š+é—ªå¡ â†’ ç”Ÿæˆç›¸å…³æµ‹è¯•é¢˜
```

### 5.6 ç”¨æˆ·ç”»åƒåº”ç”¨åœºæ™¯

**å½“å‰å®ç°**ï¼š
- âœ… åŸºäºä¼šè¯çš„ä¸Šä¸‹æ–‡ç®¡ç†
- âœ… ç”¨æˆ·ç‹¬ç«‹çš„ S3 å­˜å‚¨è·¯å¾„
- âœ… Artifact å¼•ç”¨è€Œéå†…å®¹å­˜å‚¨
- âœ… æœ€è¿‘ artifacts è‡ªåŠ¨åŠ è½½
- âœ… ä¸Šä¸‹æ–‡è¿ç»­æ€§ä¿è¯

**æœªæ¥æ‰©å±•**ï¼š
- ğŸ“Š å­¦ä¹ æ¨¡å¼åˆ†æï¼ˆä¸»é¢˜åå¥½ã€éš¾åº¦é€‚é…ï¼‰
- ğŸ¯ æ™ºèƒ½æ¨èï¼ˆåŸºäºå†å²ç”Ÿæˆç›¸å…³å†…å®¹ï¼‰
- ğŸ§  çŸ¥è¯†å›¾è°±ï¼ˆæ„å»ºç”¨æˆ·çŸ¥è¯†ç»“æ„ï¼‰
- ğŸ“ˆ å­¦ä¹ è¿›åº¦è·Ÿè¸ªï¼ˆæŒæ¡åº¦è¯„ä¼°ï¼‰

---

## 6. æ‰©å±•æ€§

### 6.1 æ·»åŠ æ–°æŠ€èƒ½

**æ­¥éª¤**:
1. åˆ›å»º YAML é…ç½®: `backend/skills_config/new_skill.yaml`
2. åˆ›å»º Prompt: `backend/app/prompts/new_skill.txt`
3. æ·»åŠ intent_tagsåˆ°YAML
4. ï¼ˆå¯é€‰ï¼‰æ·»åŠ å‰ç«¯æ¸²æŸ“å‡½æ•°

**YAMLç¤ºä¾‹**:
```yaml
id: "new_skill"
display_name: "æ–°æŠ€èƒ½"
version: "1.0.0"
intent_tags: ["new", "skill_request"]
input_schema:
  type: "object"
  properties:
    topic:
      type: "string"
output_schema:
  type: "object"
  properties:
    result:
      type: "string"
```

---

### 6.2 è‡ªå®šä¹‰è§„åˆ™å¼•æ“

**ä½ç½®**: `backend/app/core/rule_based_classifier.py`

**æ·»åŠ æ–°è§„åˆ™**:
```python
intent_keywords = {
    "new_intent": {
        "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
        "intent": "new_intent",
        "confidence": 0.95
    }
}
```

---

## 7. æœªæ¥è§„åˆ’

### V2 ç‰¹æ€§ (è®¡åˆ’ä¸­)

#### åç«¯ä¼˜åŒ–
- âœ… **KV Cacheä¼˜åŒ–** - ç¼“å­˜å¸¸ç”¨å¯¹è¯context
- âœ… **æ–‡ä»¶ç³»ç»Ÿä½œä¸ºå¤–éƒ¨è®°å¿†** - çŸ¥è¯†åº“é›†æˆ
- âœ… **å¯æ¢å¤å‹ç¼©** - é•¿å¯¹è¯è®°å¿†å‹ç¼©
- âœ… **ä¿ç•™é”™è¯¯å°è¯•** - å­¦ä¹ å¤±è´¥æ¡ˆä¾‹
- âœ… **Prefill Guidance** - å¼•å¯¼å¼ç”Ÿæˆ
- âœ… **åŠ¨æ€Planç®¡ç†** - å¤šæ­¥éª¤ä»»åŠ¡è§„åˆ’
- âœ… **Goal Driftä¿æŠ¤** - é˜²æ­¢ä»»åŠ¡åç¦»

#### å‰ç«¯å¢å¼º
- ğŸ”„ **Memory å†å²è®°å½•æµè§ˆå™¨** - Sidebar ä¸­æŸ¥çœ‹æ‰€æœ‰å†å²å­¦ä¹ è®°å½•
  - **åŠŸèƒ½**: åœ¨ Sidebar æ·»åŠ  "Learning History" å…¥å£
  - **å±•ç¤º**: ä»¥æ—¶é—´çº¿å½¢å¼å±•ç¤ºæ‰€æœ‰ artifact_history
    - æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æœ¬å‘¨ã€æ›´æ—©ï¼‰
    - æ˜¾ç¤ºç¼©ç•¥ä¿¡æ¯ï¼ˆä¸»é¢˜ã€ç±»å‹ã€æ—¶é—´ï¼‰
    - æ”¯æŒæœç´¢å’Œç­›é€‰ï¼ˆæŒ‰ä¸»é¢˜ã€ç±»å‹ã€æ—¥æœŸï¼‰
  - **äº¤äº’**: ç‚¹å‡»ä»»æ„å†å²è®°å½•
    - åœ¨ Chat ç•Œé¢ä¸­å›æº¯æ˜¾ç¤ºè¯¥ artifact çš„å®Œæ•´å†…å®¹
    - æ”¯æŒç»§ç»­åŸºäºè¯¥ artifact æé—®ï¼ˆ"å†å‡º3é“ç±»ä¼¼çš„é¢˜"ï¼‰
    - æ”¯æŒåˆ é™¤/æ ‡è®°æ”¶è—
  - **UI è®¾è®¡**:
    ```
    Sidebar:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ“š Learning History     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ğŸ” Search...            â”‚
    â”‚                         â”‚
    â”‚ ğŸ“… ä»Šå¤©                 â”‚
    â”‚  â”œâ”€ ğŸ“ äºŒæˆ˜å†å²ç¬”è®°      â”‚
    â”‚  â”‚   10:30 AM          â”‚
    â”‚  â””â”€ â“ å…‰åˆä½œç”¨é¢˜ç›® (5)  â”‚
    â”‚      09:15 AM          â”‚
    â”‚                         â”‚
    â”‚ ğŸ“… æ˜¨å¤©                 â”‚
    â”‚  â”œâ”€ ğŸ´ ç‰›é¡¿å®šå¾‹é—ªå¡ (10) â”‚
    â”‚  â””â”€ ğŸ—ºï¸ å¾®ç§¯åˆ†æ€ç»´å¯¼å›¾    â”‚
    â”‚                         â”‚
    â”‚ ğŸ”½ æœ¬å‘¨                 â”‚
    â”‚ ğŸ”½ æ›´æ—©                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    ç‚¹å‡»å â†’ Chat ç•Œé¢:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ’¬ Chat                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ [å›æº¯] 2024-11-18 10:30 â”‚
    â”‚                         â”‚
    â”‚ ğŸ“ äºŒæˆ˜å†å²ç¬”è®°          â”‚
    â”‚                         â”‚
    â”‚ [å®Œæ•´å†…å®¹å±•ç¤º...]        â”‚
    â”‚                         â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ åŸºäºæ­¤å†…å®¹ç»§ç»­å¯¹è¯   â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```
  - **æŠ€æœ¯æ–¹æ¡ˆ**:
    - **å‰ç«¯**: åœ¨ `demo.html` ä¸­å®ç° Sidebar
      - æ·»åŠ å·¦ä¾§ Sidebar å®¹å™¨ï¼ˆHTML/CSSï¼‰
      - JavaScript å®ç°å†å²è®°å½•åŠ è½½å’Œæ¸²æŸ“
      - æ”¯æŒæœç´¢ç­›é€‰çš„äº¤äº’é€»è¾‘
      - ç‚¹å‡»å›æº¯æ˜¾ç¤ºåœ¨ Chat åŒºåŸŸ
    - **åç«¯**: æ–°å¢ API ç«¯ç‚¹
      - `GET /api/sessions/{session_id}/artifacts`
        - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æœç´¢
        - è¿”å›æŒ‰æ—¥æœŸåˆ†ç»„çš„å†å²è®°å½•
    - **æ€§èƒ½ä¼˜åŒ–**: 
      - å‰ç«¯ç¼“å­˜å·²åŠ è½½çš„å†å²è®°å½•
      - æ‡’åŠ è½½ï¼ˆæ»šåŠ¨åˆ°åº•éƒ¨åŠ è½½æ›´å¤šï¼‰
      - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§é‡å†å²è®°å½•ï¼‰

### V3 ç‰¹æ€§ (è§„åˆ’ä¸­)

- å¤šæ¨¡æ€æ”¯æŒï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ï¼‰
- å®æ—¶åä½œå­¦ä¹ 
- è‡ªé€‚åº”éš¾åº¦è°ƒæ•´
- å­¦ä¹ è·¯å¾„æ¨è
- ç¤¾åŒºçŸ¥è¯†åº“

---

## 8. Phase 4 æ¶æ„å±•æœ›ï¼šSkill Registry é©±åŠ¨

### 8.1 è®¾è®¡ç›®æ ‡

**æ ¸å¿ƒç†å¿µ**: Intent ä¸å†ç”¨ Prompt è¯†åˆ« â†’ æ”¹ä¸º Skill Registry åŒ¹é…ï¼ˆ0 tokenï¼‰

**ä¼˜åŒ–ç›®æ ‡**:
- âœ… Intent Router Token æ¶ˆè€—: **4,500 â†’ 0** (100% èŠ‚çœ)
- âœ… å“åº”æ—¶é—´: **<0.001s** (çº¯ä»£ç åŒ¹é…)
- âœ… æ¶æ„ç®€åŒ–: ç§»é™¤ LLM ä¾èµ–ï¼ˆIntent Routerï¼‰
- âœ… å¯æ‰©å±•æ€§: æ·»åŠ æ–° Skill åªéœ€æ–°å¢ skill.md

---

### 8.2 æ¶æ„å¯¹æ¯”

#### Phase 3 (å½“å‰)

```
User Message
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Intent Router                       â”‚
â”‚ 1. Rule Engine (70%, 0 tokens) âœ…   â”‚
â”‚ 2. LLM Fallback (30%, ~1,500) âš ï¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Skill Orchestrator â†’ Skill Execution

Token: 4,500 tokens / 10è½®å¯¹è¯
```

**é—®é¢˜**:
- âŒ 30% è¯·æ±‚ä»éœ€ LLM
- âŒ Skill å®šä¹‰åˆ†æ•£ï¼ˆYAML + Promptï¼‰
- âŒ Intent Router Prompt åŒ…å« Skill ä¿¡æ¯ï¼ˆå†—ä½™ï¼‰

#### Phase 4 (æœªæ¥)

```
User Message
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Skill Registry Matcher              â”‚
â”‚ (100%, 0 tokens) âœ…                  â”‚
â”‚                                     â”‚
â”‚ 1. Load skill.md                   â”‚
â”‚ 2. Keyword matching                â”‚
â”‚ 3. Parameter extraction            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Skill Instance â†’ Skill Execution

Token: 0 tokens / 10è½®å¯¹è¯ ğŸ‰
```

**ä¼˜åŠ¿**:
- âœ… 100% æ„å›¾è¯†åˆ« 0 token
- âœ… Skill å®šä¹‰ç»Ÿä¸€ï¼ˆskill.mdï¼‰
- âœ… Prompt åªç”¨äºæŠ€èƒ½æ‰§è¡Œ
- âœ… æ˜“äºæ‰©å±•

---

### 8.3 æ ¸å¿ƒç»„ä»¶

#### Skill Metadata (skill.md)

**æ–‡ä»¶ç»“æ„**:
```
backend/skills/
â”œâ”€â”€ quiz_skill/
â”‚   â”œâ”€â”€ skill.md     â† æŠ€èƒ½å®šä¹‰ï¼ˆç»“æ„åŒ–ï¼‰
â”‚   â””â”€â”€ prompt.txt   â† æ‰§è¡Œæç¤ºï¼ˆä»…ç”¨äº LLMï¼‰
â”œâ”€â”€ explain_skill/
â”‚   â”œâ”€â”€ skill.md
â”‚   â””â”€â”€ prompt.txt
â””â”€â”€ ...
```

**skill.md æ ¼å¼**:
```markdown
# Quiz Skill - ç»ƒä¹ é¢˜ç”Ÿæˆ

## Metadata
- **ID**: quiz_skill
- **Display Name**: ç»ƒä¹ é¢˜ç”Ÿæˆ
- **Version**: 1.0.0

## Intent Triggers
### Primary Keywords
- é¢˜, é¢˜ç›®, ç»ƒä¹ , quiz, test

### Quantity Patterns
- \d+é“é¢˜ â†’ quantity
- \d+ä¸ªé—®é¢˜ â†’ quantity

### Topic Patterns
- {quantity}é“{topic}çš„é¢˜ â†’ topic
- å…³äº{topic}çš„ç»ƒä¹  â†’ topic

## Input Schema
{
  "topic": "string (required)",
  "quantity": "integer (default: 5)",
  "difficulty": "enum[easy, medium, hard]",
  "source_content": "object (optional)"
}

## Output Schema
{
  "quiz_set_id": "string",
  "questions": [...]
}

## Examples
- "ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜" â†’ quiz_skill(topic="äºŒæˆ˜å†å²", quantity=5)
- "å‡ºé¢˜ç›®" â†’ quiz_skill(topic=None) â†’ Clarification
```

#### Skill Registry

**åŠŸèƒ½**:
```python
class SkillRegistry:
    def match_message(self, message: str) -> SkillMatch:
        """
        åŒ¹é…ç”¨æˆ·æ¶ˆæ¯åˆ°æŠ€èƒ½ (0 tokens)
        
        æµç¨‹:
        1. åŠ è½½æ‰€æœ‰ skill.md
        2. å…³é”®è¯åŒ¹é…
        3. å‚æ•°æå–ï¼ˆæ­£åˆ™ï¼‰
        4. è®¡ç®—ç½®ä¿¡åº¦
        
        è¿”å›:
        - skill_id: åŒ¹é…çš„æŠ€èƒ½
        - confidence: åŒ¹é…ç½®ä¿¡åº¦
        - parameters: æå–çš„å‚æ•°
        """
```

#### Intent Router (ç®€åŒ–ç‰ˆ)

**æ–°é€»è¾‘**:
```python
class IntentRouter:
    def parse(self, message: str) -> IntentResult:
        # 1. Skill Registry åŒ¹é… (0 tokens)
        match = self.skill_registry.match_message(message)
        
        if match and match.confidence >= 0.8:
            return IntentResult(
                intent=match.skill_id,
                topic=match.parameters.get("topic"),
                parameters=match.parameters
            )
        
        # 2. Fallback: other intent (ä»ç„¶ 0 tokens)
        return IntentResult(intent="other", topic=None)
```

**ç§»é™¤**:
- âŒ gemini_client
- âŒ rule_based_classifier
- âŒ LLM fallback é€»è¾‘
- âŒ Prompt template

---

### 8.4 æ€§èƒ½é¢„æœŸ

#### Token æ¶ˆè€—ï¼ˆ10è½®å¯¹è¯ï¼‰

| æ¶æ„ | Intent Router | Skill Execution | æ€»è®¡ | ä¼˜åŒ– |
|------|--------------|----------------|------|------|
| Phase 1 (çº¯LLM) | 31,320 | ~60,000 | 91,320 | - |
| Phase 3 (è§„åˆ™å¼•æ“) | 4,500 | ~60,000 | 64,500 | -29% |
| **Phase 4 (Skill Registry)** | **0** | **~60,000** | **~60,000** | **-34%** âœ… |

**Intent Router Token èŠ‚çœ**:
- Phase 3 â†’ Phase 4: 4,500 â†’ 0 (**-100%**)

#### å“åº”æ—¶é—´

| æ¶æ„ | Intent Router | ä¼˜åŒ– |
|------|--------------|------|
| Phase 1 (çº¯LLM) | ~2.0s | - |
| Phase 3 (è§„åˆ™å¼•æ“) | <0.01s (70%) / ~1.6s (30%) | -92% |
| **Phase 4 (Skill Registry)** | **<0.001s (100%)** | **-99.95%** âœ… |

#### æ¶æ„å¤æ‚åº¦

| æŒ‡æ ‡ | Phase 3 | Phase 4 | ä¼˜åŒ– |
|------|---------|---------|------|
| Intent Router LOC | ~500 è¡Œ | **~200 è¡Œ** | -60% âœ… |
| ä¾èµ– LLM | æ˜¯ (30%) | **å¦** | âœ… |
| Skill å®šä¹‰ | YAML + Prompt | **skill.md** | âœ… |
| å¯æ‰©å±•æ€§ | ä¸­ç­‰ | **é«˜** | âœ… |
| ç»´æŠ¤æˆæœ¬ | ä¸­ç­‰ | **ä½** | âœ… |

---

### 8.5 å®æ–½è®¡åˆ’

#### Phase 1: åˆ›å»º skill.md (2-3å°æ—¶)

**ä»»åŠ¡**:
- ä¸º 6 ä¸ªæŠ€èƒ½åˆ›å»º skill.md
- å®šä¹‰ Intent Triggersã€Input/Output Schema
- è¿ç§»ç°æœ‰ YAML é…ç½®

**æ–‡ä»¶**:
```
backend/skills/
â”œâ”€â”€ quiz_skill/skill.md
â”œâ”€â”€ explain_skill/skill.md
â”œâ”€â”€ flashcard_skill/skill.md
â”œâ”€â”€ notes_skill/skill.md
â”œâ”€â”€ mindmap_skill/skill.md
â””â”€â”€ learning_bundle_skill/skill.md
```

#### Phase 2: å¢å¼º Skill Registry (1-2å°æ—¶)

**åŠŸèƒ½**:
- `_load_all_skills()`: åŠ è½½æ‰€æœ‰ skill.md
- `_parse_skill_md()`: è§£æ Markdown æ ¼å¼
- `match_message()`: åŒ¹é…ç”¨æˆ·æ¶ˆæ¯ï¼ˆ0 tokensï¼‰
- `_calculate_confidence()`: è®¡ç®—åŒ¹é…ç½®ä¿¡åº¦

#### Phase 3: ç®€åŒ– Intent Router (30åˆ†é’Ÿ)

**ç§»é™¤**:
- LLM fallback é€»è¾‘
- Prompt template åŠ è½½
- Gemini client ä¾èµ–

**ä¿ç•™**:
- `parse()` æ–¹æ³•ï¼ˆç®€åŒ–ä¸ºè°ƒç”¨ Skill Registryï¼‰
- IntentResult æ„å»º

#### Phase 4: æµ‹è¯•å’ŒéªŒè¯ (1å°æ—¶)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# æ˜ç¡®è¯·æ±‚
assert match("ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜").skill_id == "quiz_skill"
assert match("ç»™æˆ‘5é“äºŒæˆ˜å†å²çš„é¢˜").parameters == {
    "topic": "äºŒæˆ˜å†å²",
    "quantity": 5
}

# æ— ä¸»é¢˜ï¼ˆè§¦å‘ Clarificationï¼‰
assert match("å‡ºé¢˜ç›®").parameters["topic"] is None

# ä¸Šä¸‹æ–‡å¼•ç”¨
assert match("è§£é‡Šä¸€ä¸‹ç¬¬ä¸€é“é¢˜").parameters == {
    "use_last_artifact": True,
    "reference_index": 0
}

# æœªåŒ¹é…
assert match("ä½ å¥½") is None  # Fallback to "other"
```

**æ€»æ—¶é—´**: 4-6 å°æ—¶

---

### 8.6 å…¼å®¹æ€§ç­–ç•¥

**æ¸è¿›å¼è¿ç§»**:
```python
class IntentRouter:
    def parse(self, message: str) -> IntentResult:
        # 1. ä¼˜å…ˆï¼šSkill Registry (0 tokens)
        match = self.skill_registry.match_message(message)
        if match and match.confidence >= 0.8:
            return self._build_result(match)
        
        # 2. Fallbackï¼šè§„åˆ™å¼•æ“ (Phase 3, 0 tokens)
        rule_result = self.rule_classifier.classify(message)
        if rule_result:
            return rule_result
        
        # 3. æœ€ç»ˆï¼šLLM (å¯é€‰ï¼Œé€æ­¥ç§»é™¤)
        # return self._llm_fallback(message)  # â† æœªæ¥ç§»é™¤
        
        # 4. é»˜è®¤ï¼šother intent
        return IntentResult(intent="other", topic=None)
```

**ä¼˜åŠ¿**:
- âœ… ä¸ç ´åç°æœ‰åŠŸèƒ½
- âœ… é€æ­¥æé«˜ Skill Registry åŒ¹é…ç‡
- âœ… æœ€ç»ˆå®Œå…¨ç§»é™¤ LLM ä¾èµ–

---

### 8.7 é¢„æœŸæ”¶ç›Š

#### Token æˆæœ¬

**10è½®å¯¹è¯**:
- Phase 3: 64,500 tokens (Intent: 4,500 + Skill: 60,000)
- Phase 4: **60,000 tokens** (Intent: 0 + Skill: 60,000)
- **èŠ‚çœ**: 4,500 tokens / 10è½® = **450 tokens/è½®**

**100è½®å¯¹è¯**:
- Phase 3: 645,000 tokens
- Phase 4: **600,000 tokens**
- **èŠ‚çœ**: 45,000 tokens (**$0.07 @ Gemini Flash ä»·æ ¼**)

#### å“åº”é€Ÿåº¦

- Intent Router: **<0.001s** (vs Phase 3 å¹³å‡ ~0.5s)
- æ€»å“åº”æ—¶é—´: **-10%** (å‡å°‘ 0.5s å»¶è¿Ÿ)

#### æ¶æ„è´¨é‡

- **ä»£ç é‡**: -60% (Intent Router)
- **ç»´æŠ¤æˆæœ¬**: -70% (æ— éœ€ç»´æŠ¤ LLM prompt)
- **æ‰©å±•æ€§**: +100% (æ·»åŠ æ–° Skill åªéœ€æ–°å¢ skill.md)
- **å¯æµ‹è¯•æ€§**: +100% (çº¯ä»£ç é€»è¾‘ï¼Œæ˜“æµ‹è¯•)

---

### 8.8 æŠ€æœ¯æŒ‘æˆ˜

#### æŒ‘æˆ˜ 1: å¤æ‚è¯­ä¹‰ç†è§£

**é—®é¢˜**: "æ ¹æ®åˆšæ‰åŒ—æå†°å·èåŒ–çš„é‚£ä¸ªä¾‹å­å‡º3é“é¢˜"
**ç°çŠ¶**: LLM ç†è§£å¤æ‚å¼•ç”¨
**æ–¹æ¡ˆ**: 
- Skill Registry è¯†åˆ« "å‡ºé¢˜" â†’ quiz_skill
- å‚æ•°æå–: "åŒ—æå†°å·èåŒ–" (å…³é”®è¯åŒ¹é…)
- ä¸Šä¸‹æ–‡ç®¡ç†: Orchestrator è´Ÿè´£ï¼ˆå·²æœ‰ï¼‰

#### æŒ‘æˆ˜ 2: æ¨¡ç³Šæ„å›¾

**é—®é¢˜**: "å¸®æˆ‘å­¦ä¹ ä¸€ä¸‹"
**ç°çŠ¶**: LLM æ¨æ–­ç”¨æˆ·åå¥½
**æ–¹æ¡ˆ**:
- Fallback åˆ° Clarificationï¼ˆå·²æœ‰ï¼‰
- å±•ç¤ºæ‰€æœ‰å¯ç”¨ Skills
- ç”¨æˆ·é€‰æ‹©åå†æ‰§è¡Œ

#### æŒ‘æˆ˜ 3: æ–°å¢ Skill

**é—®é¢˜**: å¦‚ä½•å¿«é€Ÿæ‰©å±•æ–°æŠ€èƒ½ï¼Ÿ
**æ–¹æ¡ˆ**:
- åˆ›å»º skill.mdï¼ˆ5-10åˆ†é’Ÿï¼‰
- Skill Registry è‡ªåŠ¨åŠ è½½
- æ— éœ€ä¿®æ”¹ Intent Router ä»£ç  âœ…

---

### 8.9 å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é˜¶æ®µ | æ—¶é—´ | æ”¶ç›Š | é£é™© |
|-------|------|------|------|------|
| ğŸ”´ é«˜ | Phase 1: åˆ›å»º skill.md | 2-3h | æ˜ç¡® Skill å®šä¹‰ | ä½ |
| ğŸ”´ é«˜ | Phase 2: å¢å¼º Skill Registry | 1-2h | 0 token åŒ¹é… | ä½ |
| ğŸŸ¡ ä¸­ | Phase 3: ç®€åŒ– Intent Router | 30min | ç§»é™¤ LLM | ä¸­ |
| ğŸŸ¢ ä½ | Phase 4: æµ‹è¯•éªŒè¯ | 1h | ç¡®ä¿æ­£ç¡®æ€§ | ä½ |

**æ€»æ—¶é—´**: 4-6 å°æ—¶
**é¢„æœŸå®Œæˆ**: V2.1 ç‰ˆæœ¬

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

### åŠŸèƒ½å®Œæˆåº¦

- **æ ¸å¿ƒæŠ€èƒ½**: 6/6 å®Œæˆ âœ…
  - æ¦‚å¿µè®²è§£ã€ç»ƒä¹ é¢˜ç”Ÿæˆã€æŠ½è®¤å¡ç”Ÿæˆã€æ€ç»´å¯¼å›¾ã€ç¬”è®°ç”Ÿæˆã€å­¦ä¹ åŒ…
- **æ™ºèƒ½Agentèƒ½åŠ›**: 100% å®Œæˆ âœ…
  - ä¸Šä¸‹æ–‡æ¨æ–­ã€æ„å›¾è¯†åˆ«ã€åå¥½å­¦ä¹ ã€å¤šæŠ€èƒ½ç¼–æ’
- **Phase 3 æ¶æ„ä¼˜åŒ–**: 100% å®Œæˆ âœ…
  - æ··åˆ Intent Routerï¼ˆè§„åˆ™å¼•æ“ + LLMï¼‰
  - Minimal Intent Routerï¼ˆç²¾ç®€ä¸Šä¸‹æ–‡ï¼‰
  - Token ä¼˜åŒ–ï¼ˆå¹³å‡èŠ‚çœ 85.6%ï¼‰
  - æ¾„æ¸…æœºåˆ¶ï¼ˆClarification + Onboardingï¼‰
  - Artifact Historyï¼ˆå¤šè½®å¼•ç”¨ï¼‰
  - æœ¬åœ°æŒä¹…åŒ–è°ƒè¯•ï¼ˆJSON è¾“å‡ºï¼‰
- **å‰ç«¯UI**: 100% å®Œæˆ âœ…
  - Notebook é£æ ¼ç¬”è®°ç¼–è¾‘å™¨
  - æ€ç»´å¯¼å›¾æ¸²æŸ“
  - Clarification/Onboarding å¡ç‰‡
  - æ·±è‰²æ¨¡å¼
- **æ•°æ®æŒä¹…åŒ–**: 80% å®Œæˆ
  - âœ… å†…å­˜ + æœ¬åœ° JSON æ–‡ä»¶
  - ğŸ”„ SQLite æŒä¹…åŒ–ï¼ˆV2 è§„åˆ’ï¼‰

### ä»£ç ç»Ÿè®¡

- **æ€»ä»£ç è¡Œæ•°**: ~15,000è¡Œ
- **Pythonåç«¯**: ~8,000è¡Œ
- **Frontend**: ~3,000è¡Œ
- **é…ç½®æ–‡ä»¶**: ~1,000è¡Œ
- **æ–‡æ¡£**: ~3,000è¡Œ

---

<div align="center">
  ğŸ“š æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ <a href="README.md">README.md</a> å’Œ <a href="TESTING.md">TESTING.md</a>
</div>
