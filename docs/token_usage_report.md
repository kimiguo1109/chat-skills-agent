# Token 消耗报告

> 测试日期: 2025-11-28  
> 测试场景: 25 轮复杂对话  
> API 端点: `/api/chat/send`

---

## 📊 总体汇总

| 指标 | 数值 |
|------|------|
| **总请求数** | 25 |
| **总 Token 消耗** | 23,806 |
| **平均 Token/轮** | 952 |
| **LLM 模型** | gemini-2.0-flash-exp |

---

## 📈 分场景 Token 消耗

| 场景 | 轮次 | 总 Token | 平均/轮 | 占比 |
|------|------|----------|---------|------|
| Scenario 1: 单主题深入 | 10 | 8,983 | 898 | 37.7% |
| Scenario 2: 主题切换 | 5 | 5,187 | 1,037 | 21.8% |
| Scenario 3: 多模态输入 | 5 | 4,602 | 920 | 19.3% |
| Scenario 4: 复杂引用 | 5 | 5,034 | 1,006 | 21.2% |
| **总计** | **25** | **23,806** | **952** | **100%** |

---

## 📉 Token 消耗趋势

### 逐轮详情

| Turn | Token | 场景 | 说明 |
|------|-------|------|------|
| T1 | 882 | S1 | 开始学习牛顿定律 |
| T2 | 631 | S1 | 深入第一定律 |
| T3 | 694 | S1 | 追问惯性 |
| T4 | 780 | S1 | 请求举例 |
| T5 | 931 | S1 | 继续第二定律 |
| T6 | 1,393 | S1 | F=ma 详解 (峰值) |
| T7 | 731 | S1 | 计算题 |
| T8 | 1,001 | S1 | 第三定律 |
| T9 | 1,084 | S1 | 作用力反作用力 |
| T10 | 856 | S1 | 总结三定律 |
| T11 | 1,012 | S2 | 切换化学 |
| T12 | 1,016 | S2 | 共价键 |
| T13 | 983 | S2 | 切换历史 |
| T14 | 1,191 | S2 | 凡尔赛条约 |
| T15 | 985 | S2 | 跨主题关联 |
| T16 | 924 | S3 | 图片识别 |
| T17 | 1,150 | S3 | 图片追问 |
| T18 | 721 | S3 | 文档理解 |
| T19 | 912 | S3 | 多文档比较 |
| T20 | 895 | S3 | 图文关联 |
| T21 | 1,271 | S4 | 回溯物理 (峰值) |
| T22 | 900 | S4 | 跨学科关联 |
| T23 | 720 | S4 | 模糊引用 |
| T24 | 1,148 | S4 | 深度追问 |
| T25 | 995 | S4 | 全局总结 |

### 趋势分析

```
前 5 轮: [882, 631, 694, 780, 931]  平均: 783 tokens
后 5 轮: [1271, 900, 720, 1148, 995] 平均: 1,006 tokens

增长率: +28.5% (上下文累积导致)
```

---

## 🔍 上下文管理效果

### Token 节省对比

| 策略 | 估算 Token | 节省 |
|------|-----------|------|
| **当前策略（滑动窗口 5 轮）** | 23,806 | 基准 |
| 无上下文管理 | ~82,050 | -71.0% |
| 完全累积（无压缩） | ~68,806 | -65.4% |

### 当前策略

| 机制 | 状态 | 效果 |
|------|------|------|
| 滑动窗口 | ✅ | 只加载最近 5 轮 |
| 历史裁剪 | ✅ | 旧对话自动卸载 |
| 内容摘要 | ✅ | 长内容压缩 |
| MD 持久化 | ✅ | 完整历史可回溯 |

---

## 💰 成本估算

### Gemini 2.0 Flash 定价

| 类型 | 单价 |
|------|------|
| Input | $0.075 / 1M tokens |
| Output | $0.30 / 1M tokens |

### 本次测试成本

| 项目 | Token | 成本 |
|------|-------|------|
| Input (~70%) | 16,664 | $0.00125 |
| Output (~30%) | 7,142 | $0.00214 |
| **总计** | **23,806** | **$0.0034** |

```
每轮成本: $0.00014 (~¥0.001)
25轮对话: $0.0034 (~¥0.025)
```

---

## 📋 Token 分布可视化

```
Token 消耗分布 (每轮)
═══════════════════════════════════════════════════════════

T1  ████████░░░░░░░░░░░░  882
T2  ██████░░░░░░░░░░░░░░  631
T3  ██████░░░░░░░░░░░░░░  694
T4  ███████░░░░░░░░░░░░░  780
T5  █████████░░░░░░░░░░░  931
T6  █████████████░░░░░░░  1,393 ← 峰值(详细公式讲解)
T7  ███████░░░░░░░░░░░░░  731
T8  ██████████░░░░░░░░░░  1,001
T9  ██████████░░░░░░░░░░  1,084
T10 ████████░░░░░░░░░░░░  856
T11 ██████████░░░░░░░░░░  1,012
T12 ██████████░░░░░░░░░░  1,016
T13 █████████░░░░░░░░░░░  983
T14 ███████████░░░░░░░░░  1,191
T15 █████████░░░░░░░░░░░  985
T16 █████████░░░░░░░░░░░  924
T17 ███████████░░░░░░░░░  1,150
T18 ███████░░░░░░░░░░░░░  721
T19 █████████░░░░░░░░░░░  912
T20 ████████░░░░░░░░░░░░  895
T21 ████████████░░░░░░░░  1,271 ← 峰值(跨主题回溯)
T22 █████████░░░░░░░░░░░  900
T23 ███████░░░░░░░░░░░░░  720
T24 ███████████░░░░░░░░░  1,148
T25 █████████░░░░░░░░░░░  995

平均: ██████████░░░░░░░░░░  952
═══════════════════════════════════════════════════════════
```

---

## 📌 优化建议

| 建议 | 优先级 | 预期效果 |
|------|--------|---------|
| 启用 Gemini Context Caching | 🔴 高 | 重复 context 免费 |
| 调整窗口到 3 轮 | 🟡 中 | 减少 ~20% input |
| 更激进的历史压缩 | 🟢 低 | 当前已节省 65%+ |

---

## 📁 相关文件

| 文件 | 路径 |
|------|------|
| Token 统计 | `backend/token_stats/token_stats_2025-11-28.json` |
| Session MD | `backend/artifacts/{user_id}/{session_id}.md` |
| 测试脚本 | `test_chat.sh` |
