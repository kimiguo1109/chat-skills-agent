# Pure Chat API 完整测试报告

> 测试日期: 2025-11-28  
> API 端点: `POST /api/chat/send`  
> 测试场景: **49 轮**纯 Chat 对话（含跨时间会话恢复）

---

## 📋 API 调用示例

### 基础请求

```bash
curl -s http://13.52.175.51:8088/api/chat/send \
  -H "Content-Type: application/json" \
  -d '{
    "message": "你好，我想学习物理",
    "user_id": "test_user",
    "session_id": "session_001"
  }'
```

### 带图片

```bash
curl -s http://13.52.175.51:8088/api/chat/send \
  -H "Content-Type: application/json" \
  -d '{
    "message": "这张图片是什么",
    "user_id": "test_user",
    "session_id": "session_001",
    "file_uris": ["gs://kimi-dev/images.jpeg"]
  }'
```

### 带文档

```bash
curl -s http://13.52.175.51:8088/api/chat/send \
  -H "Content-Type: application/json" \
  -d '{
    "message": "比较这两个文件",
    "user_id": "test_user",
    "session_id": "session_001",
    "file_uris": [
      "gs://kimi-dev/ap 美国历史sample.txt",
      "gs://kimi-dev/ap 美国历史sample 2.txt"
    ]
  }'
```

---

## 📊 测试结果汇总

| 指标 | 数值 |
|------|------|
| **总测试轮次** | 49 |
| **通过率** | 100% |
| **总 Token 消耗** | 44,526 |
| **平均 Token/轮** | 908 |
| **新会话轮次** | 38 |
| **历史会话恢复轮次** | 11 |

---

## 🧪 测试场景

### Part 1: 基础对话 (5轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 1 | 你好，我想学习牛顿三大定律 | T1 | 0 | 0 | 643 |
| 2 | 先讲讲第一定律吧 | T2 | 1 | 0 | 601 |
| 3 | 什么是惯性 | T3 | 2 | 0 | 706 |
| 4 | 能举个汽车的例子吗 | T4 | 3 | 0 | 708 |
| 5 | 好的，讲讲第二定律 | T5 | 4 | 0 | 925 |

**小计**: 3,583 tokens (平均 716/轮)

---

### Part 2: 深入学习 - 窗口卸载 (5轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 6 | F=ma 这个公式怎么用 | T6 | 5 | 0 | 1,353 |
| 7 | 如果质量是5kg，加速度是2，力是多少 | T7 | 5 | 0 | 720 |
| 8 | 第三定律呢 | T8 | 5 | 2 | 1,161 |
| 9 | 什么是作用力和反作用力 | T9 | 5 | 1 | 1,169 |
| 10 | 帮我总结一下牛顿三大定律 | T10 | 5 | 2 | 948 |

**小计**: 5,351 tokens (平均 1,070/轮)

> 📌 从 T6 开始，滑动窗口生效，只加载最近 5 轮

---

### Part 3: 主题切换 (3轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 11 | 换个话题，讲讲化学键 | T11 | 5 | 0 | 997 |
| 12 | 什么是共价键 | T12 | 5 | 0 | 1,041 |
| 13 | 好，换成历史，二战是怎么开始的 | T13 | 5 | 0 | 1,053 |

**小计**: 3,091 tokens (平均 1,030/轮)

---

### Part 4: 🔎 智能检索测试 (3轮)

| # | 消息 | 引用类型 | Turn | 加载 | 检索 | Token |
|---|------|----------|------|------|------|-------|
| 14 | 回到最开始讲的物理，惯性是什么来着 | 时间 | T14 | 5 | **3** | 1,152 |
| 15 | 第一个问题讲的是什么 | 索引 | T15 | 5 | **1** | 770 |
| 16 | 牛顿定律那部分内容我没太懂 | 关键词 | T16 | 5 | **3** | 912 |

**小计**: 2,834 tokens (平均 944/轮)

> ✅ 智能检索成功触发，从 MD 恢复早期对话

---

### Part 5: 📷 图片识别 (2轮)

| # | 消息 | 附件 | Turn | Token |
|---|------|------|------|-------|
| 17 | 这张图片是什么 | 📷 images.jpeg | T17 | 677 |
| 18 | 图中的结构有什么功能 | - | T18 | 664 |

**小计**: 1,341 tokens (平均 670/轮)

---

### Part 6: 📄 文档理解 (3轮)

| # | 消息 | 附件 | Turn | Token |
|---|------|------|------|-------|
| 19 | 这个文件讲了什么 | 📄 伊利运河 | T19 | 792 |
| 20 | 比较这两个文件 | 📄×2 | T20 | 699 |
| 21 | 伊利运河对美国经济有什么影响 | - | T21 | 1,040 |

**小计**: 2,531 tokens (平均 843/轮)

---

### Part 7: 复杂上下文引用 (4轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 22 | 刚才那个公式怎么用来着 | T22 | 5 | 0 | 734 |
| 23 | 我还是不太懂，能再解释一次吗 | T23 | 5 | 0 | 718 |
| 24 | 这个知识点和之前的化学有关系吗 | T24 | 5 | **3** | 980 |
| 25 | 帮我总结今天学的所有内容 | T25 | 5 | 0 | 891 |

**小计**: 3,323 tokens (平均 830/轮)

---

### Part 8: 🔄 跨时间会话恢复 (5轮) 🆕

> 📌 **切换到历史会话 `session_1764323548`**  
> 📌 该会话已有 25 轮对话 (牛顿定律→化学键→二战→文档)

| # | 消息 | Turn | 加载 | 检索 | Token | 说明 |
|---|------|------|------|------|-------|------|
| 26 | 你好，我回来了 | T26 | 5 | 0 | 653 | ✅ 会话恢复成功 |
| 27 | 我们之前学了什么内容 | T27 | 5 | **3** | 1,045 | ✅ 检索历史主题 |
| 28 | F=ma 的计算题再给我讲一遍 | T28 | 5 | **2** | 1,393 | ✅ 恢复物理上下文 |
| 29 | 之前的化学键和共价键还记得吗 | T29 | 5 | **3** | 918 | ✅ 恢复化学上下文 |
| 30 | 伊利运河的内容帮我复习一下 | T30 | 5 | 0 | 885 | ✅ 恢复文档内容 |

**小计**: 4,894 tokens (平均 978/轮)

> 🎯 **跨时间会话恢复验证成功！** 系统能够从 MD 持久化文件中恢复历史对话上下文。

---

### Part 9: 📊 深度上下文测试 (3轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 31 | 第一定律和第三定律有什么区别 | T31 | 5 | 0 | 958 |
| 32 | 能用一个例子同时解释三大定律吗 | T32 | 5 | 0 | 1,046 |
| 33 | 如果我开车，这三个定律怎么体现 | T33 | 5 | **1** | 1,219 |

**小计**: 3,223 tokens (平均 1,074/轮)

---

### Part 10: 🎯 精确引用测试 (3轮)

| # | 消息 | Turn | 加载 | 检索 | Token | 说明 |
|---|------|------|------|------|-------|------|
| 34 | 你之前举的汽车例子是什么 | T34 | 5 | **3** | 1,310 | ✅ 精确回忆 |
| 35 | 质量5kg加速度2的那道题答案是多少 | T35 | 5 | 0 | 773 | ✅ 计算结果正确 |
| 36 | 凡尔赛条约在我们的对话里提到过吗 | T36 | 5 | 0 | 692 | ✅ 正确判断未提及 |

**小计**: 2,775 tokens (平均 925/轮)

---

### Part 11: 🖼️ 多模态深度测试 (3轮)

> 📌 **切换回新会话**

| # | 消息 | 附件 | Turn | Token |
|---|------|------|------|-------|
| 37 | 这道几何题怎么解 | 📷 几何题.jpg | T26 | 762 |
| 38 | 能详细说说解题步骤吗 | - | T27 | 700 |
| 39 | 这道题考的是什么知识点 | - | T28 | 707 |

**小计**: 2,169 tokens (平均 723/轮)

---

### Part 12: 📚 多轮深度对话 (7轮) 🆕

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 40 | 现在教我微积分 | T29 | 5 | 0 | 787 |
| 41 | 什么是导数 | T30 | 5 | 0 | 1,108 |
| 42 | 导数的几何意义是什么 | T31 | 5 | 0 | 1,101 |
| 43 | f(x)=x²的导数是多少 | T32 | 5 | 0 | 847 |
| 44 | 那积分呢 | T33 | 5 | 0 | 1,101 |
| 45 | 定积分和不定积分有什么区别 | T34 | 5 | 0 | 1,218 |
| 46 | 微积分和牛顿定律有关系吗 | T35 | 5 | **1** | 1,111 |

**小计**: 7,273 tokens (平均 1,039/轮)

---

### Part 13: 🔁 最终回顾测试 (3轮)

| # | 消息 | Turn | 加载 | 检索 | Token |
|---|------|------|------|------|-------|
| 47 | 回到最开始，我们聊了什么 | T36 | 5 | **3** | 937 |
| 48 | 今天一共学了几个主题 | T37 | 5 | 0 | 667 |
| 49 | 帮我做一个完整的学习总结 | T38 | 5 | 0 | 971 |

**小计**: 2,575 tokens (平均 858/轮)

---

## 🔄 上下文管理验证

### 滑动窗口效果

| Turn | 加载历史 | 卸载历史 | 状态 |
|------|----------|----------|------|
| T1-T5 | 0→4 轮 | - | 窗口未满 |
| T6+ | 5 轮 | T1+ | ✅ 窗口生效 |
| T25 | 5 轮 | T1-T19 | ✅ 大量卸载 |
| T38 | 5 轮 | T1-T32 | ✅ 深度对话 |

### 智能检索效果

| 测试 | 引用类型 | 检索轮数 | 结果 |
|------|----------|----------|------|
| #14 | 时间引用 ("最开始") | 3 | ✅ 正确回忆惯性 |
| #15 | 索引引用 ("第一个") | 1 | ✅ 返回第1轮内容 |
| #16 | 关键词 ("牛顿定律") | 3 | ✅ 恢复物理上下文 |
| #24 | 关键词 ("化学") | 3 | ✅ 恢复化学上下文 |
| #27 | 历史回忆 | 3 | ✅ 跨时间恢复 |
| #28 | F=ma 引用 | 2 | ✅ 恢复物理知识 |
| #29 | 化学键引用 | 3 | ✅ 恢复化学知识 |
| #34 | 具体内容引用 | 3 | ✅ 精确回忆汽车例子 |
| #46 | 跨领域关联 | 1 | ✅ 关联微积分与牛顿 |
| #47 | 长程时间引用 | 3 | ✅ 回顾全部内容 |

---

## 🔄 跨时间会话恢复验证 🆕

### 历史会话信息

| 属性 | 值 |
|------|-----|
| Session ID | `session_1764323548` |
| 用户 | `pure_chat_test` |
| 创建时间 | 2025-11-28 09:52:28 |
| 历史轮次 | 25 轮 |
| 覆盖主题 | 牛顿定律、化学键、二战、美国历史文档 |

### 恢复测试结果

| 测试 | 目标 | 结果 |
|------|------|------|
| 会话恢复 | 能否继续历史会话 | ✅ Turn 从 26 继续 |
| 历史内容检索 | 能否回忆学习内容 | ✅ 检索到 3 轮 |
| 跨主题知识 | 能否恢复多主题 | ✅ 物理、化学、历史 |
| 文档内容 | 能否回忆文档 | ✅ 伊利运河内容正确 |
| 计算结果 | 能否回忆具体数值 | ✅ F=10N 正确 |

---

## 📈 Token 消耗分析

### 按场景分布

| Part | 场景 | 轮次 | Token | 平均 | 占比 |
|------|------|------|-------|------|------|
| 1 | 基础对话 | 5 | 3,583 | 716 | 8.0% |
| 2 | 深入学习 | 5 | 5,351 | 1,070 | 12.0% |
| 3 | 主题切换 | 3 | 3,091 | 1,030 | 6.9% |
| 4 | 智能检索 | 3 | 2,834 | 944 | 6.4% |
| 5 | 图片识别 | 2 | 1,341 | 670 | 3.0% |
| 6 | 文档理解 | 3 | 2,531 | 843 | 5.7% |
| 7 | 复杂引用 | 4 | 3,323 | 830 | 7.5% |
| 8 | **跨时间恢复** | 5 | 4,894 | 978 | 11.0% |
| 9 | 深度上下文 | 3 | 3,223 | 1,074 | 7.2% |
| 10 | 精确引用 | 3 | 2,775 | 925 | 6.2% |
| 11 | 多模态深度 | 3 | 2,169 | 723 | 4.9% |
| 12 | **多轮深度** | 7 | 7,273 | 1,039 | 16.3% |
| 13 | 最终回顾 | 3 | 2,575 | 858 | 5.8% |
| **总计** | | **49** | **44,526** | **908** | **100%** |

### Token 节省效果

```
无上下文管理: ~150,000 tokens (估算 49 轮累积)
当前策略:       44,526 tokens
节省:          ~70.3%
```

---

## ✅ 功能验证

| 功能 | 状态 | 验证点 |
|------|------|--------|
| **纯文本对话** | ✅ | T1-T10, T40-T46 |
| **上下文追问** | ✅ | T2-T5, T8-T9, T41-T45 |
| **主题切换** | ✅ | T11, T13, T40 |
| **图片识别** | ✅ | T17-T18, T37-T39 |
| **文档理解** | ✅ | T19-T21 |
| **多文档比较** | ✅ | T20 |
| **滑动窗口** | ✅ | T6+ 始终 5 轮 |
| **智能检索-时间** | ✅ | T14, T47 |
| **智能检索-索引** | ✅ | T15 |
| **智能检索-关键词** | ✅ | T16, T24, T28-29, T34 |
| **跨主题关联** | ✅ | T24, T46 |
| **Turn 计数** | ✅ | T1→T38 正确递增 |
| **🆕 跨时间会话恢复** | ✅ | T26-T36 (历史 session) |
| **🆕 历史知识检索** | ✅ | T27-T30 恢复多主题 |
| **🆕 深度多轮对话** | ✅ | 38+ 轮连续对话 |
| **🆕 精确内容引用** | ✅ | T34-T35 回忆具体内容 |

---

## 📁 测试资源

| 文件 | 用途 | GCS 路径 |
|------|------|----------|
| 伊利运河文档 | 美国历史 | `gs://kimi-dev/ap 美国历史sample.txt` |
| 二战外交文档 | 美国历史 | `gs://kimi-dev/ap 美国历史sample 2.txt` |
| 历史图片 | 图片识别 | `gs://kimi-dev/images.jpeg` |
| 几何题图片 | 数学题解 | `gs://kimi-dev/450ffcb787fb42d0b0aeda4135d57a9f.jpg` |

---

## 📊 响应格式

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "text": "回复内容...",
    "session_id": "session_001",
    "token_usage": {
      "llm_generation": {"input": 500, "output": 150, "total": 650},
      "total": {"total": 650}
    },
    "context_stats": {
      "session_turns": 38,
      "loaded_turns": 5,
      "retrieved_turns": 3,
      "total_context_chars": 2500
    },
    "generation_time": 1.86
  }
}
```

---

## 🎯 核心结论

1. **跨时间会话恢复**: ✅ 成功从历史 session 恢复，Turn 编号正确继续
2. **长期记忆**: ✅ MD 持久化支持跨主题知识检索
3. **深度对话**: ✅ 支持 38+ 轮连续对话
4. **智能检索**: ✅ 多种引用方式均可触发
5. **Token 效率**: ✅ 节省约 70% Token 消耗

---

## 🆕 压缩归档机制改进 (2025-12-01)

### 问题背景

之前的压缩机制会**删除**早期对话的详细内容，只保留摘要。这导致：
1. 用户引用早期具体内容时，系统只能看到摘要
2. 智能检索无法获取完整的原始对话

### 改进方案

现在压缩时会**归档**原始内容而非删除：

```
session_1764323548.md          # 主文件（摘要 + 最近10轮）
session_1764323548_archive_001.md  # 归档1（Turn 1-20 完整内容）
session_1764323548_archive_002.md  # 归档2（Turn 21-40 完整内容）
```

### 新文件格式

#### 主文件摘要区

```markdown
## 📚 历史摘要

> *以下是早期对话的压缩摘要。完整的原始对话已保存到归档文件中。*
> *智能检索功能可自动从归档中检索详细内容。*

**轮次 1-20**（共 20 轮）
- 📖 **学习主题**: 牛顿三大定律、化学键
- 🛠️ **使用技能**: text×20
- 💬 **关键问题**:
  - 你好，我想学习牛顿三大定律
  - 先讲讲第一定律吧
  - 什么是惯性
> 📦 **完整对话归档**: [session_xxx_archive_001.md](./session_xxx_archive_001.md)
```

#### 归档文件结构

```markdown
# 📦 对话归档 - session_xxx

**归档时间**: 2025-12-01T10:30:00  
**原 Session**: [session_xxx](./session_xxx.md)  
**轮次范围**: Turn 1 - 20（共 20 轮）  
**归档编号**: #1

---

> ⚠️ 此文件包含已压缩对话的完整原始记录。
> 主 Session 文件中保留了这些对话的摘要。
> 智能检索功能可自动从此归档中检索详细内容。

---

## Turn 1 | ... 完整对话记录 ...
```

### 智能检索增强

现在智能检索会自动搜索归档文件：

| 引用类型 | 示例 | 检索逻辑 |
|----------|------|----------|
| 时间引用 | "回到最开始" | 先查主文件，不够则查归档文件的最早对话 |
| 索引引用 | "第三轮的内容" | 如果索引超出主文件范围，自动从归档检索 |
| 关键词引用 | "F=ma那道题" | 主文件 + 归档文件联合搜索 |

### 技术细节

**触发条件**:
- Turn 数 ≥ 30 时触发首次压缩
- 之后每 20 轮压缩一次
- 每次压缩保留最近 10 轮完整对话

**Metadata 更新**:
```json
{
  "compressed_history": true,
  "compression_count": 2,
  "compressed_turns_total": 40,
  "archive_files": [
    {
      "filename": "session_xxx_archive_001.md",
      "turns_range": {"start": 1, "end": 20},
      "created_at": "2025-12-01T10:30:00"
    },
    {
      "filename": "session_xxx_archive_002.md", 
      "turns_range": {"start": 21, "end": 40},
      "created_at": "2025-12-01T11:00:00"
    }
  ]
}
```

### 优势

1. ✅ **数据不丢失** - 原始对话完整保留在归档文件
2. ✅ **主文件轻量** - 只保留摘要和最近对话，加载快
3. ✅ **智能检索** - 需要时自动从归档检索详细内容
4. ✅ **用户可访问** - 归档文件可直接查看完整历史

